<!DOCTYPE html> <html class=v2 dir=ltr xmlns=http://www.w3.org/1999/xhtml xmlns:b=http://www.google.com/2005/gml/b xmlns:data=http://www.google.com/2005/gml/data xmlns:expr=http://www.google.com/2005/gml/expr style><!--
 Page saved with SingleFile 
 url: https://blog.marcgravell.com/2018/07/pipe-dreams-part-2.html 
 saved date: Wed Nov 16 2022 14:27:22 GMT+0800 (中国标准时间)
--><meta charset=utf-8>
<style>:root{--sf-img-3: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAARMCAYAAACZG7OEAAABWklEQVR42u3cwQ0CQQwEQS/cl2jIPzCQ0BAEBnHrqgBW7hvxZSW5VaOjqlbng5dq1v6gZMmSJbtQsmTJkiWfK9kokiVLlizZKJIlS5Ys2YWSJUuWLHnXZKNIlixZsmSjSJYsWbJkF0qWLFmyZMnbJBtFsmTJko0iWbJkyZIlu1CyZMmSJe+abBTJkiVLlmwUyZIlS5bsQsmSJUsekmwUyZIlS5Ys2SiSJUuWLNmFkiVLlixZ8nmTjSJZsmTJRpEsWbJkyZJdKFmyZMn/mbyS3LsvzLxRJEuWLFmyZMmSJUs2imTJkiVLlixZsmTJU5ONIlmyZMmSJUuWLFnytGSjSJYsWbJkyZIlSx4+CgAAAAAAAAAAAAAAAAAAAAAAAADwYytJ6/8fHlX16n7wMe/Bp2TJfim+oWTfULJvKNk3/NaFK8m1AAAAAAAAAAAAAAAAAAAAAAAAAADgE2/S1Gnyf8/liwAAAABJRU5ErkJggg==");--sf-img-7: url("data:image/gif;base64,R0lGODlhDQAKALMPAP///6+vr/j4+OHh4fr6+uzs7Nvb2+3t7dzc3Ojo6N3d3e7u7ubm5vf39/b29v///yH5BAEAAA8ALAAAAAANAAoAQAQ68D1AK5AYi5OOyMQxBAFAGshwEARpmQGzEJJQjOhQfBLxUo4GTZBwUU6KxMc2OqV2GaZCx8v0BLRMBAA7");--sf-img-8: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAMAAABhq6zVAAAABGdBTUEAANbY1E9YMgAAAP9QTFRF2XIp3nIw4Xgx6IY16Yc1214q3WMr32ow4Gks4W40428u43I144BT5XMu5XY25noz53Yw6Hkw6Hs36X43634y64Ax64A564M57Ic+7Zpj7oUz7oY67oc67qZ974Y08Is78I1A8J1l8Yo08Yw88Y858ZVN8bGK8o888442848286Rm87aL9JI99JM99JxP9LyY9ZU79ZY+9pQ39ptE9qto95c495k/97J1+Jg4+LmB+MSa+MWa+atd+bFq+cea+ps5+rd2+rh2+r2D+uXY+506+6NG+65e+69f+7p3+7+D/MCD/erZ/e/l/fDm/fHm/ufO/vLm/vPm/vjy//nz////B9JuTQAAAAV0Uk5TMO/v7++mu2gOAAAAj0lEQVQIHQXBUQuCMBAA4N3ddjO11B5C+jVC//+t94iCCCQa6tJ5bn0fKGy0oYx1ugpiwRAJja06ggovanGTscb9qAYvtt4jumGhBtswxMK6r1818VnJPJbHp0fM7G2CcnlyIYK8y2GUw2tug6DmU769mR5N3NBYiX2vzEdpAd25wXsJMSaheM+2NSWlIKQ/2xpDTzPOPTwAAAAASUVORK5CYII=")}body{margin:0}.content-outer,.header-outer,.tabs-outer,.main-outer,.main-inner,.footer-outer,.post,.comments,.widget,.date-header{position:relative;min-height:0}.footer-outer{margin-bottom:-1px}.tabs-inner{padding:0 15px}.main-inner{padding:30px 0}.main-inner .column-left-inner,.main-inner .column-right-inner{padding:0 15px}.footer-inner{padding:30px 15px}.section{margin:0 15px}.widget{margin:30px 0}.section:first-child .widget:first-child{margin-top:0}.section:last-child .widget:last-child{margin-bottom:0}body .navbar{height:30px;padding:0;margin:0}body .navbar .Navbar{position:absolute;z-index:10;left:0;width:100%;margin:0;padding:0;background:none;border:none}.header-inner .section{margin:0}.header-inner .widget{margin-left:30px;margin-right:30px}.header-inner .Header{margin:0}.header-inner .Header #header-inner{overflow:hidden}.header-inner .Header .descriptionwrapper{margin-bottom:25px}.Header h1{margin-bottom:10px}.Header .description{margin:.5em 0 10px;padding:0 2px}a img{position:relative}h1,h2,h3{margin:0;position:relative}h1 a:hover{text-decoration:none}.widget{line-height:1.4}.widget ul{padding:0 0 0 1.25em;margin:0;line-height:1.2}.widget li{padding:.25em 0;margin:0;text-indent:0}.widget .post-body ul{padding:0 2.5em;margin:.5em 0;line-height:1.4}.widget .post-body li{margin-bottom:.25em;padding-top:0;padding-bottom:0}.post-body{width:100%}.post-footer-line>*{margin-right:1em}.post-footer-line>*:last-child{margin-right:0}.post-timestamp{margin-left:-1em}.post-footer-line>*:first-child{margin-left:0}.Profile img{margin:0 .75em .5em 0}.Profile .profile-datablock{margin:0 0 .5em}dt{font-weight:bold}table.section-columns td.first.columns-cell{border-left:none}html{height:100%}body{min-height:100%;position:relative}.content{position:relative;word-wrap:break-word}.content-outer,.region-inner{min-height:0;margin:0 auto}.columns{zoom:1}.columns-inner{min-height:0}.column-center-outer,.column-left-outer,.column-right-outer{position:relative;float:left}.column-center-outer{width:100%}.fauxcolumns{position:relative}.fauxcolumn-outer{position:absolute;top:0;bottom:0;overflow:hidden}.fauxcolumn-outer .fauxborder-left,.fauxcolumn-outer .fauxborder-right,.fauxcolumn-inner{height:100%}.fauxcolumn-left-outer{left:0}.fauxcolumn-right-outer{right:0}.cap-top,.cap-bottom{position:relative;height:0;background-repeat:repeat-x}.cap-top .cap-left,.cap-top .cap-right,.cap-bottom .cap-left,.cap-bottom .cap-right{height:100%;background-repeat:no-repeat}.cap-top,.cap-top .cap-left{background-position:top left}.cap-bottom,.cap-bottom .cap-left{background-position:bottom left}.cap-top .cap-left,.cap-bottom .cap-left{float:left}.cap-top .cap-right{background-position:top right;float:right}.cap-bottom .cap-right{background-position:bottom right;float:right}.fauxborder-left{background-position:top left;background-repeat:repeat-y;position:relative}.fauxborder-right{background-position:top right;background-repeat:repeat-y;position:absolute;right:0;height:100%}table.section-columns{border:none;table-layout:fixed;width:100%;position:relative}table.columns-2 td.columns-cell{width:50%}table.section-columns td.columns-cell{vertical-align:top}.body-fauxcolumns,.content-fauxcolumns{position:absolute;top:0;left:0;z-index:-1;height:100%;width:100%;overflow:hidden}.body-fauxcolumns .fauxcolumn-outer{width:100%}.content-fauxcolumns .fauxcolumn-outer{position:relative;overflow:visible;height:100%;margin:0 auto}aside,header,footer{display:block}div.clear{clear:both}#navbar-iframe{display:block;height:30px}.profile-img{float:left}.profile-data{margin:0}.profile-name-link{background:no-repeat left top;box-sizing:border-box;display:inline-block;max-width:100%;min-height:20px;padding-left:20px}body{overflow-wrap:break-word;word-break:break-word;word-wrap:break-word}.widget.Subscribe{position:static}.widget.Subscribe .widget-content{zoom:1}.subscribe{color:#999}.subscribe-wrapper{margin:.5em;padding:0;position:relative;zoom:1}div.subscribe{cursor:pointer;margin:0;padding:0;text-align:left;width:144px}div.subscribe div.top{font-size:1em;padding:4px 0 1px;width:144px}html>body div.subscribe div.top{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJAAAAGQBAMAAACzH/Q/AAAAMFBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkJCTg4ODh4eH7+/v8/Pz///8hEP7MAAAAD3RSTlMABBQiIyYnKCkqK5aZ6O1Hd1dgAAAAv0lEQVR42u3TwRGCMBRF0fArCOxYilZgCfZAYWzpAKuzA+3A1Vs4eG4BZyYvSQ3XNdC917w/Ax1bTY8W6HappUVaasxAY7VQIBAIBAKBQCAQCAQCgUCgBNQzzpCDfu9oJ741XwQE+gq9Ms7b2P89tndkbBAIBAKBQCAQCAQCgUAgEAgEAoFAIBAIBAKBQCAQCAQCgUAgEAgEAoFAIBAIBAKBQCAQCAQCgUAgEAgEAoFAIBAIBAKBQCAQCAQ6N/QBxmRSL1QjElcAAAAASUVORK5CYII=)top left no-repeat}span.inner{padding:0}div.subscribe div.top span.inner{margin:0 5px}.feed-icon{vertical-align:baseline;display:inline}div.subscribe div.bottom{font-size:3px;height:3px;line-height:0}.subscribe-wrapper .expanded{position:absolute;top:0;z-index:20}html>body div.subscribe div.bottom{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJAAAAADBAMAAACOmptmAAAALVBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAAkJCTh4eHj4+Pk5OT7+/v8/Pz9/f3///+jj1vZAAAADHRSTlMABAUUFSImK5mbnuu6xDmCAAAAIklEQVQIHWOweHuGcnD23hQG8dXvqAB2FTEwuaZRAYQoAAA1TZXCCL/A+AAAAABJRU5ErkJggg==)bottom left no-repeat;margin-bottom:0;padding-bottom:0;width:144px}.subscribe-dropdown-arrow{float:right;margin-right:6px;margin-top:4px}#ArchiveList .toggle{cursor:pointer;font-family:Arial,sans-serif}#ArchiveList .toggle-open{line-height:.6em}#ArchiveList{text-align:left}#ArchiveList a.post-count-link,#ArchiveList a.post-count-link:link,#ArchiveList a.post-count-link:visited{text-decoration:none}#ArchiveList a.toggle,#ArchiveList a.toggle:link,#ArchiveList a.toggle:visited,#ArchiveList a.toggle:hover{color:inherit;text-decoration:none}.BlogArchive #ArchiveList ul li{background:none;list-style:none;list-style-image:none;list-style-position:outside;border-width:0;padding-left:15px;text-indent:-15px;margin:.25em 0;background-image:none}.BlogArchive #ArchiveList ul ul li{padding-left:1.2em}.BlogArchive #ArchiveList ul{margin:0;padding:0;list-style:none;list-style-image:none;border-width:0}.BlogArchive #ArchiveList ul.posts li{padding-left:1.3em}.post-footer abbr{border:none}#blog-pager-newer-link{float:left}#blog-pager-older-link{float:right}#blog-pager{margin:1em 0;text-align:center;overflow:hidden}.comments{clear:both;margin-top:10px;margin-bottom:0}</style>
<meta content="width=1100" name=viewport>
<meta content=blogger name=generator>
<link href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-2.html rel=canonical>
<link rel=alternate type=application/atom+xml title="Code, code and more code. - Atom" href=https://blog.marcgravell.com/feeds/posts/default>
<link rel=alternate type=application/rss+xml title="Code, code and more code. - RSS" href="https://blog.marcgravell.com/feeds/posts/default?alt=rss">
<link rel=service.post type=application/atom+xml title="Code, code and more code. - Atom" href=https://www.blogger.com/feeds/8184237816669520763/posts/default>
<link rel=alternate type=application/atom+xml title="Code, code and more code. - Atom" href=https://blog.marcgravell.com/feeds/5187891784616191510/comments/default>
<meta content=https://blog.marcgravell.com/2018/07/pipe-dreams-part-2.html property=og:url>
<meta content="Pipe Dreams, part 2" property=og:title>
<meta content="Pipelines - a guided tour of the new IO API in .NET, part 2  In part 1 , we discussed some of the problems that exist in the familiar Stream..." property=og:description>
<title>Code, code and more code.: Pipe Dreams, part 2</title>
<style id=template-skin-1><!--body{font:normal normal 12px Arial,Tahoma,Helvetica,FreeSans,sans-serif;color:#222222;background:#eeaa00 none repeat scroll top left;padding:0 40px 40px 40px}html body .region-inner{min-width:0;max-width:100%;width:auto}h2{font-size:22px}a:link{text-decoration:none;color:#cc6611}a:visited{text-decoration:none;color:#888888}a:hover{text-decoration:underline;color:#ff9900}.body-fauxcolumn-outer .fauxcolumn-inner{background:transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKAQMAAAC3/F3+AAAAA1BMVEX///+nxBvIAAAAAXRSTlOZyTXzhgAAAApJREFUCB1jwAsAAB4AAfeYTFwAAAAASUVORK5CYII=)repeat scroll top left}.body-fauxcolumn-outer .cap-top{position:absolute;z-index:1;height:400px;width:100%}.body-fauxcolumn-outer .cap-top .cap-left{width:100%;background:transparent var(--sf-img-3) repeat-x scroll top left}.content-outer{-moz-box-shadow:0 0 40px rgba(0,0,0,.15);-webkit-box-shadow:0 0 5px rgba(0,0,0,.15);-goog-ms-box-shadow:0 0 10px #333333;box-shadow:0 0 40px rgba(0,0,0,.15);margin-bottom:1px}.content-inner{padding:10px 10px}.content-inner{background-color:#ffffff}.header-outer{background:#cc6611 var(--sf-img-3) repeat-x scroll 0-400px}.Header h1{font:normal normal 60px Arial,Tahoma,Helvetica,FreeSans,sans-serif;color:#ffffff;text-shadow:1px 2px 3px rgba(0,0,0,.2)}.Header h1 a{color:#ffffff}.Header .description{font-size:140%;color:#ffffff}.header-inner .Header .titlewrapper{padding:22px 30px}.header-inner .Header .descriptionwrapper{padding:0 30px}.tabs-inner .section:first-child{border-top:0 solid #eeeeee}.main-outer{border-top:0 solid #eeeeee}.fauxcolumn-left-outer .fauxcolumn-inner{border-right:1px solid #eeeeee}.fauxcolumn-right-outer .fauxcolumn-inner{border-left:1px solid #eeeeee}div.widget>h2,div.widget h2.title{margin:0 0 1em 0;font:normal bold 11px Arial,Tahoma,Helvetica,FreeSans,sans-serif;color:#000000}.widget .zippy{color:#999999;text-shadow:2px 2px 1px rgba(0,0,0,.1)}h2.date-header{font:normal bold 11px Arial,Tahoma,Helvetica,FreeSans,sans-serif}.date-header span{background-color:transparent;color:#222222;padding:inherit;letter-spacing:inherit;margin:inherit}.main-inner{padding-top:30px;padding-bottom:30px}.main-inner .column-center-inner{padding:0 15px}.main-inner .column-center-inner .section{margin:0 15px}.post{margin:0 0 25px 0}h3.post-title{font:normal normal 22px Arial,Tahoma,Helvetica,FreeSans,sans-serif;margin:.75em 0 0}.post-body{font-size:110%;line-height:1.4;position:relative}.Profile img,.Image img{padding:2px;background:#ffffff;border:1px solid #eeeeee;-moz-box-shadow:1px 1px 5px rgba(0,0,0,.1);-webkit-box-shadow:1px 1px 5px rgba(0,0,0,.1);box-shadow:1px 1px 5px rgba(0,0,0,.1)}.post-header{margin:0 0 1.5em;line-height:1.6;font-size:90%}.post-footer{margin:20px -2px 0;padding:5px 10px;color:#666666;background-color:#f9f9f9;border-bottom:1px solid #eeeeee;line-height:1.6;font-size:90%}.section-columns td.columns-cell{border-left:1px solid #eeeeee}.blog-pager{background:transparent none no-repeat scroll top center}.blog-pager-older-link,.home-link,.blog-pager-newer-link{background-color:#ffffff;padding:5px}.footer-outer{border-top:0 dashed #bbbbbb}--><!--body{min-width:960px}.content-outer,.content-fauxcolumn-outer{min-width:960px;max-width:960px}.main-inner .columns{padding-left:0;padding-right:310px}.main-inner .fauxcolumn-center-outer{left:0;right:310px}.main-inner .fauxcolumn-left-outer{width:0}.main-inner .fauxcolumn-right-outer{width:310px}.main-inner .column-left-outer{width:0;right:100%;margin-left:-0}.main-inner .column-right-outer{width:310px;margin-right:-310px}--></style>
<noscript><link href="https://www.blogger.com/dyn-css/authorization.css?targetBlogID=8184237816669520763&amp;zx=d59b377b-a436-4b46-a15c-73fe7f07228c" rel="stylesheet"></noscript>
<meta name=google-adsense-platform-account content=ca-host-pub-1556223355139109>
<meta name=google-adsense-platform-domain content=blogspot.com>
<meta content=8184237816669520763 itemprop=blogId class=sf-hidden><meta content=5187891784616191510 itemprop=postId class=sf-hidden><meta content=https://www.blogger.com/profile/01023334706549710089 itemprop=url class=sf-hidden><meta content=https://blog.marcgravell.com/2018/07/pipe-dreams-part-2.html itemprop=url class=sf-hidden><link href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAQAQAAAAAAAAAAAAAAAAAAAAAAACAP2b/hUhw/2smSv9rQl3/aEhg/2A5S/9SJTP/Tx8s/0kbKP9HFyL/RRQf/0gZM/9IHj7/SRs1/0oaMf9IGC//eDFL/4lPdf9vOVn/dlp4/2hHXv9hM0T/XSo6/1YpN/9RKjT/Uigy/1IqOP9MIDH/Uxsz/1MZMv9UHTv/VRxC/3ksO/+FRmj/e1pu/3dfd/9sPU7/ZDdG/2A3RP9mNET/Zj1T/2Q7Vv9fOVP/VTBC/2czYf9sR2b/YU1e/2KPqP+BNUL/eipB/491i/+DcIP/c0dc/3JJWv9ySFz/aTxM/2ZCUv9kOlH/ZDdQ/2JSX/+b0tf/jbXA/3Fxb/9tm7D/qJ6e/5V+fv+dlZf/kImZ/3dSZf92Umj/cUte/3BLXf9uR1n/bEBa/1gpOf9XIDT/re7u/7b8+/+jr67/baG4/73MyP+0ycP/k4Cg/4Rnhf95V27/dlFn/3dRaP97VGv/dE9n/25IY/9nQ1r/VxQt/7Lp6f/k////oK2q/7v09v/K2dP/p6a2/4hci/+BZoH/fF1z/4NjeP+CYHn/glhv/3NNZ/9uQ17/bUFj/2xDYf9cQ1r/+////6e2tP/T5+j/ztPO/5hqmP+QW4f/hmuC/4VlgP+EboX/hWh7/3pebP9rQ1D/Yz5N/2hCVv9rSGT/mqKq//////+bl5P/anh2/8e6uP+WZpD/l2qL/3tHTf92QUX/dUBF/20zMv9vOjX/fEk+/2ExOv9mQkn/ZURO/4qfl///////nZyZ/4OYk//5+ff/5e3p/5d+gv99TVX/gVxn/4Vmd/98VF7/cklN/3FKTv9hMDX/aj5H/2BLS/+10sr//////5yfmP+Op6H/+Pn5/+Dm4/+QbXH/hVdk/4BaZf+JcYX/g3CD/31oeP9vSVH/Zzk+/2M6R/9iU1f/8P/8//////+LlI7/kLOs/+3y8f/a4N//jWZs/4RaZP+CX2v/fFli/4Nvgf96bID/dWd8/3Vkd/9oSV//rK+x///////+/v//6e7r/9bm5P/w9vT/3uzo/5F4ef+DVWP/e1pl/3lgbf98bIL/fW2D/3dmfP9yWXH/XENX/9vh4P///////v39///////r+Pf/8ff2/+Dq6P++wr//e1FZ/3hNW/95YHD/e2+E/3xtiP93bYX/a1ty/5ajpf///////v39//79/f/+/v7/4/bz/+709P/c5uP/zt/a/7TIwf+IeXr/c0lW/21ATf9rRFT/YkJT/3lrcP/y+Pb///////7+/v/+/v7//v7+/+b08//o8e//1OLf/8jZ1f+70c//rs7K/5y/uv+Qn5v/qKqp/9HV1f/+//////////7+/v/+/v7//v7+//7+/v/3+vr/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" rel=icon type=image/x-icon><style>.sf-hidden{display:none!important}</style><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body class=variant-bold>
<div class="navbar section" id=navbar><div class="widget Navbar" data-version=1 id=Navbar1>
<div id=navbar-iframe-container><iframe ng-non-bindable frameborder=0 hspace=0 marginheight=0 marginwidth=0 scrolling=no tabindex=0 vspace=0 width=100% id=navbar-iframe name=navbar-iframe sandbox="allow-popups allow-top-navigation allow-top-navigation-by-user-activation" srcdoc="<!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01//EN&quot; &quot;http://www.w3.org/TR/html4/strict.dtd&quot;> <html dir=ltr><meta charset=utf-8><style>:root{--sf-img-1: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAAECAYAAABsgwTvAAAAPElEQVR42nXMsQ0AIAwDQe/kWbL/BqwQSIFALznSF3FxqlqdOidmu1ODJRAQQDT7xUSIGCNETA8ilsH/3xfYtbHJD+xUAAAAAElFTkSuQmCC&quot;);--sf-img-0: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC4AAAAUCAMAAADFhv/OAAABiVBMVEUAAAD/q3L/q3L/q3L/q3L/q3JmZmZoaGhubm5wcHBycnJ0dHR4eHh6enqCgoKEhISGhoaIiIiKioqOjo6QkJCSkpKYmJiampqenp6lpaWmpqapqamqqqqrq6usrKytra2urq6vr6+zs7O0tLS1tbW2tra3t7e5ubm6urq7u7u+vr6/v7/BwcHDw8PHx8fJycnLy8vQ0NDR0dHT09PU1NTV1dXW1tbY2Njb29vc3Nzd3d3f39/g4ODh4eHi4uLj4+Pl5eXm5ubn5+fp6ent7e3u7u7v7+/x8fHz8/P19fX29vb39/f5+fn6+vr7+/v8/Pz9/f3/q3L/rnf/sHr/sXv/tIH/tYP/toT/toX/uIf/vI//wpn/w5r/xJv/xJ3/xZ3/xZ7/xp//x6D/yaT/0rT/07X/1bn/2L3/2b//2cD/28L/3cb/38r/5NH/5NL/5tX/6Nj/7+T/8OX/8ej/9Oz/9O3/9e7/9vD/9vH/9/L/+PT/+vb/+/j/+/n//Pv//fv//fz//v3///9gKGHcAAAABnRSTlMADHh53+GPUDoCAAABq0lEQVQYGXXBCVcSYRQG4Jftw4Bqsig/GpBq0qZstE0JRW0ZSgbFW9m+b7ZamZCWmt1f3p3J5hwPzvMAs2NWsVQeduHjESOTzfV7ELFEinZIJWKYO1cwrYFj2q4DYDu9x+jdq/JNAHHqEsdY4URtDq6jT3vASHp/leGZ6jADSeqShHW0BtE4pa8ARk8Vgg+pqwDtAkWrBd+ongAyBsPnqApAvoVP3zfWV94/pH9QGkDgsp4Esr0IXFDjAImFXxzYekABlMsuRMvRk0Au50GwqcYBEh+ZN9rtTeYlCmBYOzNAq1o8fgPoVyYDfCmzbx4gscx8n+gF808KwLW1PVpxSoXBOuDlVd45b2bTB5sAiTXmL4uLX5n5zWsSQP2MFkWt7RmgeUSJjFJ5BolVDv0hAcCbnqhNXRvS2roJ8HSlWrvep5TBJH5waJME/msO6ZMNbOM+dYBJdJif3xWPfvM6CYQaF12E+KwHEt+Y3z57+uTxqy1eJYFoJN5xaIkEopG4vcLb1u6RQDTy3fmw3Ol02p9f3iIfotEuEC1JXZKIFqcucUSLJVK0QyoR+wtEprA0cDOepAAAAABJRU5ErkJggg==&quot;)}body{padding:0;margin:0}#b-navbar{white-space:nowrap;color:#444;height:29px;border-bottom:1px solid #888;background:transparent;font-size:13px;font-family:Arial,Sans-serif;position:relative}#b-navbar #b-navbar-bg{position:absolute;left:0;top:0;width:100%;height:30px;background-color:#fff;opacity:.4}#b-navbar .navbar-right{text-align:right;padding-right:5px}#b-navbar-controls{margin-left:.2em;height:29px}#b-navbar #b-navbar-logo{display:block;margin-right:8px;margin-left:8px;width:20px;height:20px;background:var(--sf-img-0) no-repeat -26px 0;cursor:pointer}#b-navbar #b-query-box{background-color:#fff;margin:0 .5em 0 0;border:1px solid #aaa;border-radius:3px;-moz-border-radius:3px;-webkit-border-radius:3px;padding:0 .3em}#b-navbar #b-query-icon{display:block;width:13px;height:13px;cursor:pointer;background:var(--sf-img-0) no-repeat 0 0}#b-navbar #b-query-icon:hover{background:var(--sf-img-0) no-repeat -13px 0}#b-navbar #b-query{font-size:13px;color:#000;background-color:transparent;border:none;margin:0}#b-navbar .b-link{display:inline-block;font-size:13px;vertical-align:middle;padding:2px .4em}#b-navbar .b-link{color:#333;text-decoration:none;white-space:nowrap;cursor:pointer}#b-navbar .b-link:hover{color:#55e;text-decoration:underline}#b-navbar #b-more span.arrow{background:var(--sf-img-1) no-repeat -12px;display:inline-block;width:7px;height:10px}#b-navbar #b-more:hover span.arrow{background:var(--sf-img-1) no-repeat 0}.sf-hidden{display:none!important}</style><meta http-equiv=content-security-policy content=&quot;default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:;&quot;><style>img[src=&quot;data:,&quot;],source[src=&quot;data:,&quot;]{display:none!important}</style></head>
<body class=&quot;lang_zh rb&quot; marginwidth=0 marginheight=0>
<div id=b-navbar><div id=b-navbar-bg style=z-index:-1></div>
<div id=b-navbar-fg>
<table id=b-navbar-controls cellpadding=0 cellspacing=0 border=0 width=100%><tbody><tr style=height:20px><td valign=middle width=24px><a href=https://www.blogger.com/ id=b-navbar-logo tabindex=1 title=&quot;转到 Blogger.com&quot;></a>
<div id=b-sms class=&quot;b-mobile sf-hidden&quot;></div></td>
<td valign=middle width=150px><form id=searchthis action=https://blog.marcgravell.com/search style=display:inline><div id=b-query-box><table cellpadding=0 cellspacing=0><tbody><tr><td valign=middle><input type=text id=b-query name=q tabindex=3 style=width:120px title=搜索 value></td>
<td valign=middle style=width:15px><a id=b-query-icon title=搜索此博客></a></table></div>
</form></td>
<td valign=middle nowrap class=gplus><a id=b-more class=b-link tabindex=4>更多
<span class=arrow></span></a></td>
<td class=navbar-right align=right nowrap valign=middle>
<a class=b-link href=https://www.blogger.com/home#create id=b-getorpost tabindex=8>创建博客</a>
<a class=b-link href=https://www.blogger.com/ tabindex=9>登录</a></table></div></div>
"></iframe></div>
</div></div>
<div class=body-fauxcolumns>
<div class="fauxcolumn-outer body-fauxcolumn-outer">
<div class=cap-top>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class=fauxborder-left>
<div class=fauxborder-right></div>
<div class=fauxcolumn-inner>
</div>
</div>
<div class=cap-bottom>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
</div>
<div class=content>
<div class=content-fauxcolumns>
<div class="fauxcolumn-outer content-fauxcolumn-outer">
<div class=cap-top>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class=fauxborder-left>
<div class=fauxborder-right></div>
<div class=fauxcolumn-inner>
</div>
</div>
<div class=cap-bottom>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
</div>
<div class=content-outer>
<div class="content-cap-top cap-top">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class="fauxborder-left content-fauxborder-left">
<div class="fauxborder-right content-fauxborder-right"></div>
<div class=content-inner>
<header>
<div class=header-outer>
<div class="header-cap-top cap-top">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class="fauxborder-left header-fauxborder-left">
<div class="fauxborder-right header-fauxborder-right"></div>
<div class="region-inner header-inner">
<div class="header section" id=header><div class="widget Header" data-version=1 id=Header1>
<div id=header-inner>
<div class=titlewrapper>
<h1 class=title>
<a href=https://blog.marcgravell.com/>
Code, code and more code.
</a>
</h1>
</div>
<div class=descriptionwrapper>
<p class=description><span>
</span></p>
</div>
</div>
</div></div>
</div>
</div>
<div class="header-cap-bottom cap-bottom">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
</header>
<div class=tabs-outer>
<div class="tabs-cap-top cap-top">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class="fauxborder-left tabs-fauxborder-left">
<div class="fauxborder-right tabs-fauxborder-right"></div>
<div class="region-inner tabs-inner">
<div class="tabs no-items section" id=crosscol></div>
<div class="tabs no-items section" id=crosscol-overflow></div>
</div>
</div>
<div class="tabs-cap-bottom cap-bottom">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
<div class=main-outer>
<div class="main-cap-top cap-top">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class="fauxborder-left main-fauxborder-left">
<div class="fauxborder-right main-fauxborder-right"></div>
<div class="region-inner main-inner">
<div class="columns fauxcolumns">
<div class="fauxcolumn-outer fauxcolumn-center-outer">
<div class=cap-top>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class=fauxborder-left>
<div class=fauxborder-right></div>
<div class=fauxcolumn-inner>
</div>
</div>
<div class=cap-bottom>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
<div class="fauxcolumn-outer fauxcolumn-left-outer">
<div class=cap-top>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class=fauxborder-left>
<div class=fauxborder-right></div>
<div class=fauxcolumn-inner>
</div>
</div>
<div class=cap-bottom>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
<div class="fauxcolumn-outer fauxcolumn-right-outer">
<div class=cap-top>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class=fauxborder-left>
<div class=fauxborder-right></div>
<div class=fauxcolumn-inner>
</div>
</div>
<div class=cap-bottom>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
<div class=columns-inner>
<div class=column-center-outer>
<div class=column-center-inner>
<div class="main section" id=main><div class="widget Blog" data-version=1 id=Blog1>
<div class="blog-posts hfeed">
 <div class=date-outer>
 
<h2 class=date-header><span>Tuesday, 3 July 2018</span></h2>
 <div class=date-posts>
 
<div class=post-outer>
<div class="post hentry" itemprop=blogPost itemscope itemtype=http://schema.org/BlogPosting>
<a name=5187891784616191510></a>
<h3 class="post-title entry-title" itemprop=name>
Pipe Dreams, part 2
</h3>
<div class=post-header>
<div class=post-header-line-1></div>
</div>
<div class="post-body entry-content" id=post-body-5187891784616191510 itemprop="description articleBody">
<h1><a href=#pipelines---a-guided-tour-of-the-new-io-api-in-net-part-2 aria-hidden=true class=anchor id=user-content-pipelines---a-guided-tour-of-the-new-io-api-in-net-part-2></a>Pipelines - a guided tour of the new IO API in .NET, part 2</h1>
<p>In <a href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-1.html rel=nofollow>part 1</a>, we discussed some of the problems that exist in the familiar <code>Stream</code> API, and we had an introduction to the <code>Pipe</code>, <code>PipeWriter</code> and <code>PipeReader</code> APIs, looking at how to write to a single <code>Pipe</code> and then consume the data from that <code>Pipe</code>; we also discussed how <code>FlushAsync()</code> and <code>ReadAsync()</code> work together to keep both sides of the machinery working, dealing with "empty" and "full" scenarios - suspending the reader when there is nothing to do, and resuming it when data arrives; and suspending the writer when it is out-pacing the reader (over-filling the pipe), and resuming when the reader has caught up; and we discussed what it <em>means</em> to "resume" here, in terms of the threading model.</p>
<p>In this part, we're going to discuss the <em>memory model</em> of pipelines: where does the data actually <em>live?</em>. We'll also start looking at how we can use pipelines in realistic scenarios to fulfil real needs.</p>
<h2><a href=#the-memory-model-where-are-all-my-datas aria-hidden=true class=anchor id=user-content-the-memory-model-where-are-all-my-datas></a>The memory model: where are all my datas?</h2>
<p>In part 1, we spoke about how the pipe owns all the buffers, allowing the writer to request a buffer via <code>GetMemory()</code> and <code>GetSpan()</code>, with the committed data later being exposed to the reader via the <code>.Buffer</code> on <code>ReadAsync()</code> - which is a <code>ReadOnlySequence&lt;byte&gt;</code>, i.e some number of <em>segments</em> of data.</p>
<p>So what <em>actually happens</em>?</p>
<p>Each <code>Pipe</code> instance has a reference to a <code>MemoryPool&lt;byte&gt;</code> - a new device in <a href=https://www.nuget.org/packages/System.Memory/ rel=nofollow><code>System.Memory</code></a> for, unsurprisingly, creating a memory pool. You can specify a specific <code>MemoryPool&lt;byte&gt;</code> in the options when creating a <code>Pipe</code>, but by default (and, I imagine, almost always) - a shared application-wide pool (<code>MemoryPool&lt;byte&gt;.Shared</code>) is used.</p>
<p>The <code>MemoryPool&lt;byte&gt;</code> concept is very open-ended. The <em>default</em> implementation simply makes use of <code>ArrayPool&lt;byte&gt;.Shared</code> (the application wide array-pool), renting arrays as needed, and returning them when done. This <code>ArrayPool&lt;T&gt;</code> is implemented using <code>WeakReference</code>, so pooled arrays are collectible if memory pressure demands it. However, when you ask <code>GetMemory(someSize)</code> or <code>GetSpan(someSize)</code>, it doesn't simply ask the memory pool for <em>that amount</em>; instead, it tracks a "segment" internally. A new "segment" will be (by default, configurable) the larger of <code>someSize</code> or 2048 bytes. Requesting a non-trivial amount of memory means that we aren't filling the system with tiny arrays, which would significantly impact garbage collection. When you <code>Advance(bytesWritten)</code> in the writer, it:</p>
<ul>
<li>moves an internal counter that is how much of the current segment has been used</li>
<li>updates the end of the "available to be read" chain for the reader; if we've just written the first bytes of an empty segment, this will mean adding a new segment to the chain, otherwise it'll mean increasing the end marker of the final segment of the existing chain</li>
</ul>
<p>It is this "available to be read" chain that we fetch in <code>ReadAsync()</code>; and as we <code>AdvanceTo</code> in the reader - when entire segments are consumed, the pipe hands those segments back to the memory pool. From there, they can be reused many times. And as a direct consequence of the two points above, we can see that <em>most of the time</em>, even with multiple calls to <code>Advance</code> in the writer, we may end up with a single segment in the reader, with multiple segments happening either at segment boundaries, or where the reader is falling behind the writer, and data is starting to accumulate.</p>
<p>What this achieves <em>just using the default pool</em> is:</p>
<ul>
<li>we don't need to keep allocating every time we call <code>GetMemory()</code> / <code>GetSpan()</code></li>
<li>we don't need a separate array per <code>GetMemory()</code> / <code>GetSpan()</code> - we'll often just get a different range of the same "segment"</li>
<li>a relatively small number of non-trivial buffer arrays are used</li>
<li>they are automatically recycled without needing lots of library code</li>
<li>when not being used, they are available for garbage collection</li>
</ul>
<p>This also explains why the approach of requesting a very small amount in <code>GetMemory()</code> / <code>GetSpan()</code> and then checking the size can be so successful: we have access to the <em>rest of the unused part of the current segment</em>. Meaning: with a segment size of 2048, of which 200 bytes were already used by previous writes - even if we only ask for 5 bytes, we'll probably find we have 1848 bytes available to play with. Or possibly more - remember that obtaining an array from <code>ArrayPool&lt;T&gt;.Shared</code> is <em>also</em> an "at least this big" operation.</p>
<h2><a href=#zero-copy-buffers aria-hidden=true class=anchor id=user-content-zero-copy-buffers></a>Zero copy buffers</h2>
<p>Something else to notice in this setup is that we get data buffering without <em>any</em> data copying. The writer asked for a buffer, and wrote the data to <em>where it needed to be</em> the first time, on the way in. This then acted as a buffer between the writer and the reader without any need to copy data around. And if the reader couldn't process all the data yet, it was able to push data back into the pipe simply by saying explicitly what it <em>did</em> consume. There was no need to maintain a separate backlog of data for the reader, something that is <em>very</em> common in protocol processing code using <code>Stream</code>.</p>
<p>It is this combination of features that makes the <em>memory</em> aspect of pipeline code so friendly. You could <em>do</em> all of this with <code>Stream</code>, but it is an excruciating amount of error-prone code to do it, and even more if you want to do it <em>well</em> - and you'd pretty much have to implement it separately for each scenario. Pipelines makes good memory handling the default simple path - <a href=https://blog.codinghorror.com/falling-into-the-pit-of-success/ rel=nofollow>the pit of success</a>.</p>
<h2><a href=#more-exotic-memory-pools aria-hidden=true class=anchor id=user-content-more-exotic-memory-pools></a>More exotic memory pools</h2>
<p>You aren't limited to the memory model discussed; you can implement your own custom memory pool! The advantage of the default pool is that it is simple. In particular, it <em>doesn't really matter</em> if we aren't 100% perfect about returning every segment - if we somehow drop a pipe on the floor, the worst that can happen is that the garbage collector collects the abandoned segments at some point. They won't go back into the pool, but that's fine.</p>
<p>You <em>can</em>, however, do much more interesting things. Imagine, for example, a <code>MemoryPool&lt;byte&gt;</code> that takes huge <em>slabs</em> of memory - either managed memory via a number of very large arrays, or unmanaged memory via <code>Marshal.AllocHGlobal</code> (note that <code>Memory&lt;T&gt;</code> and <code>Span&lt;T&gt;</code> <em>are not limited to arrays</em> - all they require is some kind of contiguous memory), leasing blocks of this larger chunk as required. This has great potential, but it becomes increasingly important to ensure that segments are reliably returned. Most systems shouldn't need this, but it is good that the flexibility is offered.</p>
<h1><a href=#useful-pipes-in-real-systems aria-hidden=true class=anchor id=user-content-useful-pipes-in-real-systems></a>Useful pipes in real systems</h1>
<p>The example that we used in part 1 was of a single <code>Pipe</code> that was written and read by the same code. That's clearly not a realistic scenario (unless we're trying to mock an "echo" server), so what can we do for more realistic scenarios? First, we need to connect our pipelines to something. We don't usually want a <code>Pipe</code> in isolation; we want a pipe that <em>integrates with a common system or API</em>. So; let's start by seeng what this would look like.</p>
<p>Here we need a bit of caveat and disclaimer: the pipelines released in .NET Core 2.1 <em>do not include any endpoint implementations</em>. Meaning: the <code>Pipe</code> machinery is there, but nothing is shipped <em>inside the box</em> that actually connects pipes with any other existing systems - like shipping the abstract <code>Stream</code> base-type, but without shipping <code>FileStream</code>, <code>NetworkStream</code>, etc. Yes, that sounds frustrating, but it was a pragmatic reality of time constraints. Don't panic! There are... "lively" conversations going on right now about which bindings to implement with which priority; and there are few community offerings to bridge the most obvious gaps for today.</p>
<p>Since we find ourselves in that position, we might naturally ask: "what does it take to connect pipelines to another data backend?".</p>
<p>Perhaps a good place to start would be connecting a pipe to a <code>Stream</code>. I know what you're thinking: "Marc, but in part 1 you went out of your way to say how terrible <code>Stream</code> is!". I haven't changed my mind; it isn't necessarily <em>ideal</em> - for any scenario-specific <code>Stream</code> implementation (such as <code>NetworkStream</code> or <code>FileStream</code>) we <em>could</em> have a dedicated pipelines-based endpoint that talked <em>directly</em> to that service with minimal indirection; but it is a <em>useful</em> first step:</p>
<ul>
<li>it gives us immediate access to a <em>huge</em> range of API surfaces - anything that can expose data via <code>Stream</code>, and anything that can act as a middle-layer via wrapped streams (encryption, compression, etc)</li>
<li>it hides all the wrinkly bits of the <code>Stream</code> API behind a clear unambiguous surface</li>
<li>it gives us <em>almost all</em> of the advantages that we have mentioned so far</li>
</ul>
<p>So, let's get started! The first thing we need to think about is: what is the <em>direction</em> here? As previously mentioned, a <code>Stream</code> is ambiguous - and could be read-only, write-only, or read-write. Let's assume we want to deal with the most general case: a read-write stream that acts in a duplex manner - this will give us access to things like sockets (via <code>NetworkStream</code>). This means we're actually going to want <em>two</em> pipes - one for the input, one for the output. Pipelines helps clear this up for us, by declaring an interface expressly for this: <code>IDuplexPipe</code>. This is a very simple interface, and being handed an <code>IDuplexPipe</code> is analogous to being handed the ends of two pipes - one marked "in", one marked "out":</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>interface</span> <span class=pl-en>IDuplexPipe</span>
{
    <span class=pl-en>PipeReader</span> <span class=pl-smi>Input</span> { <span class=pl-k>get</span>; }
    <span class=pl-en>PipeWriter</span> <span class=pl-smi>Output</span> { <span class=pl-k>get</span>; }
}</pre></div>
<p>What we want to do, then, is create a type that <em>implements</em> <code>IDuplexPipe</code>, but using 2 <code>Pipe</code> instances internally:</p>
<ul>
<li>one <code>Pipe</code> will be the output buffer (from the consumer's perspective), which will be filled by caller-code writing to <code>Output</code> - and we'll have a loop that consumes this <code>Pipe</code> and pushes the data into the underlying <code>Stream</code> (to be written to the network, or whatever the stream does)</li>
<li>one <code>Pipe</code> will be the input buffer (from the consumer's perspective); we'll have a loop that <em>reads</em> data from the underlying <code>Stream</code> (from the network, etc) and pushes it into the <code>Pipe</code>, where it will be drained by caller-code reading from <code>Input</code></li>
</ul>
<p>This approach immediately solves a <em>wide range</em> of problems that commonly affect people using <code>Stream</code>:</p>
<ul>
<li>we now have input/output buffers that decouple stream access from the read/write caller-code, without having to add <code>BufferedStream</code> or similar to prevent packet fragmentation (for the writing code), and to make it very easy to continue receiving more data while we process it (for the reading code especially, so we don't have to keep pausing while we ask for more data)</li>
<li>if the caller-code is writing faster than the stream <code>Write</code> can process, the back-pressure feature will kick in, throttling the caller-code so we don't end up with a huge buffer of unsent data</li>
<li>if the stream <code>Read</code> is out-pacing the caller-code that is <em>consuming</em> the data, the back-pressure will kick in here too, throttling our stream read loop so we don't end up with a huge buffer of unprocessed data</li>
<li>both the read and write implementations benefit from all the memory pool goodness that we discussed above</li>
<li>the caller-code doesn't ever need to worry about backlog of data (incomplete frames), etc - the pipe deals with it</li>
</ul>
<h1><a href=#so-what-might-that-look-like aria-hidden=true class=anchor id=user-content-so-what-might-that-look-like></a>So what might that look like?</h1>
<p>Essentially, all we need to do, is something like:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>class</span> <span class=pl-en>StreamDuplexPipe</span> : <span class=pl-en>IDuplexPipe</span>
{
    <span class=pl-en>Stream</span> <span class=pl-smi>_stream</span>;
    <span class=pl-en>Pipe</span> <span class=pl-smi>_readPipe</span>, <span class=pl-smi>_writePipe</span>;

    <span class=pl-k>public</span> <span class=pl-en>PipeReader</span> <span class=pl-smi>Input</span> <span class=pl-k>=&gt;</span> <span class=pl-smi>_readPipe</span>.<span class=pl-smi>Reader</span>;
    <span class=pl-k>public</span> <span class=pl-en>PipeWriter</span> <span class=pl-smi>Output</span> <span class=pl-k>=&gt;</span> <span class=pl-smi>_writePipe</span>.<span class=pl-smi>Writer</span>;
    
    <span class=pl-c><span class=pl-c>//</span> ... more here</span>
}</pre></div>
<p>Note that we have two different pipes; the caller gets one end of each pipe - and our code will act on the <em>other</em> end of each pipe.</p>
<h2><a href=#pumping-the-pipe aria-hidden=true class=anchor id=user-content-pumping-the-pipe></a>Pumping the pipe</h2>
<p>So what does the code look like to interact with the stream? We need two methods, as disccused above. The first - and simplest - has a loop that reads data from the <code>_stream</code> and pushes it to <code>_readPipe</code>, to be consumed by the calling code; the core of this method could be <em>something like</em></p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>while</span> (<span class=pl-c1>true</span>)
{
    <span class=pl-c><span class=pl-c>//</span> note we'll usually get *much* more than we ask for</span>
    <span class=pl-k>var</span> <span class=pl-smi>buffer</span> <span class=pl-k>=</span> <span class=pl-smi>_readPipe</span>.<span class=pl-smi>Writer</span>.<span class=pl-en>GetMemory</span>(<span class=pl-c1>1</span>);
    <span class=pl-k>int</span> <span class=pl-smi>bytes</span> <span class=pl-k>=</span> <span class=pl-k>await</span> <span class=pl-smi>_stream</span>.<span class=pl-en>ReadAsync</span>(<span class=pl-smi>buffer</span>);
    <span class=pl-smi>_readPipe</span>.<span class=pl-smi>Writer</span>.<span class=pl-en>Advance</span>(<span class=pl-smi>bytes</span>);
    <span class=pl-k>if</span> (<span class=pl-smi>bytes</span> <span class=pl-k>==</span> <span class=pl-c1>0</span>) <span class=pl-k>break</span>; <span class=pl-c><span class=pl-c>//</span> source EOF</span>
    <span class=pl-k>var</span> <span class=pl-smi>flush</span> <span class=pl-k>=</span> <span class=pl-k>await</span> <span class=pl-smi>_readPipe</span>.<span class=pl-smi>Writer</span>.<span class=pl-en>FlushAsync</span>();
    <span class=pl-k>if</span> (<span class=pl-smi>flush</span>.<span class=pl-smi>IsCompleted</span> <span class=pl-k>||</span> <span class=pl-smi>flush</span>.<span class=pl-smi>IsCanceled</span>) <span class=pl-k>break</span>;
}</pre></div>
<p>This loop asks the pipe for a buffer, then uses the new <code>netcoreapp2.1</code> overload of <code>Stream.ReadAsync</code> that accepts a <code>Memory&lt;byte&gt;</code> to populate that buffer - we'll discuss what to do if you don't have an API that takes <code>Memory&lt;byte&gt;</code> shortly. When the read is complete, it commits that-many bytes to the pipe using <code>Advance</code>, then it invokes <code>FlushAsync()</code> on the <em>pipe</em> to (if needed) awaken the reader, or pause the write loop while the back-pressure eases. Note we should also check the outcome of the <code>Pipe</code>'s <code>FlushAsync()</code> - it could tell us that the pipe's <em>consumer</em> has signalled that they've finished reading the data they want (<code>IsCompleted</code>), or that the pipe itself was shut down (<code>IsCanceled</code>).</p>
<p>Note that in both cases, we want to ensure that we tell the pipe when this loop has exited - <em>however it exits</em> - so that we don't end up with the calling code awaiting forever on data that will never come. Accidents happen, and sometimes the call to <code>_stream.ReadAsync</code> (or any other method) might throw an exception, so a good way to do this is with a <code>try</code>/<code>finally</code> block:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-en>Exception</span> <span class=pl-smi>error</span> <span class=pl-k>=</span> <span class=pl-c1>null</span>;
<span class=pl-k>try</span>
{
    <span class=pl-c><span class=pl-c>//</span> our loop from the previous sample</span>
}
<span class=pl-k>catch</span>(<span class=pl-en>Exception</span> <span class=pl-smi>ex</span>) { <span class=pl-smi>error</span> <span class=pl-k>=</span> <span class=pl-smi>ex</span>; }
<span class=pl-k>finally</span> { <span class=pl-smi>_readPipe</span>.<span class=pl-smi>Writer</span>.<span class=pl-en>Complete</span>(<span class=pl-smi>error</span>); }</pre></div>
<p>If you prefer, you could also use two calls to <code>Complete</code> - one at the end of the <code>try</code> (for success) and one inside the <code>catch</code> (for failure).</p>
<p>The second method we need is a bit more complex; we need a loop that consumes data from <code>_writePipe</code> and pushes it to <code>_stream</code>. The core of this could be something like:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>while</span> (<span class=pl-c1>true</span>)
{
    <span class=pl-k>var</span> <span class=pl-smi>read</span> <span class=pl-k>=</span> <span class=pl-k>await</span> <span class=pl-smi>_writePipe</span>.<span class=pl-smi>Reader</span>.<span class=pl-en>ReadAsync</span>();
    <span class=pl-k>var</span> <span class=pl-smi>buffer</span> <span class=pl-k>=</span> <span class=pl-smi>read</span>.<span class=pl-smi>Buffer</span>;
    <span class=pl-k>if</span> (<span class=pl-smi>buffer</span>.<span class=pl-smi>IsCanceled</span>) <span class=pl-k>break</span>;
    <span class=pl-k>if</span> (<span class=pl-smi>buffer</span>.<span class=pl-smi>IsEmpty</span> <span class=pl-k>&amp;&amp;</span> <span class=pl-smi>read</span>.<span class=pl-smi>IsCompleted</span>) <span class=pl-k>break</span>;

    <span class=pl-c><span class=pl-c>//</span> write everything we got to the stream</span>
    <span class=pl-k>foreach</span> (<span class=pl-k>var</span> <span class=pl-smi>segment</span> <span class=pl-k>in</span> <span class=pl-smi>buffer</span>)
    {
        <span class=pl-k>await</span> <span class=pl-smi>_stream</span>.<span class=pl-en>WriteAsync</span>(<span class=pl-smi>segment</span>);
    }
    <span class=pl-smi>_writePipe</span>.<span class=pl-en>AdvanceTo</span>(<span class=pl-smi>buffer</span>.<span class=pl-smi>End</span>);
    <span class=pl-k>await</span> <span class=pl-smi>_stream</span>.<span class=pl-en>FlushAsync</span>();    
}</pre></div>
<p>This awaits <em>some</em> data (which could be in multiple buffers), and checks some exit conditions; as before, we can give up if <code>IsCanceled</code>, but the next check is more subtle: we don't want to stop writing just because the <em>producer</em> indicated that they've written everything they wanted to (<code>IsCompleted</code>), or we might not write the last few segments of their data - we need to continue until <em>we've written all their data</em>, so <code>buffer.IsEmpty</code>. This is simplified in this case because we're always writing everything - we'll see a more complex example shortly. Once we have data, we write each of the non-contiguous buffers to the stream sequentially - because <code>Stream</code> can only write one buffer at a time (again, I'm using the <code>netcoreapp2.1</code> overload here that accepts <code>ReadOnlyMemory&lt;byte&gt;</code>, but we aren't restricted to this). Once it has written the buffers, it tells the pipe that we have consumed the data, and flushes the underlying <code>Stream</code>.</p>
<p>In "real" code we <em>might</em> want to be a bit more aggressive about optimizing to reduce flushing the underlying stream until we know there is no more data readily available, perhaps using the <code>_writePipe.Reader.TryRead(...)</code> method in addition to <code>_writePipe.Reader.ReadAsync()</code> method; this method works similarly to <code>ReadAsync()</code> but is guaranteed to always return synchronously - useful for testing "did the writer append something while I was busy?". But the above illustrates the point.</p>
<p>Additionally, like before we would want to add a <code>try</code>/<code>finally</code>, so that we always call <code>_writePipe.Reader.Complete();</code> when we exit.</p>
<p>We can use the <code>PipeScheduler</code> to start these two pumps, which will ensure that they run in the intended context, and our loops start pumping data. We'd have a <em>little</em> more house-keeping to add (we'd probably want a mechanism to <code>Close()</code>/<code>Dispose()</code> the underlying stream, etc) - but as you can see, it doesn't have to be a <em>huge</em> task to connect an <code>IDuplexPipe</code> to a source that wasn't designed with pipelines in mind.</p>
<h1><a href=#heres-one-i-made-earlier aria-hidden=true class=anchor id=user-content-heres-one-i-made-earlier></a>Here's one I made earlier...</h1>
<p>I've simplified the above a little (not too much, honest) to make it consise for discussion, but you still probably don't want to start copying/pasting chunks from here to try and get it to work. I'm not claiming they are the perfect solution for all situations, but as part of the <a href=https://github.com/StackExchange/StackExchange.Redis/issues/871 rel=nofollow>2.0 work for <code>StackExchange.Redis</code></a>, we have implemented a range of bindings for pipelines that we are making available on nuget - unimaginatively titled <code>Pipelines.Sockets.Unofficial</code> (<a href=https://www.nuget.org/packages/Pipelines.Sockets.Unofficial/ rel=nofollow>nuget</a>, <a href=https://github.com/mgravell/Pipelines.Sockets.Unofficial rel=nofollow>github</a>); this includes:</p>
<ul>
<li>converting a duplex <code>Stream</code> to an <code>IDuplexPipe</code> (like the above)</li>
<li>converting a read-only <code>Stream</code> to a <code>PipeReader</code></li>
<li>converting a write-only <code>Stream</code> to a <code>PipeWriter</code></li>
<li>converting an <code>IDuplexPipe</code> to a duplex <code>Stream</code></li>
<li>converting a <code>PipeReader</code> to a read-only <code>Stream</code></li>
<li>converting a <code>PipeWriter</code> to a writer-only <code>Stream</code></li>
<li>converting a <code>Socket</code> to an <code>IDuplexPipe</code> directly (without going via <code>NetworkStream</code>)</li>
</ul>
<p>The first six are all available via static methods on <code>StreamConnection</code>; the last is available via <code>SocketConnection</code>.</p>
<p><code>StackExchange.Redis</code> is very involved in <code>Socket</code> work, so we are very interested in how to connect pipelines to sockets; for redis connections without TLS, we can connect our <code>Socket</code> direct to the pipeline:</p>
<ul>
<li><code>Socket</code> ⇔ <code>SocketConnection</code></li>
</ul>
<p>For redis connections <em>with</em> TLS (in particular: cloud redis providers), we can connect the pieces thusly:</p>
<ul>
<li><code>Socket</code> ⇔ <code>NetworkStream</code> ⇔ <code>SslStream</code> ⇔ <code>StreamConnection</code></li>
</ul>
<p>Both of these configurations give us a <code>Socket</code> at one end, and an <code>IDuplexPipe</code> at the other, and it begins to show how we can orchcestrate pipelines as part of a more complex system. Perhaps more importantly, it gives us room in the future to <em>change</em> the implementation. As examples of future possibilities:</p>
<ul>
<li>Tim Seaward has been working on <a href=https://github.com/Drawaes/Leto rel=nofollow><code>Leto</code></a>, which provides TLS capability as an <code>IDuplexPipe</code> directly, without requiring <code>SslStream</code> (and thus: no stream inverters)</li>
<li>between Tim Seaward, David Fowler and Ben Adams, there are a <em>range</em> of experimental or in-progress network layers directly implementing pipelines without using managed sockets, including "libuv", "RIO" (Registered IO), and most recently, "magma" - which pushes the entire TCP stack into user code to reduce syscalls.</li>
</ul>
<p>It'll be interesting to see how this space develops!</p>
<h2><a href=#but-my-existing-api-doesnt-talk-in-spanbyte-or-memorybyte aria-hidden=true class=anchor id=user-content-but-my-existing-api-doesnt-talk-in-spanbyte-or-memorybyte></a>But my existing API doesn't talk in <code>Span&lt;byte&gt;</code> or <code>Memory&lt;byte&gt;</code>!</h2>
<p>When writing code to pump data from a pipe to another system (such as a <code>Socket</code>), it is very likely you'll bump into APIs that don't take <code>Memory&lt;byte&gt;</code> or <code>Span&lt;byte&gt;</code>. Don't panic, all is not lost! You still have multiple ways of breaking out of that world into something more ... traditional.</p>
<p>The first trick, for when you have a <code>Memory&lt;T&gt;</code> or <code>ReadOnlyMemory&lt;T&gt;</code>, is <code>MemoryMarshal.TryGetArray(...)</code>. This takes in a <em>memory</em> and attempts to get an <code>ArraySegment&lt;T&gt;</code> that describes the same data in terms of a <code>T[]</code> vector and an <code>int</code> offset/count pair. Obviously this can only work if the memory <em>was based on</em> a vector, which is not always the case. So this can fail <em>on exotic memory pools</em>. Our second escape hatch is <code>MemoryMarshal.GetReference(...)</code>. This takes in a <em>span</em> and returns a reference (actually a "managed pointer", aka <code>ref T</code>) to the start of the data. Once we have a <code>ref T</code>, we can use <code>unsafe</code> C# to get an unmanaged pointer to the data, useful for APIs that talk in such:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-en>Span</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>span</span> <span class=pl-k>=</span> ...
<span class=pl-en>fixed</span>(<span class=pl-smi>byte</span><span class=pl-k>*</span> <span class=pl-smi>ptr</span> <span class=pl-k>=</span> <span class=pl-k>&amp;</span><span class=pl-smi>MemoryMarshal</span>.<span class=pl-en>GetReference</span>(<span class=pl-smi>span</span>))
{
    <span class=pl-c><span class=pl-c>//</span> ...</span>
}</pre></div>
<p>It can still do this if the length of the span is zero, returning a reference to where the zeroth item <em>would have been</em>, and it <em>even works</em> for a <code>default</code> span where there never was any backing memory. This last one requires a slight word of caution because a <code>ref T</code> is <em>not usually expected to be null</em>, but that's exactly what you get here. Essentially, as long as you don't ever try to dereference this kind of null reference: you'll be fine. If you use <code>fixed</code> to convert it to an unmanaged pointer, you get back a null (zero) pointer, which <em>is</em> more expected (and can be useful in some P/Invoke scenarios). <code>MemoryMarshal</code> is <em>essentially</em> synonymous with <code>unsafe</code> code, even if the method you're calling doesn't require the <code>unsafe</code> keyword. It is perfectly valid to use it, but if you use it incorrectly, it reserves the right to hurt you - so just be careful.</p>
<h1><a href=#what-about-the-app-code-end-of-the-pipe aria-hidden=true class=anchor id=user-content-what-about-the-app-code-end-of-the-pipe></a>What about the app-code end of the pipe?</h1>
<p>OK, we've got our <code>IDuplexPipe</code>, and we've seen how to connect the "business end" of both pipes to your backend data service of choice. Now; how do we use it in our app code?</p>
<p>As in our example from part 1, we're going to hand the <code>PipeWriter</code> from <code>IDuplexPipe.Output</code> to our outbound code, and the <code>PipeReader</code> from <code>IDuplexPipe.Input</code> to our inbound code.</p>
<p>The <em>outbound</em> code is typically very simple, and is usually a very direct port to get from <code>Stream</code>-based code to <code>PipeWriter</code>-based. The key difference, once again, is that <em>you don't control the buffers</em>. A typical implementation might look something like:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-en>ValueTask</span>&lt;<span class=pl-k>bool</span>&gt; <span class=pl-en>Write</span>(<span class=pl-en>SomeMessageType</span> <span class=pl-smi>message</span>, <span class=pl-en>PipeWriter</span> <span class=pl-smi>writer</span>)
{
    <span class=pl-c><span class=pl-c>//</span> (this may be multiple GetSpan/Advance calls, or a loop,</span>
    <span class=pl-c><span class=pl-c>//</span> depending on what makes sense for the message/protocol)</span>
    <span class=pl-k>var</span> <span class=pl-smi>span</span> <span class=pl-k>=</span> <span class=pl-smi>writer</span>.<span class=pl-en>GetSpan</span>(...);
    <span class=pl-c><span class=pl-c>//</span> TODO: ... actually write the message</span>
    <span class=pl-k>int</span> <span class=pl-smi>bytesWritten</span> <span class=pl-k>=</span> ... <span class=pl-c><span class=pl-c>//</span> from writing</span>
    <span class=pl-smi>writer</span>.<span class=pl-en>Advance</span>(<span class=pl-smi>bytesWritten</span>);

    <span class=pl-k>return</span> <span class=pl-en>FlushAsync</span>(<span class=pl-smi>writer</span>);
}

<span class=pl-k>private</span> <span class=pl-k>static</span> <span class=pl-k>async</span> <span class=pl-en>ValueTask</span>&lt;<span class=pl-k>bool</span>&gt; <span class=pl-en>FlushAsync</span>(<span class=pl-en>PipeWriter</span> <span class=pl-smi>writer</span>)
{
    <span class=pl-c><span class=pl-c>//</span> apply back-pressure etc</span>
    <span class=pl-k>var</span> <span class=pl-smi>flush</span> <span class=pl-k>=</span> <span class=pl-k>await</span> <span class=pl-smi>writer</span>.<span class=pl-en>FlushAsync</span>();
    <span class=pl-c><span class=pl-c>//</span> tell the calling code whether any more messages</span>
    <span class=pl-c><span class=pl-c>//</span> should be written</span>
    <span class=pl-k>return</span> <span class=pl-k>!</span>(<span class=pl-smi>flush</span>.<span class=pl-smi>IsCanceled</span> <span class=pl-k>||</span> <span class=pl-smi>flush</span>.<span class=pl-smi>IsCompleted</span>);
}</pre></div>
<p>The first part of <code>Write</code> is our business code - we do whatever we need to write the data to the buffers from <code>writer</code>; typically this will include multiple calls to <code>GetSpan(...)</code> and <code>Advance()</code>. When we've written our message, we can flush it to ensure the pump is active, and apply back-pressure. For very large messages we <em>could</em> also flush at intermediate points, but for most simple scenarios: flushing once per message is fine.</p>
<p>If you're wondering why I split the <code>FlushAsync</code> code into a separate method: that's because I want to <code>await</code> the result of <code>FlushAsync</code> to check the exit conditions, so it needs to be in an <code>async</code> method. The most efficient way to access memory here is via the <code>Span&lt;byte&gt;</code> API, and <code>Span&lt;byte&gt;</code> is a <code>ref struct</code> type; as a consequence <a href=https://github.com/dotnet/csharplang/blob/master/proposals/csharp-7.2/span-safety.md rel=nofollow>we <strong>cannot</strong> use a <code>Span&lt;byte&gt;</code> local variable in an <code>async</code> method</a>. A pragmatic solution is to simply split the methods, so one method deals with the <code>Span&lt;byte&gt;</code> work, and another method deals with the <code>async</code> aspect.</p>
<h2><a href=#random-aside-async-code-hot-synchronous-paths-and-async-machinery-overhead aria-hidden=true class=anchor id=user-content-random-aside-async-code-hot-synchronous-paths-and-async-machinery-overhead></a>Random aside: async code, hot synchronous paths, and async machinery overhead</h2>
<p>The machinery involved in <code>async</code> / <code>await</code> is pretty good, but it can still be a surprising amount stack work - you can see this on <a href="https://sharplab.io/#v2:D4AQDABCCMCsDcBYAUCkBmKAmCB5ArgE4DCA9gCYCmKA3ihAxAA6ECWAbgIYAulU0ANigAOCADVOAG3yUQAgDwAjUqUkA+CADFpAZwAWAQR0BPAHYBjABQAFVk0oB1Nr0IQA7s8qEAlPUZ1kRiCIAHoQiE4mJkljCEVOcwBrAFoWSh0dIj5KbnM/YIguVwAzXT0IAF4oAE53T0IAOm18fSMzK28kQILQ8N5JSQhuPT5zKUlWUwBzCHMKPjcR4a8I01iAW1JCPnX0nU4p9PzgsIh9UnxJcjiF515TY6CQAHYIAEJLUpa9BoBJHWInAslEklGuwGAEC++j+ANI62iOTBnWOAF8UOjUFjTjomCpimCoVshiMIJQAB6cBGglCTFymKTYCC2exOVguWjHDDiKQyOTyZr6ABK6Uu3A0gsMJgslm8lQ0VGKnDFXUxOm4hHw5m4WjKIsykm4nO6DG5ylUEH+gOBoOuFQVlCVKq5mHNgyt8MRvDtDqdhtVQA=" rel=nofollow>sharplab.io</a> - take a look at the generated machinery for the <code>OurCode.FlushAsync</code> method - and the entirety of <code>struct &lt;FlushAsync&gt;d__0</code>. Now, this code is <em>not terrible</em> - it tries hard to avoid allocations in the synchronous path - but it is <em>unnecessary</em>. There are two ways to signficantly improve this; one is to not <code>await</code> <em>at all</em>, which is often possible if the <code>await</code> is the last line in a method <strong>and we don't need to process the results</strong>: don't <code>await</code> - just remove the <code>async</code> and <code>return</code> the task - complete or incomplete. We can't do that here, because we need to check the state of the result, but we can optimize for success by checking whether the task <em>is already complete</em> (via <code>.IsCompletedSuccessfully</code> - if it has completed but faulted, we still want to use the <code>await</code> to make sure the exception behaves correctly). If it <em>is</em> successfully completed, we're allowed to access the <code>.Result</code>; so we could <em>also</em> write our <code>FlushAsync</code> method as:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>private</span> <span class=pl-k>static</span> <span class=pl-en>ValueTask</span>&lt;<span class=pl-k>bool</span>&gt; <span class=pl-en>Flush</span>(<span class=pl-en>PipeWriter</span> <span class=pl-smi>writer</span>)
{
    <span class=pl-smi>bool</span> <span class=pl-en>GetResult</span>(<span class=pl-en>FlushResult</span> <span class=pl-smi>flush</span>)
        <span class=pl-c><span class=pl-c>//</span> tell the calling code whether any more messages</span>
        <span class=pl-c><span class=pl-c>//</span> should be written</span>
        <span class=pl-k>=</span><span class=pl-k>&gt;</span> <span class=pl-k>!</span>(<span class=pl-smi>flush</span>.<span class=pl-smi>IsCanceled</span> <span class=pl-k>||</span> <span class=pl-smi>flush</span>.<span class=pl-smi>IsCompleted</span>);

    <span class=pl-smi>async</span> <span class=pl-smi>ValueTask</span><span class=pl-k>&lt;</span><span class=pl-smi>bool</span><span class=pl-k>&gt;</span> <span class=pl-en>Awaited</span>(<span class=pl-en>ValueTask</span>&lt;<span class=pl-en>FlushResult</span>&gt; <span class=pl-smi>incomplete</span>)
        <span class=pl-k>=</span><span class=pl-k>&gt;</span> <span class=pl-en>GetResult</span>(<span class=pl-en>await</span> <span class=pl-smi>incomplete</span>);

    <span class=pl-c><span class=pl-c>//</span> apply back-pressure etc</span>
    <span class=pl-k>var</span> <span class=pl-smi>flushTask</span> <span class=pl-k>=</span> <span class=pl-smi>writer</span>.<span class=pl-en>FlushAsync</span>();

    <span class=pl-k>return</span> <span class=pl-smi>flushTask</span>.<span class=pl-smi>IsCompletedSuccessfully</span>
        <span class=pl-k>?</span> <span class=pl-k>new</span> <span class=pl-en>ValueTask</span>&lt;<span class=pl-k>bool</span>&gt;(<span class=pl-en>GetResult</span>(<span class=pl-smi>flushTask</span>.<span class=pl-smi>Result</span>))
        <span class=pl-k>:</span> <span class=pl-en>Awaited</span>(<span class=pl-smi>flushTask</span>);
}</pre></div>
<p>This <em>completely avoids</em> the <code>async</code>/<code>await</code> machinery in the most common case: synchronous completion - as we can see again on <a href="https://sharplab.io/#v2:D4AQDABCCMCsDcBYAUCkBmKAmCB5ArgE4DCA9gCYCmKA3ihAxAA6ECWAbgIYAulU0ANggA1TgBt8lEAIA8AI1KkxAPggAxCQGcAFgAoACqyaUA6m16EIAd3OVCASnqM6yRm4gKlEAOKVuAJUpNfDFuXQ18HUDg0IgAMy1tR1d3VIB6NIheMTEs7T4AY3ExVgA7AHMIAoo+K3zufMtOUoBPCABbUkI+dqDNTnKgp1S3DIgdUhDyD1rzXlLhkYYAXlUAQl0EyO0AOgBJTWJmgsoxSmngYHjE/cPSdqYz3nJ7JFQU1JAADhFxSWl5IoVBAAIJWTisZ66UQSKSyCJRIIhbiqMrVB5PSjJJZuVY+PzRZG6EAATggaPujz8WLei1GmU4TEebTknAKAGsALQsPpEPh+Ap0xhcSxbHTSCDLay2Qg7BHaEGaFqlAq6V4oIUMEAAdmu22ktzIGOp5AAyvgCidNJo4iExC1Ne4APwQUqUKy/WEAzwqXS+AJI0KbRIGwmhezYnEMABcoPBkPOwf1AnVHwgAF8UJn3igxpomIo4ud4l08vyAB6cY0oMoWUribAQQzGMwJwi0RYYT3/eGJMMo9SJRXK1X2SWqKhxTjIt7ZzTcQgW7iD7b9jtprs+iAHI4q07FvGT6ehN5uTdA7d3Y3PccQI8zrNAA=" rel=nofollow>sharplab.io</a>. I should emphasize: there's absolutely no point doing this if the code is usually (or exclusively) going to <em>actually be asynchronous</em>; it <em>only</em> helps when the result is usually (or exclusively) going to be available synchronously.</p>
<h2><a href=#and-what-about-the-reader aria-hidden=true class=anchor id=user-content-and-what-about-the-reader></a>And what about the reader?</h2>
<p>As we've seen many times, the reader is often slightly more complicated - we can't know that a single "read" operation will contain exactly one inbound message. We may need to loop until we have all the data we need, and we may have <em>additional</em> data that we need to push back. So let's assume we want to consume a single message of some kind:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>async</span> <span class=pl-en>ValueTask</span>&lt;<span class=pl-en>SomeMessageType</span>&gt; <span class=pl-en>GetNextMessage</span>(
    <span class=pl-en>PipeReader</span> <span class=pl-smi>reader</span>,
    <span class=pl-en>CancellationToken</span> <span class=pl-smi>cancellationToken</span> <span class=pl-k>=</span> <span class=pl-smi>default</span>)
{
    <span class=pl-k>while</span> (<span class=pl-c1>true</span>)
    {
        <span class=pl-k>var</span> <span class=pl-smi>read</span> <span class=pl-k>=</span> <span class=pl-k>await</span> <span class=pl-smi>reader</span>.<span class=pl-en>ReadAsync</span>(<span class=pl-smi>cancellationToken</span>);
        <span class=pl-k>if</span> (<span class=pl-smi>read</span>.<span class=pl-smi>IsCanceled</span>) <span class=pl-en>ThrowCanceled</span>();

        <span class=pl-c><span class=pl-c>//</span> can we find a complete frame?</span>
        <span class=pl-k>var</span> <span class=pl-smi>buffer</span> <span class=pl-k>=</span> <span class=pl-smi>read</span>.<span class=pl-smi>Buffer</span>;
        <span class=pl-k>if</span> (<span class=pl-en>TryParseFrame</span>(
            <span class=pl-smi>buffer</span>,
            <span class=pl-k>out</span> <span class=pl-en>SomeMessageType</span> <span class=pl-smi>nextMessage</span>,
            <span class=pl-k>out</span> <span class=pl-en>SequencePosition</span> <span class=pl-smi>consumedTo</span>))
        {
            <span class=pl-smi>reader</span>.<span class=pl-en>AdvanceTo</span>(<span class=pl-smi>consumedTo</span>);
            <span class=pl-k>return</span> <span class=pl-smi>nextMessage</span>;
        }
        <span class=pl-smi>reader</span>.<span class=pl-en>AdvanceTo</span>(<span class=pl-smi>buffer</span>.<span class=pl-smi>Start</span>, <span class=pl-smi>buffer</span>.<span class=pl-smi>End</span>);
        <span class=pl-k>if</span> (<span class=pl-smi>read</span>.<span class=pl-smi>IsCompleted</span>) <span class=pl-en>ThrowEOF</span>();        
    }
}</pre></div>
<p>Here we obtain <em>some</em> data from the pipe, checking exit conditions like cancelation. Next, we <em>try to find a message</em>; what this means depends on your exact code - this could mean:</p>
<ul>
<li>looking through the buffer for some sentinel value such as an ASCII line-ending, then treating everything up to that point as a message (discarding the line ending)</li>
<li>parsing a well-defined binary frame header, obtaining the payload length, checking that we have that much data, and processing it</li>
<li>or anything else you want!</li>
</ul>
<p>If we <em>do</em> manage to find a message, we can tell the pipe to discard the data that we've consumed - by <code>AdvanceTo(consumedTo)</code>, which uses whatever our own frame-parsing code told us that we consumed. If we <em>don't</em> manage to find a message, the first thing to do is tell the pipe that we consumed nothing despite trying to read everything - by <code>reader.AdvanceTo(buffer.Start, buffer.End)</code>. At this point, there are two possibilities:</p>
<ul>
<li>we haven't got enough data <em>yet</em></li>
<li>the pipe is dead and there will <em>never</em> be enough data</li>
</ul>
<p>Our check on <code>read.IsCompleted</code> tests this, reporting failure in the latter case; otherwise we continue the loop, and await more data. What is left, then, is our frame parsing - we've reduced complex IO management down to simple operations; for example, if our messages are separated by line-feed sentinels:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>private</span> <span class=pl-k>static</span> <span class=pl-k>bool</span> <span class=pl-en>TryParseFrame</span>(
    <span class=pl-en>ReadOnlySequence</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>buffer</span>,
    <span class=pl-k>out</span> <span class=pl-en>SomeMessageType</span> <span class=pl-smi>nextMessage</span>,
    <span class=pl-k>out</span> <span class=pl-en>SequencePosition</span> <span class=pl-smi>consumedTo</span>)
{
    <span class=pl-c><span class=pl-c>//</span> find the end-of-line marker</span>
    <span class=pl-k>var</span> <span class=pl-smi>eol</span> <span class=pl-k>=</span> <span class=pl-smi>buffer</span>.<span class=pl-en>PositionOf</span>((<span class=pl-smi>byte</span>)<span class=pl-s>'<span class=pl-cce>\n</span>'</span>);
    <span class=pl-k>if</span> (<span class=pl-smi>eol</span> <span class=pl-k>==</span> <span class=pl-c1>null</span>)
    {
        <span class=pl-smi>nextMessage</span> <span class=pl-k>=</span> <span class=pl-smi>default</span>;
        <span class=pl-smi>consumedTo</span> <span class=pl-k>=</span> <span class=pl-smi>default</span>;
        <span class=pl-k>return</span> <span class=pl-c1>false</span>;
    }

    <span class=pl-c><span class=pl-c>//</span> read past the line-ending</span>
    <span class=pl-smi>consumedTo</span> <span class=pl-k>=</span> <span class=pl-smi>buffer</span>.<span class=pl-en>GetPosition</span>(<span class=pl-c1>1</span>, <span class=pl-smi>eol</span>.<span class=pl-smi>Value</span>);
    <span class=pl-c><span class=pl-c>//</span> consume the data</span>
    <span class=pl-k>var</span> <span class=pl-smi>payload</span> <span class=pl-k>=</span> <span class=pl-smi>buffer</span>.<span class=pl-en>Slice</span>(<span class=pl-c1>0</span>, <span class=pl-smi>eol</span>.<span class=pl-smi>Value</span>);
    <span class=pl-smi>nextMessage</span> <span class=pl-k>=</span> <span class=pl-en>ReadSomeMessageType</span>(<span class=pl-smi>payload</span>);
    <span class=pl-k>return</span> <span class=pl-c1>true</span>;
}</pre></div>
<p>Here <code>PositionOf</code> tries to find the first location of a line-feed. If it can't find one, we give up. Otherwise, we set <code>consumedTo</code> to be "the line-feed plus one" (so we consume the line-feed), and we slice our buffer to create a sub-range that represents the payload <em>without</em> the line-feed, which we can then parse (however). Finally, we report success, and can rejoice at the simplicity of parsing linux-style line-endings.</p>
<h2><a href=#whats-the-point-here aria-hidden=true class=anchor id=user-content-whats-the-point-here></a>What's the point here?</h2>
<p>With minimal code that is <em>very similar to the most naïve and simple <code>Stream</code> version</em> (without any nice features) our app code now has a reader and writer chain that <em>automatically</em> exploits a wide range of capabilities to ensure efficient and effective processing. Again, you <em>can do all these things</em> with <code>Stream</code>, but it is <em>really, really hard</em> to do well and reliably. By pushing all theses features into the framework, multiple code-bases can benefit from a single implementation. It also gives future scope for interesting custom pipeline endpoints and decorators that work directly on the pipeline API.</p>
<h1><a href=#summary aria-hidden=true class=anchor id=user-content-summary></a>Summary</h1>
<p>In this section, we looked at the memory model used by pipelines, and how it helps us avoid allocations. Then we looked at how we might integrate pipelines into existing APIs and systems such a <code>Stream</code> - and we introduced <code>Pipelines.Sockets.Unofficial</code> as an available utility library. We looked at the options available for integrating span/memory code with APIs that don't offer those options, and finally we looked at what the <em>actual calling code</em> might look like when talking to pipelines (taking a brief side step into how to optimize <code>async</code> code that is usually synchronous) - showing what our <em>application</em> code might look like. In the third and final part, we'll look at how we combine all these learning points when looking at a real-world library such at <code>StackExchange.Redis</code> - discussing what complications the code needed to solve, and how pipelines made it simple to do so.</p>
<div style=clear:both></div>
</div>
<div class=post-footer>
<div class="post-footer-line post-footer-line-1"><span class="post-author vcard">
Posted by
<span class=fn itemprop=author itemscope itemtype=http://schema.org/Person>
<a class=g-profile href=https://www.blogger.com/profile/01023334706549710089 rel=author title="author profile">
<span itemprop=name>Marc Gravell</span>
</a>
</span>
</span>
<span class=post-timestamp>
at
<a class=timestamp-link href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-2.html rel=bookmark title="permanent link"><abbr class=published itemprop=datePublished title=2018-07-03T08:42:00-07:00>08:42</abbr></a>
</span>
<span class=post-comment-link>
</span>
<span class=post-icons>
<span class="item-control blog-admin pid-1042145909 sf-hidden">
</span>
</span>
<span class="post-backlinks post-comment-link">
</span>
</div>
<div class="post-footer-line post-footer-line-2"><span class=post-labels>
Labels:
<a href=https://blog.marcgravell.com/search/label/pipelines rel=tag>pipelines</a>
</span>
</div>
<div class="post-footer-line post-footer-line-3"></div>
</div>
</div>
<div class=comments id=comments>
<a name=comments></a>
</div>
</div>
<div class="inline-ad sf-hidden">
</div>
 </div></div>
 
</div>
<div class=blog-pager id=blog-pager>
<span id=blog-pager-newer-link>
<a class=blog-pager-newer-link href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-3.html id=Blog1_blog-pager-newer-link title="Newer Post">Newer Post</a>
</span>
<span id=blog-pager-older-link>
<a class=blog-pager-older-link href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-1.html id=Blog1_blog-pager-older-link title="Older Post">Older Post</a>
</span>
<a class=home-link href=https://blog.marcgravell.com/>Home</a>
</div>
<div class=clear></div>
<div class=post-feeds>
</div>
</div></div>
</div>
</div>
<div class=column-left-outer>
<div class=column-left-inner>
<aside>
</aside>
</div>
</div>
<div class=column-right-outer>
<div class=column-right-inner>
<aside>
<div class="sidebar section" id=sidebar-right-1><div class="widget AdSense sf-hidden" data-version=1 id=AdSense1>
<div class="widget-content sf-hidden">
</div>
</div><div class="widget Image" data-version=1 id=Image2>
<h2>Stack Overflow</h2>
<div class=widget-content>
<a href=https://stackoverflow.com/users/23354/marc-gravell>
<img alt="Stack Overflow" height=58 id=Image2_img src="data:image/png;base64,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" width=208>
</a>
<br>
</div>
<div class=clear></div>
</div><div class="widget Text" data-version=1 id=Text1>
<div class=widget-content>
@marcgravell
</div>
<div class=clear></div>
</div><div class="widget Subscribe" data-version=1 id=Subscribe1>
<div style=white-space:nowrap>
<h2 class=title>Subscribe</h2>
<div class=widget-content>
<div class="subscribe-wrapper subscribe-type-POST">
<div class="subscribe expanded subscribe-type-POST" id=SW_READER_LIST_Subscribe1POST style=display:none>
</div>
<div class=subscribe id=SW_READER_LIST_CLOSED_Subscribe1POST>
<div class=top>
<span class=inner>
<img class=subscribe-dropdown-arrow src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="13" height="10"><rect fill-opacity="0"/></svg>' style="background-blend-mode:normal!important;background-clip:content-box!important;background-position:50% 50%!important;background-color:rgba(0,0,0,0)!important;background-image:var(--sf-img-7)!important;background-size:100% 100%!important;background-origin:content-box!important;background-repeat:no-repeat!important">
<span>
<img align=absmiddle alt border=0 class=feed-icon src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12"><rect fill-opacity="0"/></svg>' style="background-blend-mode:normal!important;background-clip:content-box!important;background-position:50% 50%!important;background-color:rgba(0,0,0,0)!important;background-image:var(--sf-img-8)!important;background-size:100% 100%!important;background-origin:content-box!important;background-repeat:no-repeat!important">
Posts
</span>
</span>
</div>
<div class=bottom></div>
</div>
</div>
<div class="subscribe-wrapper subscribe-type-PER_POST">
<div class="subscribe expanded subscribe-type-PER_POST" id=SW_READER_LIST_Subscribe1PER_POST style=display:none>
</div>
<div class=subscribe id=SW_READER_LIST_CLOSED_Subscribe1PER_POST>
<div class=top>
<span class=inner>
<img class=subscribe-dropdown-arrow src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="13" height="10"><rect fill-opacity="0"/></svg>' style="background-blend-mode:normal!important;background-clip:content-box!important;background-position:50% 50%!important;background-color:rgba(0,0,0,0)!important;background-image:var(--sf-img-7)!important;background-size:100% 100%!important;background-origin:content-box!important;background-repeat:no-repeat!important">
<span>
<img align=absmiddle alt border=0 class=feed-icon src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12"><rect fill-opacity="0"/></svg>' style="background-blend-mode:normal!important;background-clip:content-box!important;background-position:50% 50%!important;background-color:rgba(0,0,0,0)!important;background-image:var(--sf-img-8)!important;background-size:100% 100%!important;background-origin:content-box!important;background-repeat:no-repeat!important">
Comments
</span>
</span>
</div>
<div class=bottom></div>
</div>
</div>
<div style=clear:both></div>
</div>
</div>
<div class=clear></div>
</div><div class="widget BlogArchive" data-version=1 id=BlogArchive1>
<h2>Blog Archive</h2>
<div class=widget-content>
<div id=ArchiveList>
<div id=BlogArchive1_ArchiveList>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2022/>
2022
</a>
<span class=post-count dir=ltr>(2)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2021/>
2021
</a>
<span class=post-count dir=ltr>(1)</span>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2020/>
2020
</a>
<span class=post-count dir=ltr>(4)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2019/>
2019
</a>
<span class=post-count dir=ltr>(2)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate expanded">
<a class=toggle>
<span class="zippy toggle-open">
 ▼&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2018/>
2018
</a>
<span class=post-count dir=ltr>(11)</span>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2018/12/>
December
</a>
<span class=post-count dir=ltr>(1)</span>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2018/09/>
September
</a>
<span class=post-count dir=ltr>(1)</span>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2018/08/>
August
</a>
<span class=post-count dir=ltr>(1)</span>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate expanded">
<a class=toggle>
<span class="zippy toggle-open">
 ▼&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2018/07/>
July
</a>
<span class=post-count dir=ltr>(4)</span>
<ul class=posts>
<li><a href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-31.html>Pipe Dreams, part 3.1</a></li>
<li><a href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-3.html>Pipe Dreams, part 3</a></li>
<li><a href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-2.html>Pipe Dreams, part 2</a></li>
<li><a href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-1.html>Pipe Dreams, part 1</a></li>
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2018/04/>
April
</a>
<span class=post-count dir=ltr>(1)</span>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2018/01/>
January
</a>
<span class=post-count dir=ltr>(3)</span>
</li>
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2017/>
2017
</a>
<span class=post-count dir=ltr>(7)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2016/>
2016
</a>
<span class=post-count dir=ltr>(5)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2015/>
2015
</a>
<span class=post-count dir=ltr>(4)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2014/>
2014
</a>
<span class=post-count dir=ltr>(16)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2013/>
2013
</a>
<span class=post-count dir=ltr>(4)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2012/>
2012
</a>
<span class=post-count dir=ltr>(9)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2011/>
2011
</a>
<span class=post-count dir=ltr>(14)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2010/>
2010
</a>
<span class=post-count dir=ltr>(24)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2009/>
2009
</a>
<span class=post-count dir=ltr>(57)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2008/>
2008
</a>
<span class=post-count dir=ltr>(16)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
</div>
</div>
<div class=clear></div>
</div>
</div></div>
<table border=0 cellpadding=0 cellspacing=0 class="section-columns columns-2">
<tbody>
<tr>
<td class="first columns-cell">
<div class="sidebar section" id=sidebar-right-2-1><div class="widget Profile" data-version=1 id=Profile1>
<h2>About Me</h2>
<div class=widget-content>
<a href=https://www.blogger.com/profile/01023334706549710089><img alt="My photo" class=profile-img height=80 src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4QAqRXhpZgAASUkqAAgAAAABADEBAgAHAAAAGgAAAAAAAABHb29nbGUAAP/bAIQAAwICCggNCw8LCw8KDQoKDQsNDgoIDQ0KDQ0PDQgNCgsNEAgKCwgICgoKDg4KCgoKCAoKCQ0NCg0PCggOCAgKCAEDBAQGBQYKBgYKDQ0KDQ0NDQ0PDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0N/8AAEQgAUABQAwERAAIRAQMRAf/EABsAAAIDAQEBAAAAAAAAAAAAAAYHBAUIAwIB/8QAOxAAAQMCAgcHAwEGBwEAAAAAAQIDEQAhBBIFBgcxQVFhCBMicYGRoUKx8DJSYnKyweEUI4KSosLxFf/EABoBAAIDAQEAAAAAAAAAAAAAAAQFAQIDBgD/xAAnEQACAgEEAgICAgMAAAAAAAAAAQIRAwQSITEFQRMiMlFhgRQVI//aAAwDAQACEQMRAD8AAO0vioZR/r/lri8nM4nY6LiMwC7JjyW1OrWQlKWVEqUQABm62G6iZxuVGWRf8hpawdp/CtkhpJej6hCUek+M9DljrRHxMAdWCOM7VrxPgZR5KKifWCB7Vf4SjLjQ/aiBA7zD34ltdvZYkHpPrUPCyA01a1+wr4U53mXMZOexA4C0jdvg1zWuwy3W0P8ATyjtpEt1hOIdaIUCltQdBTcEiQB6zf8AvVtHHmz2quEaCx5VP9ogZFdFQ40iQc2gYfNh3f4Z9iKFyfiG6Z1MAO0ZhC4y2Bclak+6FVXJ+aCdJ+MjO2i8EsJKEqhMQqDZZmeVwk2psoL8gKUpNbfRLa1OVwTPG1/7/H3q3yclVgb5Jzmr8RIPnFxz37qs5l1jrsknRIiPUcDHWP61WzVQTLLQ6HEkFMxuI4HzG6Itf2sKGnJS7NYQkmOzY3jmm8yAcpcOZCVeuZCZ5b45eVBxgt1ntTKTXI0lufk0ZYtfJHUazbKFVrM1macHNB+1YZFwEYG1MXO2nFS00QQYcO4z9KuXnUwqcgnFcE2xFYRq4gcfkxTMEg7djK1dwYSiSbp5eR+OPSg5saY+UcEaLdxjkNoKrQcqd/TdA+alTpHnilJjC0f2VsapMkBMwSAN3IE7h5faoeSzWOBjP1D7O7eHEunMd0cB7m/5al+SbG2HD+yq2nbM0so7xizmGPfJAH6gm602j9SZHrVceTkz1eBOPBI0bpJLqELTdK0hQPQgEUwuzkmqbR2JrxVnJ4Aj4rKXdGkOJGT9cNKgrICpASDEmN5k8pFqF0MrlY+12L6Wjzq6UkSd/XjT6QjxDP2Zauf4hUEwk287/FLso3wo1XqfqazhEgNpAI4wL0Hv9DfGkHDWnyBB+1TZqtpR4zScz+f+UPPkJRR6QwwgqWRF954WmZ/IqILkzyL68ij1VwrbSVIQsLShxZTBuEKUpSR5JnKOEAUzh0cbqIbZsuCK0oEIzrsVWXZaPX8mNdOIGHeUhW/MWj55o8+tBabE4M6fV5oygdtGv5CQads56HYzdnOsvdrQBJJMJSBvPM+Xx60BlG+Fp9GztDYg5EZrGBv8vagtvsPhZIxmsTLIJcWEgD6lR96ska71EG07UsM/Zk5/3gDl6wdxPlUNI1hlFHtd16zrSwpakpIClhEglPIkCQk/UbW4jfVowvkzzZCq0woIZw/cJyl17I2UzIlXiUn9rwyTIUF8iK1x9iLUwt2HrAMCTJgAki5PE2sJN4FF0K5KiM+m1ZT7PIyX2gdRULcexeHznvHEqKMnGAFKEDMASJ9zRGDVQkqbCMmmybkvQzn+zStxpC8M/wB67kQpxtxORPiSD/llIkg/vknqKF/yftQ7/wBY3BSPOx1I0XjSnGp7pZSEpKrouJEK3CRxMbuhq+RqStGGKDxypmqsVppKky2oOCPpMjofDQQwmxU6waSBUSrDLeVFrC56ZyEpjrHrVooyk+Cn1Q0TiAVqXyJCQbJtIT+mFE7rW3bq84F07Qc6Y1DGkWm3TKVtiFJECW+M2kqSfEJJG8Wmajc49BSxbkUG0zTTei8Ol3J3oYICRMKGeEEg7gSDeBJvetcEd8hZ5GKhisX2ju1BgiB3qVs2/ZC0nyyHN/wpnLSTvg5COoUlyMHVrXHD41MsuBfMTCx5pPiHqKFy4pQfIXGcZCF1q20MsjK0O9ULSbIHlxV8DrQem8XOX2kM9T5SEX9Bldm3bmnSSV4V1SW8RALahbvkJJIRa4W2PCQJKkAKEwuCdTovi/EZ+M8p830yf0MvXHUBX+U44Idw7oOcLCgtBJISfqlAsJAmTB8RFBKb6Qbmx/ZSCRvQuHdBlABO8tqLa582lJXPr96m6fJDSfBYYHQjaIEqWMuWVrzLiZF4GbkSZUbXMXlSsq8RB05aQ2i0T6cT58Bx61ZzNscEuz5oXapg8Nm8YIQmDIiOc8R7X51RsLTSEL2lNfm8RhHO73OKRw4ZgZ5CworRRvKIPMOsNmPsC5JE8Jia6qXZwW1BTojSamyClRSobilUEeo/DVHFPllk9vQEnFk/JrT1RDr9ETA49TZSpCihSFBaVJUQpKhuIIuCOYqsoqXDRbHOUGpJ8o3dsq2oP47R7LjzhcUApKyUiSpClJUTkAuQArhIINcjq4OGT6ne6PUPNjuXYU6t62pdAKFcbj2vy97xQ9v2GQkgsw+uqAPF4Y4nj/UVHRdzaIGnsS+6lIZGbOJMLCfD5kGIPSo5vs0VPli40vs+dQSpTSWu88Eqczkk9AEpJnnN78K17CEo+xN9qLD/AODaw7KZ8ZKlE8coHsL24e1MfHczs5PzUrjsQjMAIiukfZyJcsv5bm/5uqGiQRaX9jUlWRWVSK8eH12U9qjeGcXhsQoJaxRBbUr9KHrgpJ+kPCBO4KSP2hSfXafct0ex547U7Htk+B463agOYcleHJSLmASUz1G4jkd/yKSKfqSOor3DkF2tp6m4Q+MhFsxEgj0mZN+F/U1f44y6IWVrsJdWNtqGVBMgoixjcOImfbjVXhf6I+ZfsY+s2vuDfbuYyQsHPaQJtFU2yTqglZYVbZkPtO7TW9IvNJQQsMAgqA5kQOsDfTvQYXDmRynlNTHI0o+rFcinV22c8iexYjjlHya8WsFWrg9E14qcsKm1ePHnEMzXuT382M7Z92mNIaOARmTiWhYIfBKgIsErSQtI/iCxwAFLs2jhk67GmDXzxBfprtYNPDxaPGYji94f5P8ArNCR8c10xg/L7lVCa1q18cxRkIQwmbJZSR7kkqUf9o6Uyx6aMBVm1LyO4sp//qOmB3iiOWcx9/itvji/Rj80/wBkvAJgj3q9LpGErfZaO76mqKkjAXIHr+fevHj/2Q==" width=80></a>
<dl class=profile-datablock>
<dt class=profile-data>
<a class="profile-name-link g-profile" href=https://www.blogger.com/profile/01023334706549710089 rel=author style=background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA3klEQVQ4y2P4l8YUCsT/ycT6DBRoBmNMA5IZ/v+LB+IYKI5lgIgRZUACUOH2jv//3j/5/+//fwj+8/P/vyNz/v8rliRgQDJUM0jTv39oGCh2ceP/f0kMeAwAORtkM0gDyJBzqyEYZiCILpXCYwDIvzDF1/YAFUtCMIgNM2BVyf9/hWJEGPD3LyIMQGx0sRgGEgxAN4goA2BeqJCDYHSvYDUAWyCCQh6EkQPz08v//+IYSI3GfwiD58cTSEggBSBb0MMAJAaSS2AgkJRBOA4pKcNwHAOReYGMzKRPgQEGAIvy2M2lOZIeAAAAAElFTkSuQmCC)>
Marc Gravell
</a>
</dt>
</dl>
<a class=profile-link href=https://www.blogger.com/profile/01023334706549710089 rel=author>View my complete profile</a>
<div class=clear></div>
</div>
</div></div>
</td>
<td class=columns-cell>
<div class="sidebar no-items section" id=sidebar-right-2-2></div>
</td>
</tr>
</tbody>
</table>
<div class="sidebar section" id=sidebar-right-3><div class="widget Label" data-version=1 id=Label1>
<h2>Labels</h2>
<div class="widget-content list-label-widget-content">
<ul>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/c%23>c#</a>
<span dir=ltr>(48)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/protobuf-net>protobuf-net</a>
<span dir=ltr>(30)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/.net>.net</a>
<span dir=ltr>(17)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/4.0>4.0</a>
<span dir=ltr>(17)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/serialization>serialization</a>
<span dir=ltr>(15)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/linq>linq</a>
<span dir=ltr>(12)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/expression>expression</a>
<span dir=ltr>(10)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/me>me</a>
<span dir=ltr>(10)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/community>community</a>
<span dir=ltr>(8)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/redis>redis</a>
<span dir=ltr>(7)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/reflection>reflection</a>
<span dir=ltr>(6)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/cf>cf</a>
<span dir=ltr>(5)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/ide>ide</a>
<span dir=ltr>(5)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/metaprogramming>metaprogramming</a>
<span dir=ltr>(5)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/pipelines>pipelines</a>
<span dir=ltr>(5)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/dynamic>dynamic</a>
<span dir=ltr>(3)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/generics>generics</a>
<span dir=ltr>(3)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/mvc>mvc</a>
<span dir=ltr>(3)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/5.0>5.0</a>
<span dir=ltr>(2)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/asp.net>asp.net</a>
<span dir=ltr>(2)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/async>async</a>
<span dir=ltr>(2)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/disposable>disposable</a>
<span dir=ltr>(2)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/phone-7>phone-7</a>
<span dir=ltr>(2)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/stackexchange>stackexchange</a>
<span dir=ltr>(2)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/stackoverflow>stackoverflow</a>
<span dir=ltr>(2)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/surface>surface</a>
<span dir=ltr>(2)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/autism>autism</a>
<span dir=ltr>(1)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/c%23%20.net%205.0%20async%20redis>c# .net 5.0 async redis</a>
<span dir=ltr>(1)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/c%23%20linq>c# linq</a>
<span dir=ltr>(1)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/c%23%20profiling>c# profiling</a>
<span dir=ltr>(1)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/ikvm>ikvm</a>
<span dir=ltr>(1)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/immutability>immutability</a>
<span dir=ltr>(1)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/linq%20expression%20c%23>linq expression c#</a>
<span dir=ltr>(1)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/tpl>tpl</a>
<span dir=ltr>(1)</span>
</li>
</ul>
<div class=clear></div>
</div>
</div></div>
</aside>
</div>
</div>
</div>
<div style=clear:both></div>
</div>
</div>
</div>
<div class="main-cap-bottom cap-bottom">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
<footer>
<div class=footer-outer>
<div class="footer-cap-top cap-top">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class="fauxborder-left footer-fauxborder-left">
<div class="fauxborder-right footer-fauxborder-right"></div>
<div class="region-inner footer-inner">
<div class="foot no-items section" id=footer-1></div>
<table border=0 cellpadding=0 cellspacing=0 class="section-columns columns-2">
<tbody>
<tr>
<td class="first columns-cell">
<div class="foot no-items section" id=footer-2-1></div>
</td>
<td class=columns-cell>
<div class="foot no-items section" id=footer-2-2></div>
</td>
</tr>
</tbody>
</table>
<div class="foot section" id=footer-3><div class="widget Attribution" data-version=1 id=Attribution1>
<div class=widget-content style=text-align:center>
Simple theme. Powered by <a href=https://www.blogger.com/ target=_blank>Blogger</a>.
</div>
<div class=clear></div>
</div></div>
</div>
</div>
<div class="footer-cap-bottom cap-bottom">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
</footer>
</div>
</div>
<div class="content-cap-bottom cap-bottom">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
</div>
