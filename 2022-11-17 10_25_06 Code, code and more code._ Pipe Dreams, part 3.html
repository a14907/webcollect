<!DOCTYPE html> <html class=v2 dir=ltr xmlns=http://www.w3.org/1999/xhtml xmlns:b=http://www.google.com/2005/gml/b xmlns:data=http://www.google.com/2005/gml/data xmlns:expr=http://www.google.com/2005/gml/expr style><!--
 Page saved with SingleFile 
 url: https://blog.marcgravell.com/2018/07/pipe-dreams-part-3.html 
 saved date: Thu Nov 17 2022 10:25:06 GMT+0800 (中国标准时间)
--><meta charset=utf-8>
<style>:root{--sf-img-3: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAARMCAYAAACZG7OEAAABWklEQVR42u3cwQ0CQQwEQS/cl2jIPzCQ0BAEBnHrqgBW7hvxZSW5VaOjqlbng5dq1v6gZMmSJbtQsmTJkiWfK9kokiVLlizZKJIlS5Ys2YWSJUuWLHnXZKNIlixZsmSjSJYsWbJkF0qWLFmyZMnbJBtFsmTJko0iWbJkyZIlu1CyZMmSJe+abBTJkiVLlmwUyZIlS5bsQsmSJUsekmwUyZIlS5Ys2SiSJUuWLNmFkiVLlixZ8nmTjSJZsmTJRpEsWbJkyZJdKFmyZMn/mbyS3LsvzLxRJEuWLFmyZMmSJUs2imTJkiVLlixZsmTJU5ONIlmyZMmSJUuWLFnytGSjSJYsWbJkyZIlSx4+CgAAAAAAAAAAAAAAAAAAAAAAAADwYytJ6/8fHlX16n7wMe/Bp2TJfim+oWTfULJvKNk3/NaFK8m1AAAAAAAAAAAAAAAAAAAAAAAAAADgE2/S1Gnyf8/liwAAAABJRU5ErkJggg==");--sf-img-7: url("data:image/gif;base64,R0lGODlhDQAKALMPAP///6+vr/j4+OHh4fr6+uzs7Nvb2+3t7dzc3Ojo6N3d3e7u7ubm5vf39/b29v///yH5BAEAAA8ALAAAAAANAAoAQAQ68D1AK5AYi5OOyMQxBAFAGshwEARpmQGzEJJQjOhQfBLxUo4GTZBwUU6KxMc2OqV2GaZCx8v0BLRMBAA7");--sf-img-8: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAMAAABhq6zVAAAABGdBTUEAANbY1E9YMgAAAP9QTFRF2XIp3nIw4Xgx6IY16Yc1214q3WMr32ow4Gks4W40428u43I144BT5XMu5XY25noz53Yw6Hkw6Hs36X43634y64Ax64A564M57Ic+7Zpj7oUz7oY67oc67qZ974Y08Is78I1A8J1l8Yo08Yw88Y858ZVN8bGK8o888442848286Rm87aL9JI99JM99JxP9LyY9ZU79ZY+9pQ39ptE9qto95c495k/97J1+Jg4+LmB+MSa+MWa+atd+bFq+cea+ps5+rd2+rh2+r2D+uXY+506+6NG+65e+69f+7p3+7+D/MCD/erZ/e/l/fDm/fHm/ufO/vLm/vPm/vjy//nz////B9JuTQAAAAV0Uk5TMO/v7++mu2gOAAAAj0lEQVQIHQXBUQuCMBAA4N3ddjO11B5C+jVC//+t94iCCCQa6tJ5bn0fKGy0oYx1ugpiwRAJja06ggovanGTscb9qAYvtt4jumGhBtswxMK6r1818VnJPJbHp0fM7G2CcnlyIYK8y2GUw2tug6DmU769mR5N3NBYiX2vzEdpAd25wXsJMSaheM+2NSWlIKQ/2xpDTzPOPTwAAAAASUVORK5CYII=")}body{margin:0}.content-outer,.header-outer,.tabs-outer,.main-outer,.main-inner,.footer-outer,.post,.comments,.widget,.date-header{position:relative;min-height:0}.footer-outer{margin-bottom:-1px}.tabs-inner{padding:0 15px}.main-inner{padding:30px 0}.main-inner .column-left-inner,.main-inner .column-right-inner{padding:0 15px}.footer-inner{padding:30px 15px}.section{margin:0 15px}.widget{margin:30px 0}.section:first-child .widget:first-child{margin-top:0}.section:last-child .widget:last-child{margin-bottom:0}body .navbar{height:30px;padding:0;margin:0}body .navbar .Navbar{position:absolute;z-index:10;left:0;width:100%;margin:0;padding:0;background:none;border:none}.header-inner .section{margin:0}.header-inner .widget{margin-left:30px;margin-right:30px}.header-inner .Header{margin:0}.header-inner .Header #header-inner{overflow:hidden}.header-inner .Header .descriptionwrapper{margin-bottom:25px}.Header h1{margin-bottom:10px}.Header .description{margin:.5em 0 10px;padding:0 2px}a img{position:relative}h1,h2,h3{margin:0;position:relative}h1 a:hover{text-decoration:none}.widget{line-height:1.4}.widget ul{padding:0 0 0 1.25em;margin:0;line-height:1.2}.widget li{padding:.25em 0;margin:0;text-indent:0}.widget .post-body ul{padding:0 2.5em;margin:.5em 0;line-height:1.4}.widget .post-body li{margin-bottom:.25em;padding-top:0;padding-bottom:0}.post-body{width:100%}.post-footer-line>*{margin-right:1em}.post-footer-line>*:last-child{margin-right:0}.post-timestamp{margin-left:-1em}.post-footer-line>*:first-child{margin-left:0}.Profile img{margin:0 .75em .5em 0}.Profile .profile-datablock{margin:0 0 .5em}dt{font-weight:bold}table.section-columns td.first.columns-cell{border-left:none}html{height:100%}body{min-height:100%;position:relative}.content{position:relative;word-wrap:break-word}.content-outer,.region-inner{min-height:0;margin:0 auto}.columns{zoom:1}.columns-inner{min-height:0}.column-center-outer,.column-left-outer,.column-right-outer{position:relative;float:left}.column-center-outer{width:100%}.fauxcolumns{position:relative}.fauxcolumn-outer{position:absolute;top:0;bottom:0;overflow:hidden}.fauxcolumn-outer .fauxborder-left,.fauxcolumn-outer .fauxborder-right,.fauxcolumn-inner{height:100%}.fauxcolumn-left-outer{left:0}.fauxcolumn-right-outer{right:0}.cap-top,.cap-bottom{position:relative;height:0;background-repeat:repeat-x}.cap-top .cap-left,.cap-top .cap-right,.cap-bottom .cap-left,.cap-bottom .cap-right{height:100%;background-repeat:no-repeat}.cap-top,.cap-top .cap-left{background-position:top left}.cap-bottom,.cap-bottom .cap-left{background-position:bottom left}.cap-top .cap-left,.cap-bottom .cap-left{float:left}.cap-top .cap-right{background-position:top right;float:right}.cap-bottom .cap-right{background-position:bottom right;float:right}.fauxborder-left{background-position:top left;background-repeat:repeat-y;position:relative}.fauxborder-right{background-position:top right;background-repeat:repeat-y;position:absolute;right:0;height:100%}table.section-columns{border:none;table-layout:fixed;width:100%;position:relative}table.columns-2 td.columns-cell{width:50%}table.section-columns td.columns-cell{vertical-align:top}.body-fauxcolumns,.content-fauxcolumns{position:absolute;top:0;left:0;z-index:-1;height:100%;width:100%;overflow:hidden}.body-fauxcolumns .fauxcolumn-outer{width:100%}.content-fauxcolumns .fauxcolumn-outer{position:relative;overflow:visible;height:100%;margin:0 auto}aside,header,footer{display:block}div.clear{clear:both}#navbar-iframe{display:block;height:30px}.profile-img{float:left}.profile-data{margin:0}.profile-name-link{background:no-repeat left top;box-sizing:border-box;display:inline-block;max-width:100%;min-height:20px;padding-left:20px}body{overflow-wrap:break-word;word-break:break-word;word-wrap:break-word}.widget.Subscribe{position:static}.widget.Subscribe .widget-content{zoom:1}.subscribe{color:#999}.subscribe-wrapper{margin:.5em;padding:0;position:relative;zoom:1}div.subscribe{cursor:pointer;margin:0;padding:0;text-align:left;width:144px}div.subscribe div.top{font-size:1em;padding:4px 0 1px;width:144px}html>body div.subscribe div.top{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJAAAAGQBAMAAACzH/Q/AAAAMFBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkJCTg4ODh4eH7+/v8/Pz///8hEP7MAAAAD3RSTlMABBQiIyYnKCkqK5aZ6O1Hd1dgAAAAv0lEQVR42u3TwRGCMBRF0fArCOxYilZgCfZAYWzpAKuzA+3A1Vs4eG4BZyYvSQ3XNdC917w/Ax1bTY8W6HappUVaasxAY7VQIBAIBAKBQCAQCAQCgUCgBNQzzpCDfu9oJ741XwQE+gq9Ms7b2P89tndkbBAIBAKBQCAQCAQCgUAgEAgEAoFAIBAIBAKBQCAQCAQCgUAgEAgEAoFAIBAIBAKBQCAQCAQCgUAgEAgEAoFAIBAIBAKBQCAQCAQ6N/QBxmRSL1QjElcAAAAASUVORK5CYII=)top left no-repeat}span.inner{padding:0}div.subscribe div.top span.inner{margin:0 5px}.feed-icon{vertical-align:baseline;display:inline}div.subscribe div.bottom{font-size:3px;height:3px;line-height:0}.subscribe-wrapper .expanded{position:absolute;top:0;z-index:20}html>body div.subscribe div.bottom{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJAAAAADBAMAAACOmptmAAAALVBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAAkJCTh4eHj4+Pk5OT7+/v8/Pz9/f3///+jj1vZAAAADHRSTlMABAUUFSImK5mbnuu6xDmCAAAAIklEQVQIHWOweHuGcnD23hQG8dXvqAB2FTEwuaZRAYQoAAA1TZXCCL/A+AAAAABJRU5ErkJggg==)bottom left no-repeat;margin-bottom:0;padding-bottom:0;width:144px}.subscribe-dropdown-arrow{float:right;margin-right:6px;margin-top:4px}#ArchiveList .toggle{cursor:pointer;font-family:Arial,sans-serif}#ArchiveList .toggle-open{line-height:.6em}#ArchiveList{text-align:left}#ArchiveList a.post-count-link,#ArchiveList a.post-count-link:link,#ArchiveList a.post-count-link:visited{text-decoration:none}#ArchiveList a.toggle,#ArchiveList a.toggle:link,#ArchiveList a.toggle:visited,#ArchiveList a.toggle:hover{color:inherit;text-decoration:none}.BlogArchive #ArchiveList ul li{background:none;list-style:none;list-style-image:none;list-style-position:outside;border-width:0;padding-left:15px;text-indent:-15px;margin:.25em 0;background-image:none}.BlogArchive #ArchiveList ul ul li{padding-left:1.2em}.BlogArchive #ArchiveList ul{margin:0;padding:0;list-style:none;list-style-image:none;border-width:0}.BlogArchive #ArchiveList ul.posts li{padding-left:1.3em}.post-footer abbr{border:none}#blog-pager-newer-link{float:left}#blog-pager-older-link{float:right}#blog-pager{margin:1em 0;text-align:center;overflow:hidden}.comments{clear:both;margin-top:10px;margin-bottom:0}</style>
<meta content="width=1100" name=viewport>
<meta content=blogger name=generator>
<link href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-3.html rel=canonical>
<link rel=alternate type=application/atom+xml title="Code, code and more code. - Atom" href=https://blog.marcgravell.com/feeds/posts/default>
<link rel=alternate type=application/rss+xml title="Code, code and more code. - RSS" href="https://blog.marcgravell.com/feeds/posts/default?alt=rss">
<link rel=service.post type=application/atom+xml title="Code, code and more code. - Atom" href=https://www.blogger.com/feeds/8184237816669520763/posts/default>
<link rel=alternate type=application/atom+xml title="Code, code and more code. - Atom" href=https://blog.marcgravell.com/feeds/6007133552883736143/comments/default>
<meta content=https://blog.marcgravell.com/2018/07/pipe-dreams-part-3.html property=og:url>
<meta content="Pipe Dreams, part 3" property=og:title>
<meta content="Pipelines - a guided tour of the new IO API in .NET, part 3  Update: please also see part 3.1  for further clarifications on this post  Sorr..." property=og:description>
<title>Code, code and more code.: Pipe Dreams, part 3</title>
<style id=template-skin-1><!--body{font:normal normal 12px Arial,Tahoma,Helvetica,FreeSans,sans-serif;color:#222222;background:#eeaa00 none repeat scroll top left;padding:0 40px 40px 40px}html body .region-inner{min-width:0;max-width:100%;width:auto}h2{font-size:22px}a:link{text-decoration:none;color:#cc6611}a:visited{text-decoration:none;color:#888888}a:hover{text-decoration:underline;color:#ff9900}.body-fauxcolumn-outer .fauxcolumn-inner{background:transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKAQMAAAC3/F3+AAAAA1BMVEX///+nxBvIAAAAAXRSTlOZyTXzhgAAAApJREFUCB1jwAsAAB4AAfeYTFwAAAAASUVORK5CYII=)repeat scroll top left}.body-fauxcolumn-outer .cap-top{position:absolute;z-index:1;height:400px;width:100%}.body-fauxcolumn-outer .cap-top .cap-left{width:100%;background:transparent var(--sf-img-3) repeat-x scroll top left}.content-outer{-moz-box-shadow:0 0 40px rgba(0,0,0,.15);-webkit-box-shadow:0 0 5px rgba(0,0,0,.15);-goog-ms-box-shadow:0 0 10px #333333;box-shadow:0 0 40px rgba(0,0,0,.15);margin-bottom:1px}.content-inner{padding:10px 10px}.content-inner{background-color:#ffffff}.header-outer{background:#cc6611 var(--sf-img-3) repeat-x scroll 0-400px}.Header h1{font:normal normal 60px Arial,Tahoma,Helvetica,FreeSans,sans-serif;color:#ffffff;text-shadow:1px 2px 3px rgba(0,0,0,.2)}.Header h1 a{color:#ffffff}.Header .description{font-size:140%;color:#ffffff}.header-inner .Header .titlewrapper{padding:22px 30px}.header-inner .Header .descriptionwrapper{padding:0 30px}.tabs-inner .section:first-child{border-top:0 solid #eeeeee}.main-outer{border-top:0 solid #eeeeee}.fauxcolumn-left-outer .fauxcolumn-inner{border-right:1px solid #eeeeee}.fauxcolumn-right-outer .fauxcolumn-inner{border-left:1px solid #eeeeee}div.widget>h2,div.widget h2.title{margin:0 0 1em 0;font:normal bold 11px Arial,Tahoma,Helvetica,FreeSans,sans-serif;color:#000000}.widget .zippy{color:#999999;text-shadow:2px 2px 1px rgba(0,0,0,.1)}h2.date-header{font:normal bold 11px Arial,Tahoma,Helvetica,FreeSans,sans-serif}.date-header span{background-color:transparent;color:#222222;padding:inherit;letter-spacing:inherit;margin:inherit}.main-inner{padding-top:30px;padding-bottom:30px}.main-inner .column-center-inner{padding:0 15px}.main-inner .column-center-inner .section{margin:0 15px}.post{margin:0 0 25px 0}h3.post-title{font:normal normal 22px Arial,Tahoma,Helvetica,FreeSans,sans-serif;margin:.75em 0 0}.post-body{font-size:110%;line-height:1.4;position:relative}.Profile img,.Image img{padding:2px;background:#ffffff;border:1px solid #eeeeee;-moz-box-shadow:1px 1px 5px rgba(0,0,0,.1);-webkit-box-shadow:1px 1px 5px rgba(0,0,0,.1);box-shadow:1px 1px 5px rgba(0,0,0,.1)}.post-header{margin:0 0 1.5em;line-height:1.6;font-size:90%}.post-footer{margin:20px -2px 0;padding:5px 10px;color:#666666;background-color:#f9f9f9;border-bottom:1px solid #eeeeee;line-height:1.6;font-size:90%}.section-columns td.columns-cell{border-left:1px solid #eeeeee}.blog-pager{background:transparent none no-repeat scroll top center}.blog-pager-older-link,.home-link,.blog-pager-newer-link{background-color:#ffffff;padding:5px}.footer-outer{border-top:0 dashed #bbbbbb}--><!--body{min-width:960px}.content-outer,.content-fauxcolumn-outer{min-width:960px;max-width:960px}.main-inner .columns{padding-left:0;padding-right:310px}.main-inner .fauxcolumn-center-outer{left:0;right:310px}.main-inner .fauxcolumn-left-outer{width:0}.main-inner .fauxcolumn-right-outer{width:310px}.main-inner .column-left-outer{width:0;right:100%;margin-left:-0}.main-inner .column-right-outer{width:310px;margin-right:-310px}--></style>
<noscript><link href="https://www.blogger.com/dyn-css/authorization.css?targetBlogID=8184237816669520763&amp;zx=d59b377b-a436-4b46-a15c-73fe7f07228c" rel="stylesheet"></noscript>
<meta name=google-adsense-platform-account content=ca-host-pub-1556223355139109>
<meta name=google-adsense-platform-domain content=blogspot.com>
<meta content=8184237816669520763 itemprop=blogId class=sf-hidden><meta content=6007133552883736143 itemprop=postId class=sf-hidden><meta content=https://www.blogger.com/profile/01023334706549710089 itemprop=url class=sf-hidden><meta content=https://blog.marcgravell.com/2018/07/pipe-dreams-part-3.html itemprop=url class=sf-hidden><link href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAQAQAAAAAAAAAAAAAAAAAAAAAAACAP2b/hUhw/2smSv9rQl3/aEhg/2A5S/9SJTP/Tx8s/0kbKP9HFyL/RRQf/0gZM/9IHj7/SRs1/0oaMf9IGC//eDFL/4lPdf9vOVn/dlp4/2hHXv9hM0T/XSo6/1YpN/9RKjT/Uigy/1IqOP9MIDH/Uxsz/1MZMv9UHTv/VRxC/3ksO/+FRmj/e1pu/3dfd/9sPU7/ZDdG/2A3RP9mNET/Zj1T/2Q7Vv9fOVP/VTBC/2czYf9sR2b/YU1e/2KPqP+BNUL/eipB/491i/+DcIP/c0dc/3JJWv9ySFz/aTxM/2ZCUv9kOlH/ZDdQ/2JSX/+b0tf/jbXA/3Fxb/9tm7D/qJ6e/5V+fv+dlZf/kImZ/3dSZf92Umj/cUte/3BLXf9uR1n/bEBa/1gpOf9XIDT/re7u/7b8+/+jr67/baG4/73MyP+0ycP/k4Cg/4Rnhf95V27/dlFn/3dRaP97VGv/dE9n/25IY/9nQ1r/VxQt/7Lp6f/k////oK2q/7v09v/K2dP/p6a2/4hci/+BZoH/fF1z/4NjeP+CYHn/glhv/3NNZ/9uQ17/bUFj/2xDYf9cQ1r/+////6e2tP/T5+j/ztPO/5hqmP+QW4f/hmuC/4VlgP+EboX/hWh7/3pebP9rQ1D/Yz5N/2hCVv9rSGT/mqKq//////+bl5P/anh2/8e6uP+WZpD/l2qL/3tHTf92QUX/dUBF/20zMv9vOjX/fEk+/2ExOv9mQkn/ZURO/4qfl///////nZyZ/4OYk//5+ff/5e3p/5d+gv99TVX/gVxn/4Vmd/98VF7/cklN/3FKTv9hMDX/aj5H/2BLS/+10sr//////5yfmP+Op6H/+Pn5/+Dm4/+QbXH/hVdk/4BaZf+JcYX/g3CD/31oeP9vSVH/Zzk+/2M6R/9iU1f/8P/8//////+LlI7/kLOs/+3y8f/a4N//jWZs/4RaZP+CX2v/fFli/4Nvgf96bID/dWd8/3Vkd/9oSV//rK+x///////+/v//6e7r/9bm5P/w9vT/3uzo/5F4ef+DVWP/e1pl/3lgbf98bIL/fW2D/3dmfP9yWXH/XENX/9vh4P///////v39///////r+Pf/8ff2/+Dq6P++wr//e1FZ/3hNW/95YHD/e2+E/3xtiP93bYX/a1ty/5ajpf///////v39//79/f/+/v7/4/bz/+709P/c5uP/zt/a/7TIwf+IeXr/c0lW/21ATf9rRFT/YkJT/3lrcP/y+Pb///////7+/v/+/v7//v7+/+b08//o8e//1OLf/8jZ1f+70c//rs7K/5y/uv+Qn5v/qKqp/9HV1f/+//////////7+/v/+/v7//v7+//7+/v/3+vr/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" rel=icon type=image/x-icon><style>.sf-hidden{display:none!important}</style><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style></head>
<body class=variant-bold>
<div class="navbar section" id=navbar><div class="widget Navbar" data-version=1 id=Navbar1>
<div id=navbar-iframe-container><iframe ng-non-bindable frameborder=0 hspace=0 marginheight=0 marginwidth=0 scrolling=no tabindex=0 vspace=0 width=100% id=navbar-iframe name=navbar-iframe sandbox="allow-popups allow-top-navigation allow-top-navigation-by-user-activation" srcdoc="<!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01//EN&quot; &quot;http://www.w3.org/TR/html4/strict.dtd&quot;> <html dir=ltr><meta charset=utf-8><style>:root{--sf-img-1: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAAECAYAAABsgwTvAAAAPElEQVR42nXMsQ0AIAwDQe/kWbL/BqwQSIFALznSF3FxqlqdOidmu1ODJRAQQDT7xUSIGCNETA8ilsH/3xfYtbHJD+xUAAAAAElFTkSuQmCC&quot;);--sf-img-0: url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC4AAAAUCAMAAADFhv/OAAABiVBMVEUAAAD/q3L/q3L/q3L/q3L/q3JmZmZoaGhubm5wcHBycnJ0dHR4eHh6enqCgoKEhISGhoaIiIiKioqOjo6QkJCSkpKYmJiampqenp6lpaWmpqapqamqqqqrq6usrKytra2urq6vr6+zs7O0tLS1tbW2tra3t7e5ubm6urq7u7u+vr6/v7/BwcHDw8PHx8fJycnLy8vQ0NDR0dHT09PU1NTV1dXW1tbY2Njb29vc3Nzd3d3f39/g4ODh4eHi4uLj4+Pl5eXm5ubn5+fp6ent7e3u7u7v7+/x8fHz8/P19fX29vb39/f5+fn6+vr7+/v8/Pz9/f3/q3L/rnf/sHr/sXv/tIH/tYP/toT/toX/uIf/vI//wpn/w5r/xJv/xJ3/xZ3/xZ7/xp//x6D/yaT/0rT/07X/1bn/2L3/2b//2cD/28L/3cb/38r/5NH/5NL/5tX/6Nj/7+T/8OX/8ej/9Oz/9O3/9e7/9vD/9vH/9/L/+PT/+vb/+/j/+/n//Pv//fv//fz//v3///9gKGHcAAAABnRSTlMADHh53+GPUDoCAAABq0lEQVQYGXXBCVcSYRQG4Jftw4Bqsig/GpBq0qZstE0JRW0ZSgbFW9m+b7ZamZCWmt1f3p3J5hwPzvMAs2NWsVQeduHjESOTzfV7ELFEinZIJWKYO1cwrYFj2q4DYDu9x+jdq/JNAHHqEsdY4URtDq6jT3vASHp/leGZ6jADSeqShHW0BtE4pa8ARk8Vgg+pqwDtAkWrBd+ongAyBsPnqApAvoVP3zfWV94/pH9QGkDgsp4Esr0IXFDjAImFXxzYekABlMsuRMvRk0Au50GwqcYBEh+ZN9rtTeYlCmBYOzNAq1o8fgPoVyYDfCmzbx4gscx8n+gF808KwLW1PVpxSoXBOuDlVd45b2bTB5sAiTXmL4uLX5n5zWsSQP2MFkWt7RmgeUSJjFJ5BolVDv0hAcCbnqhNXRvS2roJ8HSlWrvep5TBJH5waJME/msO6ZMNbOM+dYBJdJif3xWPfvM6CYQaF12E+KwHEt+Y3z57+uTxqy1eJYFoJN5xaIkEopG4vcLb1u6RQDTy3fmw3Ol02p9f3iIfotEuEC1JXZKIFqcucUSLJVK0QyoR+wtEprA0cDOepAAAAABJRU5ErkJggg==&quot;)}body{padding:0;margin:0}#b-navbar{white-space:nowrap;color:#444;height:29px;border-bottom:1px solid #888;background:transparent;font-size:13px;font-family:Arial,Sans-serif;position:relative}#b-navbar #b-navbar-bg{position:absolute;left:0;top:0;width:100%;height:30px;background-color:#fff;opacity:.4}#b-navbar .navbar-right{text-align:right;padding-right:5px}#b-navbar-controls{margin-left:.2em;height:29px}#b-navbar #b-navbar-logo{display:block;margin-right:8px;margin-left:8px;width:20px;height:20px;background:var(--sf-img-0) no-repeat -26px 0;cursor:pointer}#b-navbar #b-query-box{background-color:#fff;margin:0 .5em 0 0;border:1px solid #aaa;border-radius:3px;-moz-border-radius:3px;-webkit-border-radius:3px;padding:0 .3em}#b-navbar #b-query-icon{display:block;width:13px;height:13px;cursor:pointer;background:var(--sf-img-0) no-repeat 0 0}#b-navbar #b-query-icon:hover{background:var(--sf-img-0) no-repeat -13px 0}#b-navbar #b-query{font-size:13px;color:#000;background-color:transparent;border:none;margin:0}#b-navbar .b-link{display:inline-block;font-size:13px;vertical-align:middle;padding:2px .4em}#b-navbar .b-link{color:#333;text-decoration:none;white-space:nowrap;cursor:pointer}#b-navbar .b-link:hover{color:#55e;text-decoration:underline}#b-navbar #b-more span.arrow{background:var(--sf-img-1) no-repeat -12px;display:inline-block;width:7px;height:10px}#b-navbar #b-more:hover span.arrow{background:var(--sf-img-1) no-repeat 0}.sf-hidden{display:none!important}</style><meta http-equiv=content-security-policy content=&quot;default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:;&quot;><style>img[src=&quot;data:,&quot;],source[src=&quot;data:,&quot;]{display:none!important}</style></head>
<body class=&quot;lang_zh rb&quot; marginwidth=0 marginheight=0>
<div id=b-navbar><div id=b-navbar-bg style=z-index:-1></div>
<div id=b-navbar-fg>
<table id=b-navbar-controls cellpadding=0 cellspacing=0 border=0 width=100%><tbody><tr style=height:20px><td valign=middle width=24px><a href=https://www.blogger.com/ id=b-navbar-logo tabindex=1 title=&quot;转到 Blogger.com&quot;></a>
<div id=b-sms class=&quot;b-mobile sf-hidden&quot;></div></td>
<td valign=middle width=150px><form id=searchthis action=https://blog.marcgravell.com/search style=display:inline><div id=b-query-box><table cellpadding=0 cellspacing=0><tbody><tr><td valign=middle><input type=text id=b-query name=q tabindex=3 style=width:120px title=搜索 value></td>
<td valign=middle style=width:15px><a id=b-query-icon title=搜索此博客></a></table></div>
</form></td>
<td valign=middle nowrap class=gplus><a id=b-more class=b-link tabindex=4>更多
<span class=arrow></span></a></td>
<td class=navbar-right align=right nowrap valign=middle>
<a class=b-link href=https://www.blogger.com/home#create id=b-getorpost tabindex=8>创建博客</a>
<a class=b-link href=https://www.blogger.com/ tabindex=9>登录</a></table></div></div>
"></iframe></div>
</div></div>
<div class=body-fauxcolumns>
<div class="fauxcolumn-outer body-fauxcolumn-outer">
<div class=cap-top>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class=fauxborder-left>
<div class=fauxborder-right></div>
<div class=fauxcolumn-inner>
</div>
</div>
<div class=cap-bottom>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
</div>
<div class=content>
<div class=content-fauxcolumns>
<div class="fauxcolumn-outer content-fauxcolumn-outer">
<div class=cap-top>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class=fauxborder-left>
<div class=fauxborder-right></div>
<div class=fauxcolumn-inner>
</div>
</div>
<div class=cap-bottom>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
</div>
<div class=content-outer>
<div class="content-cap-top cap-top">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class="fauxborder-left content-fauxborder-left">
<div class="fauxborder-right content-fauxborder-right"></div>
<div class=content-inner>
<header>
<div class=header-outer>
<div class="header-cap-top cap-top">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class="fauxborder-left header-fauxborder-left">
<div class="fauxborder-right header-fauxborder-right"></div>
<div class="region-inner header-inner">
<div class="header section" id=header><div class="widget Header" data-version=1 id=Header1>
<div id=header-inner>
<div class=titlewrapper>
<h1 class=title>
<a href=https://blog.marcgravell.com/>
Code, code and more code.
</a>
</h1>
</div>
<div class=descriptionwrapper>
<p class=description><span>
</span></p>
</div>
</div>
</div></div>
</div>
</div>
<div class="header-cap-bottom cap-bottom">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
</header>
<div class=tabs-outer>
<div class="tabs-cap-top cap-top">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class="fauxborder-left tabs-fauxborder-left">
<div class="fauxborder-right tabs-fauxborder-right"></div>
<div class="region-inner tabs-inner">
<div class="tabs no-items section" id=crosscol></div>
<div class="tabs no-items section" id=crosscol-overflow></div>
</div>
</div>
<div class="tabs-cap-bottom cap-bottom">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
<div class=main-outer>
<div class="main-cap-top cap-top">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class="fauxborder-left main-fauxborder-left">
<div class="fauxborder-right main-fauxborder-right"></div>
<div class="region-inner main-inner">
<div class="columns fauxcolumns">
<div class="fauxcolumn-outer fauxcolumn-center-outer">
<div class=cap-top>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class=fauxborder-left>
<div class=fauxborder-right></div>
<div class=fauxcolumn-inner>
</div>
</div>
<div class=cap-bottom>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
<div class="fauxcolumn-outer fauxcolumn-left-outer">
<div class=cap-top>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class=fauxborder-left>
<div class=fauxborder-right></div>
<div class=fauxcolumn-inner>
</div>
</div>
<div class=cap-bottom>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
<div class="fauxcolumn-outer fauxcolumn-right-outer">
<div class=cap-top>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class=fauxborder-left>
<div class=fauxborder-right></div>
<div class=fauxcolumn-inner>
</div>
</div>
<div class=cap-bottom>
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
<div class=columns-inner>
<div class=column-center-outer>
<div class=column-center-inner>
<div class="main section" id=main><div class="widget Blog" data-version=1 id=Blog1>
<div class="blog-posts hfeed">
 <div class=date-outer>
 
<h2 class=date-header><span>Sunday, 29 July 2018</span></h2>
 <div class=date-posts>
 
<div class=post-outer>
<div class="post hentry" itemprop=blogPost itemscope itemtype=http://schema.org/BlogPosting>
<a name=6007133552883736143></a>
<h3 class="post-title entry-title" itemprop=name>
Pipe Dreams, part 3
</h3>
<div class=post-header>
<div class=post-header-line-1></div>
</div>
<div class="post-body entry-content" id=post-body-6007133552883736143 itemprop="description articleBody">
<h1><a id=user-content-pipelines---a-guided-tour-of-the-new-io-api-in-net-part-3 class=anchor aria-hidden=true href=#pipelines---a-guided-tour-of-the-new-io-api-in-net-part-3><svg class="octicon octicon-link" viewBox="0 0 16 16" version=1.1 width=16 height=16 aria-hidden=true><path fill-rule=evenodd d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Pipelines - a guided tour of the new IO API in .NET, part 3</h1>
<p>Update: please also see <a href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-31.html>part 3.1</a> for further clarifications on this post</p>
<p>Sorry, it has been longer than anticipated since <a href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-2.html rel=nofollow>part 2</a> (also: <a href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-1.html rel=nofollow>part 1</a>). A large part of the reason for that is that I've been trying to think how best to explain some of the inner guts of <a href=https://github.com/StackExchange/StackExchange.Redis><code>StackExchange.Redis</code></a> in a way that makes it easy to understand, and is useful for someone trying to learn about "pipelines", not <code>StackExchange.Redis</code>. I've also been thinking on ways to feed more practical "pipelines" usage guidance into the mix, which was something that came up <em>a lot</em> in feedback to parts 1/2.</p>
<p>In the end, I decided that the best thing to do was to step back from <code>StackExchange.Redis</code>, and use a <em>completely different example</em>, but one that faces almost all of the same challenges.</p>
<p>So, with your kind permission, I'd like to deviate from our previously advertised agenda, and instead talk about a library by my colleague <a href=https://twitter.com/haneycodes rel=nofollow>David Haney</a> - <a href=https://github.com/haneytron/simplsockets><code>SimplSockets</code></a>. What I hope to convey is a range of both the <em>reasoning</em> behind prefering pipelines, but also practical guidance that the reader can directly transfer to their own IO-based needs. In particular, I hope to discuss:</p>
<ul>
<li>different ways to pass chunks of data between APIs</li>
<li>working effectively with the array-pool</li>
<li><code>async</code>/<code>await</code> optimization in the context of libraries</li>
<li>practical real-world examples of writing to and reading from pipelines</li>
<li>how to connect pipelines client and server types to the network</li>
<li>performance comparisons from pipelines, and tips on measuring performance</li>
</ul>
<p>I'll be walking through <em>a lot</em> of code here, but I'll also be making the "real" code available for further exploration; this also includes some things I dodn't have time to cover here, such as how to host a pipelines server inside the Kestrel server.</p>
<p>Sound good?</p>
<h2><a id=user-content-what-is-simplsockets class=anchor aria-hidden=true href=#what-is-simplsockets><svg class="octicon octicon-link" viewBox="0 0 16 16" version=1.1 width=16 height=16 aria-hidden=true><path fill-rule=evenodd d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What is <code>SimplSockets</code>?</h2>
<p>This is a network helper library designed to make it easier to implement basic client/server network comms over a socket:</p>
<ul>
<li>it implements a simple framing protocol to separate messages</li>
<li>it allows for concurrent usage over a single client, with a message queuing mechanism</li>
<li>it embeds additional data in the framing data to allow responses to be tied back to requests, to complete operations</li>
<li>out-of-order and out-of-band replies are allowed - you might send requests <code>A</code>, <code>B</code>, <code>C</code> - and get the responses <code>A</code>, <code>C</code>, <code>D</code>, <code>B</code> - i.e. two of the responses came in the opposite order (presumably <code>B</code> took longer to execute), and <code>D</code> came from the server unsolicited (broadcasts, etc)</li>
<li>individual messages are always complete in a single frame - there is no frame splitting</li>
<li>in terms of API surface: everything is synchronous and <code>byte[]</code> based; for example the client has a <code>byte[] SendReceive(byte[])</code> method that sends a payload and blocks until the corresponding response is received, and there is a <code>MessageReceived</code> event for unsolicited messages that exposes a <code>byte[]</code></li>
<li>the server takes incoming requests via the same <code>MessageReceived</code> event, and can (if required, not always) post replies via a <code>Reply(byte[], ...)</code> method that also takes the incoming message (for pairing) - and has a <code>Broadcast(byte[])</code> method for sending a message to all clients</li>
<li>there are some other nuances like heartbeats, but; that's probably enough</li>
</ul>
<p>So; we've probably got enough there to start talking about real-world - and very common - scenarios in network code, and we can use that to start thinking about how "pipelines" makes our life easier.</p>
<p>Also an important point: anything I say below is not meant to be critical of <code>SimplSockets</code> - rather, it is to acknowledge that it was written when a <em>lot</em> of pieces like "pipelines" and <code>async</code>/<code>await</code> <em>didn't exist</em> - so it is more an exploration into how we <em>could</em> implement this differently with today's tools.</p>
<h2><a id=user-content-first-things-first-we-need-to-think-about-our-exchange-types class=anchor aria-hidden=true href=#first-things-first-we-need-to-think-about-our-exchange-types><svg class="octicon octicon-link" viewBox="0 0 16 16" version=1.1 width=16 height=16 aria-hidden=true><path fill-rule=evenodd d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>First things first: we need to think about our exchange types</h2>
<p>The first question I have here is - for received messages in particular: "how should we expose this data to consumers?". By this I mean: <code>SimplSockets</code> went with <code>byte[]</code> as the exchange type; can we improve on that? Unsurprisingly: yes. There are many approaches we can use here.</p>
<ol>
<li>at one extreme, we can stick with <code>byte[]</code> - i.e. allocate a standalone copy of the data, that we can hand to the user; simple to work with, and very safe (nobody else sees that array - no risk of confusion), but it comes at the cost of allocations and copy time.</li>
<li>at the other extreme, we can use zero-copy - and stick with <code>ReadOnlySequence&lt;byte&gt;</code> - this means we're consuming the non-contiguous buffers <em>in the pipe itself</em>; this is <em>fast</em>, but somewhat limiting - we can't <em>hand that out</em>, because once we <code>Advance</code> the pipe: that data is going to be recycled. This might be a good option for strictly controlled server-side processing (where the data never escapes the request context)</li>
<li>as an extension of <code>2</code>, we could move the <em>payload</em> parsing code into the library (based on the live <code>ReadOnlySequence&lt;byte&gt;</code>), just exposing the <em>deconstructed</em> data, perhaps using custom <code>struct</code>s that map to the scenario; efficient, but requires lots more knowledge of the contents than a general message-passing API allows; this might be a good option if you can pair the library with a serializer that accepts input as <code>ReadOnlySequence&lt;byte&gt;</code>, though - allowing the serializer to work on the data without any copies</li>
<li>we could return a <code>Memory&lt;byte&gt;</code> to a copy of the data, perhaps using an oversized <code>byte[]</code> from the <code>ArrayPool&lt;byte&gt;.Shared</code> pool; but it isn't necessarily obvious to the consumer that they should return it to the pool (and indeed: getting a <code>T[]</code> array back from a <code>Memory&lt;T&gt;</code> is an advanced and "unsafe" operation - not all <code>Memory&lt;T&gt;</code> is based on <code>T[]</code> - so we <em>really</em> shouldn't encourage users to try)</li>
<li>we could compromise by returning something that <em>provides</em> a <code>Memory&lt;byte&gt;</code> (or <code>Span&lt;byte&gt;</code> etc), but which makes it <em>very obvious</em> via a well-known API that the user is meant to do something when they're done with it - i.e. <code>IDisposable</code> / <code>using</code> - and have the exchange-type <em>itself</em> return things to the pool when <code>Dispose()</code> is called</li>
</ol>
<p>In the context of a general purpose messaging API, I think that <code>5</code> is a reasonable option - it means the caller <em>can</em> store the data for some period while they work with it, without jamming the pipe, while still allowing us to make good use of the array pool. And if someone forgets the <code>using</code>, it is <em>less efficient</em>, but nothing will actually explode - it just means it'll tend to run a bit more like option <code>1</code>. But: this decision of exchange types needs careful consideration for your scenario. The <code>StackExchange.Redis</code> client uses option <code>3</code>, handing out deconstructed data; I also have a fake redis <em>server</em> using the <code>StackExchange.Redis</code> framing code, which uses option <code>2</code> - never allowing live escape a request context. You need to take time in considering your exchange types, because it is basically impossible to change this later!</p>
<blockquote>
<p>As a pro tip for option <code>2</code> (using live <code>ReadOnlySequence&lt;byte&gt;</code> data and not letting it escape the context - zero-copy for maxiumum efficiency), one way to <em>guarantee</em> this is to wrap the buffer in a domain-specific <code>ref struct</code> before handing it to the code that needs to consume it. It is impossible to store a <code>ref struct</code>, which includes holding onto it in an <code>async</code>/<code>await</code> context, and includes basic reflection (since that requires "boxing", and you cannot "box" a <code>ref struct</code>) - so you have confidence that when the method completes, they no longer have indirect access to the data.</p>
</blockquote>
<p>But, let's assume we're happy with option <code>5</code> (<em>for this specific scenario</em> - there is no general "here's the option you should use", except: not <code>1</code> if you can help it). What might that look like? It turns out that this intent is already desribed in the framework, as <code>System.Buffers.IMemoryOwner&lt;T&gt;</code>:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>public</span> <span class=pl-k>interface</span> <span class=pl-en>IMemoryOwner</span>&lt;<span class=pl-en>T</span>&gt; : <span class=pl-en>IDisposable</span>
{
    <span class=pl-en>Memory</span>&lt;<span class=pl-en>T</span>&gt; <span class=pl-smi>Memory</span> { <span class=pl-k>get</span>; }
}</pre></div>
<p>We can then implement this to put our leased arrays back into the array-pool when disposed, taking care to be thread-safe so that if it is disposed twice, we don't put the array into the pool twice (very bad):</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>private</span> <span class=pl-k>sealed</span> <span class=pl-k>class</span> <span class=pl-en>ArrayPoolOwner</span>&lt;<span class=pl-en>T</span>&gt; : <span class=pl-en>IMemoryOwner</span>&lt;<span class=pl-en>T</span>&gt;
{
    <span class=pl-k>private</span> <span class=pl-k>readonly</span> <span class=pl-k>int</span> <span class=pl-smi>_length</span>;
    <span class=pl-k>private</span> <span class=pl-en>T</span>[] <span class=pl-smi>_oversized</span>;

    <span class=pl-k>internal</span> <span class=pl-en>ArrayPoolOwner</span>(<span class=pl-en>T</span>[] <span class=pl-smi>oversized</span>, <span class=pl-k>int</span> <span class=pl-smi>length</span>)
    {
        <span class=pl-smi>_length</span> <span class=pl-k>=</span> <span class=pl-smi>length</span>;
        <span class=pl-smi>_oversized</span> <span class=pl-k>=</span> <span class=pl-smi>oversized</span>;                
    }

    <span class=pl-k>public</span> <span class=pl-en>Memory</span>&lt;<span class=pl-en>T</span>&gt; <span class=pl-smi>Memory</span> <span class=pl-k>=&gt;</span> <span class=pl-k>new</span> <span class=pl-en>Memory</span>&lt;<span class=pl-en>T</span>&gt;(<span class=pl-en>GetArray</span>(), <span class=pl-c1>0</span>, <span class=pl-smi>_length</span>);

    <span class=pl-k>private</span> <span class=pl-en>T</span>[] <span class=pl-en>GetArray</span>() <span class=pl-k>=&gt;</span>
        <span class=pl-smi>Interlocked</span>.<span class=pl-en>CompareExchange</span>(<span class=pl-k>ref</span> <span class=pl-smi>_oversized</span>, <span class=pl-c1>null</span>, <span class=pl-c1>null</span>)
        <span class=pl-k>??</span> <span class=pl-k>throw</span> <span class=pl-k>new</span> <span class=pl-en>ObjectDisposedException</span>(<span class=pl-en>ToString</span>());

    <span class=pl-k>public</span> <span class=pl-k>void</span> <span class=pl-en>Dispose</span>()
    {
        <span class=pl-k>var</span> <span class=pl-smi>arr</span> <span class=pl-k>=</span> <span class=pl-smi>Interlocked</span>.<span class=pl-en>Exchange</span>(<span class=pl-k>ref</span> <span class=pl-smi>_oversized</span>, <span class=pl-c1>null</span>);
        <span class=pl-k>if</span> (<span class=pl-smi>arr</span> <span class=pl-k>!=</span> <span class=pl-c1>null</span>) <span class=pl-smi>ArrayPool</span>&lt;<span class=pl-en>T</span>&gt;.<span class=pl-smi>Shared</span>.<span class=pl-en>Return</span>(<span class=pl-smi>arr</span>);
    }
}</pre></div>
<p>The key point here is in <code>Dispose()</code>, where it swaps out the array field (using <code>Interlocked.Exchange</code>), and puts the array back into the pool. Once we've done this, subsequent calls to <code>.Memory</code> will fail, and calls to <code>Dispose()</code> will do nothing.</p>
<p>Some important things to know about the array pool:</p>
<ol>
<li>the arrays it gives you are often <em>oversized</em> (so that it can give you a larger array if it doesn't have one in exactly your size, but it has a larger one ready to go). This means we need to track the <em>expected</em> length (<code>_length</code>), and use that when constructing <code>.Memory</code>.</li>
<li>the array <em>is not zeroed upon fetch</em> - it can contain garbage. In our case, this isn't a problem because (below) we are <em>immediately</em> going to overwrite it with the data we want to represent, so the external caller will never see this, but <em>in the general case</em>, you might want to consider a: should I zero the contents on behalf of the receiver before giving it to them?, and b: is my data sensitive such that I don't want to accidentally leak it into the pool? (there is an existing "zero when <em>returning</em> to the pool" option in the array-pool, for this reason)</li>
</ol>
<p>As a side note, I wonder whether the above concept might be a worthy addition inside the framework itself, for usage directly from <code>ArrayPool&lt;T&gt;</code> - i.e. a method like <code>IMemoryOwner&lt;T&gt; RentOwned(int length)</code> alongside <code>T[] Rent(int minimumLength)</code> - perhaps with the additions of flags for "zero upon fetch" and "zero upon return".</p>
<p>The idea here is that passing an <code>IMemoryOwner&lt;T&gt;</code> expresses a transfer of ownership, so a typical usage might be:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>void</span> <span class=pl-en>DoSomethingWith</span>(<span class=pl-en>IMemoryOwner</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>data</span>)
{
    <span class=pl-k>using</span> (<span class=pl-smi>data</span>)
    {
        <span class=pl-c><span class=pl-c>//</span> ... other things here ...</span>
        <span class=pl-en>DoTheThing</span>(<span class=pl-smi>data</span>.<span class=pl-smi>Memory</span>);
    }
    <span class=pl-c><span class=pl-c>//</span> ... more things here ...</span>
}</pre></div>
<p>The caller doesn't need to know about the implementation details (array-pool, etc). Note that we still have to allocate a <em>small</em> object to represent this, but this is still hugely preferable to allocating a large <code>byte[]</code> buffer each time, for our safety.</p>
<p>As a caveat, we should note that a badly written consumer could store the <code>.Memory</code> somewhere, which would lead to undefined behaviour after it has been disposed; or they could use <code>MemoryMarshal</code> to get an array from the memory. If we <em>really needed to prevent these problems</em>, we could do so by implementing a custom <code>MemoryManager&lt;T&gt;</code> (most likely, by making <code>ArrayPoolOwner&lt;T&gt; : MemoryManager&lt;T&gt;</code>, since <code>MemoryManager&lt;T&gt; : IMemoryOwner&lt;T&gt;</code>). We could then make <code>.Span</code> fail just like <code>.Memory</code> does above, and we could prevent <code>MemoryMarshal</code> from being able to obtain the underlying array. It is almost certainly overkill here, but it is useful to know that this option exists, for more extreme scenarios.</p>
<p>At this point you're probably thinking "wow, Marc, you're really over-thinking this - just give them the data", but: getting the exchange types right is probably the single most important design decision you have to make, so: this bit matters!</p>
<p>OK, so how would we populate this? Fortunately, that is pretty simple, as <code>ReadOnlySequence&lt;T&gt;</code> has a very handy <code>CopyTo</code> method that does all the heavy lifting:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>public</span> <span class=pl-k>static</span> <span class=pl-en>IMemoryOwner</span>&lt;<span class=pl-en>T</span>&gt; <span class=pl-en>Lease</span>&lt;<span class=pl-en>T</span>&gt;(
    <span class=pl-k>this</span> <span class=pl-en>ReadOnlySequence</span>&lt;<span class=pl-en>T</span>&gt; <span class=pl-smi>source</span>)
{
    <span class=pl-k>if</span> (<span class=pl-smi>source</span>.<span class=pl-smi>IsEmpty</span>) <span class=pl-k>return</span> <span class=pl-en>Empty</span>&lt;<span class=pl-en>T</span>&gt;();

    <span class=pl-k>int</span> <span class=pl-smi>len</span> <span class=pl-k>=</span> <span class=pl-k>checked</span>((<span class=pl-k>int</span>)<span class=pl-smi>source</span>.<span class=pl-smi>Length</span>);
    <span class=pl-k>var</span> <span class=pl-smi>arr</span> <span class=pl-k>=</span> <span class=pl-smi>ArrayPool</span>&lt;<span class=pl-en>T</span>&gt;.<span class=pl-smi>Shared</span>.<span class=pl-en>Rent</span>(<span class=pl-smi>len</span>);
    <span class=pl-smi>source</span>.<span class=pl-en>CopyTo</span>(<span class=pl-smi>arr</span>);
    <span class=pl-k>return</span> <span class=pl-k>new</span> <span class=pl-en>ArrayPoolOwner</span>&lt;<span class=pl-en>T</span>&gt;(<span class=pl-smi>arr</span>, <span class=pl-smi>len</span>);
}</pre></div>
<p>This shows how we can use <code>ArrayPool&lt;T&gt;</code> to obtain a (possibly oversized) array that we can use to hold a <em>copy</em> of the data; once we've copied it, we can hand the <em>copy</em> to a consumer to use however they need (and being a flat vector here makes it simple to consume), while the network code can advance the pipe and discard / re-use the buffers. When they <code>Dispose()</code> it, it goes back in the pool, and everyone is happy.</p>
<h2><a id=user-content-starting-the-base-api class=anchor aria-hidden=true href=#starting-the-base-api><svg class="octicon octicon-link" viewBox="0 0 16 16" version=1.1 width=16 height=16 aria-hidden=true><path fill-rule=evenodd d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Starting the base API</h2>
<p>There is a <em>lot</em> of overlap in the code between a client and server; both need thread-safe mechanisms to write data, and both need some kind of read-loop to check for received data; but what <em>happens</em> is different. So - it sounds like a a base-class might be useful; let's start with a skeleton API that let's us hand in a pipe (or two: recall that an <code>IDuplexPipe</code> is actually the ends of two <em>different</em> pipes - <code>.Input</code> and <code>.Output</code>):</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>public</span> <span class=pl-k>abstract</span> <span class=pl-k>class</span> <span class=pl-en>SimplPipeline</span> : <span class=pl-en>IDisposable</span>
{
    <span class=pl-k>private</span> <span class=pl-en>IDuplexPipe</span> <span class=pl-smi>_pipe</span>;
    <span class=pl-k>protected</span> <span class=pl-en>SimplPipeline</span>(<span class=pl-en>IDuplexPipe</span> <span class=pl-smi>pipe</span>)
        <span class=pl-k>=&gt;</span> <span class=pl-smi>_pipe</span> <span class=pl-k>=</span> <span class=pl-smi>pipe</span>;

    <span class=pl-k>public</span> <span class=pl-k>void</span> <span class=pl-en>Dispose</span>() <span class=pl-k>=&gt;</span> <span class=pl-en>Close</span>();
    <span class=pl-k>public</span> <span class=pl-k>void</span> <span class=pl-en>Close</span>() {<span class=pl-c><span class=pl-c>/*</span> burn the pipe<span class=pl-c>*/</span></span>}
}</pre></div>
<p>The first thing we need after this is some mechanism to send a message in a thread-safe way that doesn't block the caller unduly. The way <code>SimplSockets</code> handles this (and also how <code>StackExchange.Redis</code> v1 works) is to have a <em>message queue</em> of messages that <em>have not yet been written</em>. When the caller calls <code>Send</code>, the messages is added to the queue (synchronized, etc), and will <em>at some point</em> be dequeued and written to the socket. This helps with perceived performance and can help avoid packet fragmentation in some scenarios, <em>but</em>:</p>
<ul>
<li>it has a lot of moving parts</li>
<li>it duplicates something that "pipelines" already provides</li>
</ul>
<p>For the latter, specifically: the pipe <strong>is the queue</strong>; meaning: we <em>already have</em> a buffer of data between the actual output. Adding a <em>second</em> queue is just duplicating this and retaining complexity, so: the second major design change we can make is: <em>throw away the unsent queue</em>; just write to the pipe (synchronized, etc), and let the pipe worry about the rest. One slight consequence of this is that the v1 code had a concept of prioritising messages that are expecting a reply - essentially queue-jumping. By treating the pipe as the outbound queue we <em>lose this ability</em>, but in reality this is unlikely to make a huge difference, so I'm happy to lose it. For very similar reasons, <code>StackExchange.Redis</code> v2 loses the concept of <code>CommandFlags.HighPriority</code>, which is this exact same queue-jumping idea. I'm not concerned by this.</p>
<p>We also need to consider the <em>shape</em> of this API, to allow a server or client to add a messagee</p>
<ul>
<li>we don't necessarily want to be synchronous; we don't need to block while waiting to access to write to the pipe, or while waiting for a response from the server</li>
<li>we might want to expose alternate APIs for whether the caller is simply giving us memory to write (<code>ReadOnlyMember&lt;byte&gt;</code>), or <em>giving us owneship</em> of the data, for us to clean up when we've written it (<code>IMemoryOwner&lt;byte&gt;</code>)</li>
<li>let's assume that write and read are decoupled - we don't want to worry about the issues of response messages here</li>
</ul>
<p>So; putting that together, I quite like:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>protected</span> <span class=pl-k>async</span> <span class=pl-en>ValueTask</span> <span class=pl-en>WriteAsync</span>(
    <span class=pl-en>IMemoryOwner</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>payload</span>, <span class=pl-k>int</span> <span class=pl-smi>messageId</span>)
{
    <span class=pl-k>using</span> (<span class=pl-smi>payload</span>)
    {
        <span class=pl-k>await</span> <span class=pl-en>WriteAsync</span>(<span class=pl-smi>payload</span>.<span class=pl-smi>Memory</span>, <span class=pl-smi>messageId</span>);
    }
}
<span class=pl-k>protected</span> <span class=pl-en>ValueTask</span> <span class=pl-en>WriteAsync</span>(
    <span class=pl-en>ReadOnlyMemory</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>payload</span>, <span class=pl-k>int</span> <span class=pl-smi>messageId</span>);</pre></div>
<p>Here we're giving the caller the conveninence of passing us either an <code>IMemoryOwner&lt;byte&gt;</code> (which we then dispose correctly), or a <code>ReadOnlyMemory&lt;byte&gt;</code> if they don't need to convery ownership.</p>
<p>The <code>ValueTask</code> makes sense because a write <em>to a pipe</em> is often synchronous; we <em>probably</em> won't be contested for the single-writer access, and the only async part of writing to a pipe is flushing <em>if the pipe is backed up</em> (flushing is very often always synchronous). The <code>messageId</code> is the additional metadata in the frame header that lets us pair replies later. We'll worry about what it <em>is</em> in a bit.</p>
<h2><a id=user-content-writes-and-wrongs class=anchor aria-hidden=true href=#writes-and-wrongs><svg class="octicon octicon-link" viewBox="0 0 16 16" version=1.1 width=16 height=16 aria-hidden=true><path fill-rule=evenodd d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Writes and wrongs</h2>
<p>So; let's implement that. The first thing we need is guaranteed single-writer access. It would be tempting to use a <code>lock</code>, but <code>lock</code> <em>doesn't play well with <code>async</code></em> (<a href=https://twitter.com/marcgravell/status/1023176337652109312 rel=nofollow>even if you don't screw it up</a>). Because the flush <em>may</em> be async, the continuation could come back on another thread, so we need an <code>async</code>-compatible locking primitive; <code>SemaphoreSlim</code> should suffice.</p>
<p>Next, I'm going to go off on one of my wild tangents. Premise:</p>
<blockquote>
<p>In general, application code should be optimized for readability; library code should be optimized for performance.</p>
</blockquote>
<p>You may or may not agree with this, but it is the general guidance that I code by. What I mean by this is that <em>library</em> code tends to have a <em>single focused purpose</em>, often being maintained by someone whose experience may be "deep but not necessarily wide"; your mind is focusing on that one area, and it is OK to go to bizarre lengths to optimize the code. Conversely, <em>application</em> code tends to involve a lot more plumbing of <em>different</em> concepts - "wide but not necessarily deep" (the depth being hidden in the various libraries). Application code often has more complex and unpredictable interactions, so the focus should be on maintainable and "obviously right".</p>
<p>Basically, my point here is that I tend to focus a lot on optimizations that you wouldn't normally put into application code, because <em>I know from experience and extensive benchmarking</em> that they <em>really matter</em>. So... I'm going to do some things that might look odd, and I want you to take that journey with me.</p>
<p>Let's start with the "obviously right" implementation:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>private</span> <span class=pl-k>readonly</span> <span class=pl-smi>SemaphoreSlim</span> <span class=pl-smi>_singleWriter</span>
    <span class=pl-k>=</span> <span class=pl-k>new</span> <span class=pl-en>SemaphoreSlim</span>(<span class=pl-c1>1</span>);
<span class=pl-k>protected</span> <span class=pl-k>async</span> <span class=pl-en>ValueTask</span> <span class=pl-en>WriteAsync</span>(
    <span class=pl-en>ReadOnlyMemory</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>payload</span>, <span class=pl-k>int</span> <span class=pl-smi>messageId</span>)
{
    <span class=pl-k>await</span> <span class=pl-smi>_singleWriter</span>.<span class=pl-en>WaitAsync</span>();
    <span class=pl-k>try</span>
    {
        <span class=pl-en>WriteFrameHeader</span>(<span class=pl-smi>writer</span>, <span class=pl-smi>payload</span>.<span class=pl-smi>Length</span>, <span class=pl-smi>messageId</span>);
        <span class=pl-k>await</span> <span class=pl-smi>writer</span>.<span class=pl-en>WriteAsync</span>(<span class=pl-smi>payload</span>);
    }
    <span class=pl-k>finally</span>
    {
        <span class=pl-smi>_singleWriter</span>.<span class=pl-en>Release</span>();
    }
}</pre></div>
<p>This <code>await</code>s single-writer access to the pipe, writes the frame header using <code>WriteFrameHeader</code> (which we'll show in a bit), then drops the <code>payload</code> using the framework-provided <code>WriteAsync</code> method, noting that this includes the <code>FlushAsync</code> as well. There's nothing <em>wrong</em> with this code, but... it does involve unnecessary state machine plumbing in the <strong>most likely case</strong> - i.e. where everything completes synchronously (the writer is not contested, and the pipe is not backed up). We can tweak this code by asking:</p>
<ul>
<li>can I get the single-writer access uncontested?</li>
<li>was the flush synchronous?</li>
</ul>
<p>Consider, instead - making the method we just wrote <code>private</code> and renaming it to <code>WriteAsyncSlowPath</code>, and adding a <strong>non-<code>async</code></strong> method instead:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>protected</span> <span class=pl-en>ValueTask</span> <span class=pl-en>WriteAsync</span>(
    <span class=pl-en>ReadOnlyMemory</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>payload</span>, <span class=pl-k>int</span> <span class=pl-smi>messageId</span>)
{
    <span class=pl-c><span class=pl-c>//</span> try to get the conch; if not, switch to async</span>
    <span class=pl-k>if</span> (<span class=pl-k>!</span><span class=pl-smi>_singleWriter</span>.<span class=pl-en>Wait</span>(<span class=pl-c1>0</span>))
        <span class=pl-k>return</span> <span class=pl-en>WriteAsyncSlowPath</span>(<span class=pl-smi>payload</span>, <span class=pl-smi>messageId</span>);
    <span class=pl-k>bool</span> <span class=pl-smi>release</span> <span class=pl-k>=</span> <span class=pl-c1>true</span>;
    <span class=pl-k>try</span>
    {
        <span class=pl-en>WriteFrameHeader</span>(<span class=pl-smi>writer</span>, <span class=pl-smi>payload</span>.<span class=pl-smi>Length</span>, <span class=pl-smi>messageId</span>);
        <span class=pl-k>var</span> <span class=pl-smi>write</span> <span class=pl-k>=</span> <span class=pl-smi>writer</span>.<span class=pl-en>WriteAsync</span>(<span class=pl-smi>payload</span>);
        <span class=pl-k>if</span> (<span class=pl-smi>write</span>.<span class=pl-smi>IsCompletedSuccessfully</span>) <span class=pl-k>return</span> <span class=pl-smi>default</span>;
        <span class=pl-smi>release</span> <span class=pl-k>=</span> <span class=pl-c1>false</span>;
        <span class=pl-k>return</span> <span class=pl-en>AwaitFlushAndRelease</span>(<span class=pl-smi>write</span>);
    }
    <span class=pl-k>finally</span>
    {
        <span class=pl-k>if</span> (<span class=pl-smi>release</span>) <span class=pl-smi>_singleWriter</span>.<span class=pl-en>Release</span>();
    }
}
<span class=pl-k>async</span> <span class=pl-en>ValueTask</span> <span class=pl-en>AwaitFlushAndRelease</span>(
    <span class=pl-en>ValueTask</span>&lt;<span class=pl-en>FlushResult</span>&gt; <span class=pl-smi>flush</span>)
{
    <span class=pl-k>try</span> { <span class=pl-k>await</span> <span class=pl-smi>flush</span>; }
    <span class=pl-k>finally</span> { <span class=pl-smi>_singleWriter</span>.<span class=pl-en>Release</span>(); }
}</pre></div>
<p>The <code>Wait(0)</code> returns <code>true</code> <em>if and only if</em> we can take the semaphore synchronously without delay. If we can't: all bets are off, just switch to the <code>async</code> version. Note once you've gone <code>async</code>, there's no point doing any more of these "hot path" checks - you've already built a state machine (and probably boxed it): the meal is already paid for, so you might as well sit and eat.</p>
<p>However, if we <em>do</em> get the semaphore for free, we can continue and do our <em>writing</em> for free. The header is synchronous <em>anyway</em>, so our next decision is: did the <em>flush</em> complete synchronously? If it did (<code>IsCompletedSuccessfully</code>), <em>we're done</em> - away we go (<code>return default;</code>). Otherwise, we'll need to <code>await</code> the flush. Now, we can't do that from our non-<code>async</code> method, but we can write a <em>separate</em> method (<code>AwaitFlushAndRelease</code>) that takes our incomplete flush, and <code>await</code>s it. In particular, note that we only want the semaphore to be released <em>after</em> the flush has completed, hence the <code>Release()</code> in our helper method. This is also why we set <code>release</code> to <code>false</code> in the calling method, so it doesn't get released prematurely.</p>
<p>We can apply similar techniques to <em>most</em> <code>async</code> operations if we know they're going to <em>often</em> be synchronous, and it is a pattern you may wish to consider. Emphasis: it doesn't help you <em>at all</em> if the result is usually or always <em>genuinely</em> asynchronous - so: don't over-apply it.</p>
<hr>
<p>Right; so - how do we write the header? What <em>is</em> the header? <code>SimplSockets</code> defines the header to be 8 bytes composed of two little-endian 32-bit integers. The first 4 bytes contains the payload length in bytes; the second 4 bytes is the <code>messageId</code> used to correlate requests and responses. Writing this is remarkably simple:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>void</span> <span class=pl-en>WriteFrameHeader</span>(<span class=pl-en>PipeWriter</span> <span class=pl-smi>writer</span>, <span class=pl-k>int</span> <span class=pl-smi>length</span>, <span class=pl-k>int</span> <span class=pl-smi>messageId</span>)
{
    <span class=pl-k>var</span> <span class=pl-smi>span</span> <span class=pl-k>=</span> <span class=pl-smi>writer</span>.<span class=pl-en>GetSpan</span>(<span class=pl-c1>8</span>);
    <span class=pl-smi>BinaryPrimitives</span>.<span class=pl-en>WriteInt32LittleEndian</span>(
        <span class=pl-smi>span</span>, <span class=pl-smi>length</span>);
    <span class=pl-smi>BinaryPrimitives</span>.<span class=pl-en>WriteInt32LittleEndian</span>(
        <span class=pl-smi>span</span>.<span class=pl-en>Slice</span>(<span class=pl-c1>4</span>), <span class=pl-smi>messageId</span>);
    <span class=pl-smi>writer</span>.<span class=pl-en>Advance</span>(<span class=pl-c1>8</span>);
}</pre></div>
<p>You can ask a <code>PipeWriter</code> for "reasonable" sized buffers with confidence, and <code>8</code> bytes is certainly a reasonable size. The helpful framework-provided <code>BinaryPrimitives</code> type provides explicit-endian tools, perfect for network code. The first call writes <code>length</code> to the first 4 bytes of the span. After that, we need to <code>Slice</code> the span so that the second call writes to the <em>next</em> 4 bytes - and finally we call <code>Advance(8)</code> which commits our header to the pipe <em>without</em> flushing it. Normally, you might have to write lots of pieces manually, then call <code>FlushAsync</code> explicitly, but this particular protocol is a good fit for simply calling <code>WriteAsync</code> on the pipe to attach the payload, which <em>includes</em> the flush. So; putting those pieces together, we've successfully written our message to the pipe.</p>
<h2><a id=user-content-using-that-from-a-client class=anchor aria-hidden=true href=#using-that-from-a-client><svg class="octicon octicon-link" viewBox="0 0 16 16" version=1.1 width=16 height=16 aria-hidden=true><path fill-rule=evenodd d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using that from a client</h2>
<p>We have a <code>WriteAsync</code> method in the base class; now let's add a concrete client class and start hooking pieces together. Consider:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>public</span> <span class=pl-k>class</span> <span class=pl-en>SimplPipelineClient</span> : <span class=pl-en>SimplPipeline</span>
{
    <span class=pl-k>public</span> <span class=pl-k>async</span> <span class=pl-en>Task</span>&lt;<span class=pl-en>IMemoryOwner</span>&lt;<span class=pl-k>byte</span>&gt;&gt; <span class=pl-en>SendReceiveAsync</span>(<span class=pl-en>ReadOnlyMemory</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>message</span>)
    {
        <span class=pl-k>var</span> <span class=pl-smi>tcs</span> <span class=pl-k>=</span> <span class=pl-k>new</span> <span class=pl-en>TaskCompletionSource</span>&lt;<span class=pl-en>IMemoryOwner</span>&lt;<span class=pl-k>byte</span>&gt;&gt;();
        <span class=pl-k>int</span> <span class=pl-smi>messageId</span>;
        <span class=pl-k>lock</span> (<span class=pl-smi>_awaitingResponses</span>)
        {
            <span class=pl-smi>messageId</span> <span class=pl-k>=</span> <span class=pl-k>++</span><span class=pl-smi>_nextMessageId</span>;
            <span class=pl-k>if</span> (<span class=pl-smi>messageId</span> <span class=pl-k>==</span> <span class=pl-c1>0</span>) <span class=pl-smi>messageId</span> <span class=pl-k>=</span> <span class=pl-c1>1</span>;
            <span class=pl-smi>_awaitingResponses</span>.<span class=pl-en>Add</span>(<span class=pl-smi>messageId</span>, <span class=pl-smi>tcs</span>);
        }
        <span class=pl-k>await</span> <span class=pl-en>WriteAsync</span>(<span class=pl-smi>message</span>, <span class=pl-smi>messageId</span>);
        <span class=pl-k>return</span> <span class=pl-k>await</span> <span class=pl-smi>tcs</span>.<span class=pl-smi>Task</span>;
    }
    <span class=pl-k>public</span> <span class=pl-k>async</span> <span class=pl-en>Task</span>&lt;<span class=pl-en>IMemoryOwner</span>&lt;<span class=pl-k>byte</span>&gt;&gt; <span class=pl-en>SendReceiveAsync</span>(<span class=pl-en>IMemoryOwner</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>message</span>)
    {
        <span class=pl-k>using</span> (<span class=pl-smi>message</span>)
        {
            <span class=pl-k>return</span> <span class=pl-k>await</span> <span class=pl-en>SendReceiveAsync</span>(<span class=pl-smi>message</span>.<span class=pl-smi>Memory</span>);
        }
    }
}</pre></div>
<p>where <code>_awaitingResponses</code> is a dictionary of <code>int</code> message-ids to <code>TaskCompletionSource&lt;IMemoryOwner&lt;byte&gt;&gt;</code>. This code invents a new <code>messageId</code> (avoiding zero, which we'll use as a sentinel value), and creates a <code>TaskCompletionSource&lt;T&gt;</code> to represent our in-progress operation. Since this definitely will involve network access, there's no benefit in exposing it as <code>ValueTask&lt;T&gt;</code>, so this works well. Once we've added our placeholder for catching the reply we write our message (always do book-keeping <em>first</em>, to avoid race conditions). Finally, expose the incomplete task to the caller.</p>
<p>Note that I've implemented this the "obvious" way, but we can optimize this like we did previously, by checking if <code>WriteAsync</code> completed synchronously and simply <code>return</code>ing the <code>tcs.Task</code> without <code>await</code>ing it. Note also that <code>SimplSockets</code> used the <em>calling thread-id</em> as the message-id; this works fine in a blocking scenario, but it isn't viable when we're using <code>async</code> - but: the number is opaque to the "other end" <em>anyway</em> - all it has to do is return the same number.</p>
<h2><a id=user-content-programmed-to-receive class=anchor aria-hidden=true href=#programmed-to-receive><svg class="octicon octicon-link" viewBox="0 0 16 16" version=1.1 width=16 height=16 aria-hidden=true><path fill-rule=evenodd d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Programmed to receive</h2>
<p>That's pretty-much it for write; next we need to think about receive. As mentioned in the previous posts, there's almost always a receive <em>loop</em> - especially if we need to support out-of-band and out-of-order messages (so: we can't just read one frame immediately after writing). A basic read loop can be approximated by:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>protected</span> <span class=pl-k>async</span> <span class=pl-en>Task</span> <span class=pl-en>StartReceiveLoopAsync</span>(
   <span class=pl-en>CancellationToken</span> <span class=pl-smi>cancellationToken</span> <span class=pl-k>=</span> <span class=pl-smi>default</span>)
{
   <span class=pl-k>try</span>
   {
       <span class=pl-k>while</span> (<span class=pl-k>!</span><span class=pl-smi>cancellationToken</span>.<span class=pl-smi>IsCancellationRequested</span>)
       {
           <span class=pl-k>var</span> <span class=pl-smi>readResult</span> <span class=pl-k>=</span> <span class=pl-k>await</span> <span class=pl-smi>reader</span>.<span class=pl-en>ReadAsync</span>(<span class=pl-smi>cancellationToken</span>);
           <span class=pl-k>if</span> (<span class=pl-smi>readResult</span>.<span class=pl-smi>IsCanceled</span>) <span class=pl-k>break</span>;

           <span class=pl-k>var</span> <span class=pl-smi>buffer</span> <span class=pl-k>=</span> <span class=pl-smi>readResult</span>.<span class=pl-smi>Buffer</span>;

           <span class=pl-k>var</span> <span class=pl-smi>makingProgress</span> <span class=pl-k>=</span> <span class=pl-c1>false</span>;
           <span class=pl-k>while</span> (<span class=pl-en>TryParseFrame</span>(<span class=pl-k>ref</span> <span class=pl-smi>buffer</span>, <span class=pl-k>out</span> <span class=pl-k>var</span> <span class=pl-smi>payload</span>, <span class=pl-k>out</span> <span class=pl-k>var</span> <span class=pl-smi>messageId</span>))
           {
               <span class=pl-smi>makingProgress</span> <span class=pl-k>=</span> <span class=pl-c1>true</span>;
               <span class=pl-k>await</span> <span class=pl-en>OnReceiveAsync</span>(<span class=pl-smi>payload</span>, <span class=pl-smi>messageId</span>);
           }
           <span class=pl-smi>reader</span>.<span class=pl-en>AdvanceTo</span>(<span class=pl-smi>buffer</span>.<span class=pl-smi>Start</span>, <span class=pl-smi>buffer</span>.<span class=pl-smi>End</span>);
           <span class=pl-k>if</span> (<span class=pl-k>!</span><span class=pl-smi>makingProgress</span> <span class=pl-k>&amp;&amp;</span> <span class=pl-smi>readResult</span>.<span class=pl-smi>IsCompleted</span>) <span class=pl-k>break</span>;
       }
       <span class=pl-k>try</span> { <span class=pl-smi>reader</span>.<span class=pl-en>Complete</span>(); } <span class=pl-k>catch</span> { }
   }
   <span class=pl-k>catch</span> (<span class=pl-en>Exception</span> <span class=pl-smi>ex</span>)
   {
       <span class=pl-k>try</span> { <span class=pl-smi>reader</span>.<span class=pl-en>Complete</span>(<span class=pl-smi>ex</span>); } <span class=pl-k>catch</span> { }
   }
}
<span class=pl-k>protected</span> <span class=pl-k>abstract</span> <span class=pl-en>ValueTask</span> <span class=pl-en>OnReceiveAsync</span>(
   <span class=pl-en>ReadOnlySequence</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>payload</span>, <span class=pl-k>int</span> <span class=pl-smi>messageId</span>);</pre></div>
<p>Note: since we are <em>bound</em> to have an <code>async</code> delay at some point (probably immediately), we might as well just jump straight to an "obvoious" <code>async</code> implementation - we'll gain nothing from trying to be clever here. Key points to observe:</p>
<ul>
<li>we get data from the pipe (note that we <em>might</em> want to also consider <code>TryRead</code> here, but only if we are making progress - otherwise we could find ourselves in a hot loop)</li>
<li>read (<code>TryParseFrame</code>) and process (<code>OnReceiveAsync</code>) as many frames as we can</li>
<li>advance the reader to report our progress, noting that <code>TryParseFrame</code> will have updated <code>buffer.Start</code>, and since we're actively reading as many frames as we can, it is true to say that we've "inspected" to <code>buffer.End</code></li>
<li>keep in mind that the pipelines code is dealing with all the back-buffer concerns re data that we haven't consumed yet (usually a significant amount of code repeated in lots of libraries)</li>
<li>check for exit conditions - if we aren't progressing and the pipe won't get any more data, we're done</li>
<li>report when we've finished reading - through success or failure</li>
</ul>
<p>Unsurprisingly, <code>TryParseFrame</code> is largely the reverse of <code>WriteAsync</code>:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>private</span> <span class=pl-k>bool</span> <span class=pl-en>TryParseFrame</span>(
    <span class=pl-k>ref</span> <span class=pl-en>ReadOnlySequence</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>input</span>,
    <span class=pl-k>out</span> <span class=pl-en>ReadOnlySequence</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>payload</span>, <span class=pl-k>out</span> <span class=pl-k>int</span> <span class=pl-smi>messageId</span>)
{
    <span class=pl-k>if</span> (<span class=pl-smi>input</span>.<span class=pl-smi>Length</span> <span class=pl-k>&lt;</span> <span class=pl-c1>8</span>)
    {   <span class=pl-c><span class=pl-c>//</span> not enough data for the header</span>
        <span class=pl-smi>payload</span> <span class=pl-k>=</span> <span class=pl-smi>default</span>;
        <span class=pl-smi>messageId</span> <span class=pl-k>=</span> <span class=pl-smi>default</span>;
        <span class=pl-k>return</span> <span class=pl-c1>false</span>;
    }

    <span class=pl-k>int</span> <span class=pl-smi>length</span>;
    <span class=pl-k>if</span> (<span class=pl-smi>input</span>.<span class=pl-smi>First</span>.<span class=pl-smi>Length</span> <span class=pl-k>&gt;=</span> <span class=pl-c1>8</span>)
    {   <span class=pl-c><span class=pl-c>//</span> already 8 bytes in the first segment</span>
        <span class=pl-smi>length</span> <span class=pl-k>=</span> <span class=pl-en>ParseFrameHeader</span>(
            <span class=pl-smi>input</span>.<span class=pl-smi>First</span>.<span class=pl-smi>Span</span>, <span class=pl-k>out</span> <span class=pl-smi>messageId</span>);
    }
    <span class=pl-k>else</span>
    {   <span class=pl-c><span class=pl-c>//</span> copy 8 bytes into a local span</span>
        <span class=pl-en>Span</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>local</span> <span class=pl-k>=</span> <span class=pl-smi>stackalloc</span> <span class=pl-smi>byte</span>[<span class=pl-c1>8</span>];
        <span class=pl-smi>input</span>.<span class=pl-en>Slice</span>(<span class=pl-c1>0</span>, <span class=pl-c1>8</span>).<span class=pl-en>CopyTo</span>(<span class=pl-smi>local</span>);
        <span class=pl-smi>length</span> <span class=pl-k>=</span> <span class=pl-en>ParseFrameHeader</span>(
            <span class=pl-smi>local</span>, <span class=pl-k>out</span> <span class=pl-smi>messageId</span>);
    }

    <span class=pl-c><span class=pl-c>//</span> do we have the "length" bytes?</span>
    <span class=pl-k>if</span> (<span class=pl-smi>input</span>.<span class=pl-smi>Length</span> <span class=pl-k>&lt;</span> <span class=pl-smi>length</span> <span class=pl-k>+</span> <span class=pl-c1>8</span>)
    {
        <span class=pl-smi>payload</span> <span class=pl-k>=</span> <span class=pl-smi>default</span>;
        <span class=pl-k>return</span> <span class=pl-c1>false</span>;
    }

    <span class=pl-c><span class=pl-c>//</span> success!</span>
    <span class=pl-smi>payload</span> <span class=pl-k>=</span> <span class=pl-smi>input</span>.<span class=pl-en>Slice</span>(<span class=pl-c1>8</span>, <span class=pl-smi>length</span>);
    <span class=pl-smi>input</span> <span class=pl-k>=</span> <span class=pl-smi>input</span>.<span class=pl-en>Slice</span>(<span class=pl-smi>payload</span>.<span class=pl-smi>End</span>);
    <span class=pl-k>return</span> <span class=pl-c1>true</span>;
}</pre></div>
<p>First we check whether we have enough data for the frame header (8 bytes); if we don't have that - we certainly don't have a frame. Once we know we have enough bytes for the frame header, we can parse it out to find the payload length. This is a little subtle, because we need to recall that <code>ReadOnlySequence&lt;byte&gt;</code> can be <em>discontiguous</em> multiple buffers. Since we're only talking about 8 bytes, the simplest thing to do is:</p>
<ul>
<li>check whether the <em>first segment</em> has 8 bytes; if so, parse from that</li>
<li>otherwise, <code>stackalloc</code> a span (note that this doesn't need <code>unsafe</code>), copy 8 bytes from <code>input</code> into that, and parse <em>from there</em>.</li>
</ul>
<p>Once we know how much payload we're expecting, we can check whether we <em>have that too</em>; if we don't: cede back to the read loop. But if we do:</p>
<ul>
<li>our <em>actual payload</em> is the <code>length</code> bytes <em>after</em> the header - i.e. <code>input.Slice(8, length)</code></li>
<li>we want to update <code>input</code> by cutting off everything up to the end of the frame, i.e. <code>input = input.Slice(payload.End)</code></li>
</ul>
<p>This means that when we return <code>true</code>, <code>payload</code> now contains the bytes that were sent to us, as a discontiguous buffer.</p>
<p>We should also take a look at <code>ParseFrameHeader</code>, which is a close cousin to <code>WriteFrameHeader</code>:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>static</span> <span class=pl-k>int</span> <span class=pl-en>ParseFrameHeader</span>(
    <span class=pl-en>ReadOnlySpan</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>input</span>, <span class=pl-k>out</span> <span class=pl-k>int</span> <span class=pl-smi>messageId</span>)
{
    <span class=pl-k>var</span> <span class=pl-smi>length</span> <span class=pl-k>=</span> <span class=pl-smi>BinaryPrimitives</span>
            .<span class=pl-en>ReadInt32LittleEndian</span>(<span class=pl-smi>input</span>);
    <span class=pl-smi>messageId</span> <span class=pl-k>=</span> <span class=pl-smi>BinaryPrimitives</span>
            .<span class=pl-en>ReadInt32LittleEndian</span>(<span class=pl-smi>input</span>.<span class=pl-en>Slice</span>(<span class=pl-c1>4</span>));
    <span class=pl-k>return</span> <span class=pl-smi>length</span>;
}</pre></div>
<p>Once again, <code>BinaryPrimitives</code> is helping us out, and we are slicing the <code>input</code> in exactly the same way as before to get the two halves.</p>
<hr>
<p>So; we can parse frames; now we need to act upon them; here's our client implementation:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>protected</span> <span class=pl-k>override</span> <span class=pl-en>ValueTask</span> <span class=pl-en>OnReceiveAsync</span>(
    <span class=pl-en>ReadOnlySequence</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>payload</span>, <span class=pl-k>int</span> <span class=pl-smi>messageId</span>)
{
    <span class=pl-k>if</span> (<span class=pl-smi>messageId</span> <span class=pl-k>!=</span> <span class=pl-c1>0</span>)
    {   <span class=pl-c><span class=pl-c>//</span> request/response</span>
        <span class=pl-en>TaskCompletionSource</span>&lt;<span class=pl-en>IMemoryOwner</span>&lt;<span class=pl-k>byte</span>&gt;&gt; <span class=pl-smi>tcs</span>;
        <span class=pl-k>lock</span> (<span class=pl-smi>_awaitingResponses</span>)
        {
            <span class=pl-k>if</span> (<span class=pl-smi>_awaitingResponses</span>.<span class=pl-en>TryGetValue</span>(<span class=pl-smi>messageId</span>, <span class=pl-k>out</span> <span class=pl-smi>tcs</span>))
            {
                <span class=pl-smi>_awaitingResponses</span>.<span class=pl-en>Remove</span>(<span class=pl-smi>messageId</span>);
            }
        }
        <span class=pl-smi>tcs</span><span class=pl-k>?</span>.<span class=pl-en>TrySetResult</span>(<span class=pl-smi>payload</span>.<span class=pl-en>Lease</span>());
    }
    <span class=pl-k>else</span>
    {   <span class=pl-c><span class=pl-c>//</span> unsolicited</span>
        <span class=pl-smi>MessageReceived</span><span class=pl-k>?</span>.<span class=pl-en>Invoke</span>(<span class=pl-smi>payload</span>.<span class=pl-en>Lease</span>());
    }
    <span class=pl-k>return</span> <span class=pl-smi>default</span>;
}</pre></div>
<p>This code has two paths; it can be the request/response scenario, or it can be an out-of-band response message with no request. So; if we <em>have</em> a non-zero <code>messageId</code>, we check (synchronized) in our <code>_awaitingResponses</code> dictionary to see if we have a message awaiting completion. If we do, we use <code>TrySetResult</code> to complete the task (after exiting the <code>lock</code>), giving it a lease with the data from the message. Otherwise, we check whether the <code>MessageReceived</code> event is subscribed, and invoke that similarly. In both cases, the use of <code>?.</code> here means that we don't populate a leased array if nobody is listening. It will be the receiver's job to ensure the lease is disposed, as only they can know the lifetime.</p>
<h2><a id=user-content-service-please class=anchor aria-hidden=true href=#service-please><svg class="octicon octicon-link" viewBox="0 0 16 16" version=1.1 width=16 height=16 aria-hidden=true><path fill-rule=evenodd d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Service, please</h2>
<p>We need to think a little about how we orchestrate this at the server. The <code>SimplPipeline</code> base type above relates to a <em>single</em> connection - it is essentially a proxy to a socket. But servers usually have many clients. Because of that, we'll create a server type that does the <em>actual processing</em>, that internally has a client-type that is our <code>SimplPipeline</code>, and a set of connected clients; so:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>public</span> <span class=pl-k>abstract</span> <span class=pl-k>class</span> <span class=pl-en>SimplPipelineServer</span> : <span class=pl-en>IDisposable</span>
{
    <span class=pl-k>protected</span> <span class=pl-k>abstract</span> ValueTask&lt;IMemoryOwner&lt;byte&gt;&gt; 
        <span class=pl-en>OnReceiveForReplyAsync</span>(<span class=pl-en>IMemoryOwner</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>message</span>);
    
    <span class=pl-k>public</span> <span class=pl-k>int</span> <span class=pl-smi>ClientCount</span> <span class=pl-k>=&gt;</span> <span class=pl-smi>_clients</span>.<span class=pl-smi>Count</span>;
    <span class=pl-k>public</span> <span class=pl-en>Task</span> <span class=pl-en>RunClientAsync</span>(<span class=pl-en>IDuplexPipe</span> <span class=pl-smi>pipe</span>,
        <span class=pl-en>CancellationToken</span> <span class=pl-smi>cancellationToken</span> <span class=pl-k>=</span> <span class=pl-smi>default</span>)
        <span class=pl-k>=&gt;</span> <span class=pl-k>new</span> <span class=pl-en>Client</span>(<span class=pl-smi>pipe</span>, <span class=pl-k>this</span>).<span class=pl-en>RunAsync</span>(<span class=pl-smi>cancellationToken</span>);
    
    <span class=pl-k>private</span> <span class=pl-k>class</span> <span class=pl-en>Client</span> : <span class=pl-en>SimplPipeline</span>
    {
        <span class=pl-k>public</span> <span class=pl-en>Task</span> <span class=pl-en>RunAsync</span>(<span class=pl-en>CancellationToken</span> <span class=pl-smi>cancellationToken</span>)
            <span class=pl-k>=&gt;</span> <span class=pl-en>StartReceiveLoopAsync</span>(<span class=pl-smi>cancellationToken</span>);

        <span class=pl-k>private</span> <span class=pl-k>readonly</span> <span class=pl-en>SimplPipelineServer</span> <span class=pl-smi>_server</span>;
        <span class=pl-k>public</span> <span class=pl-en>Client</span>(<span class=pl-en>IDuplexPipe</span> <span class=pl-smi>pipe</span>, <span class=pl-en>SimplPipelineServer</span> <span class=pl-smi>server</span>)
            : <span class=pl-k>base</span>(<span class=pl-smi>pipe</span>) <span class=pl-k>=&gt;</span> <span class=pl-smi>_server</span> <span class=pl-k>=</span> <span class=pl-smi>server</span>;

        <span class=pl-k>protected</span> <span class=pl-k>override</span> <span class=pl-k>async</span> <span class=pl-en>ValueTask</span> <span class=pl-en>OnReceiveAsync</span>(
            <span class=pl-en>ReadOnlySequence</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>payload</span>, <span class=pl-k>int</span> <span class=pl-smi>messageId</span>)
        {
            <span class=pl-k>using</span> (<span class=pl-k>var</span> <span class=pl-smi>msg</span> <span class=pl-k>=</span> <span class=pl-smi>payload</span>.<span class=pl-en>Lease</span>())
            {
                <span class=pl-k>var</span> <span class=pl-smi>response</span> <span class=pl-k>=</span> <span class=pl-k>await</span> <span class=pl-smi>_server</span>.<span class=pl-en>OnReceiveForReplyAsync</span>(<span class=pl-smi>msg</span>);
                <span class=pl-k>await</span> <span class=pl-en>WriteAsync</span>(<span class=pl-smi>response</span>, <span class=pl-smi>messageId</span>);
            }
        }
    }
}</pre></div>
<p>So; our <em>publicly visible server type</em>, <code>SimplPipelineServer</code> has an <code>abstract</code> method for providing the implementation for <em>what we want to do with messages</em>: <code>OnReceiveForReplyAsync</code> - that takes a payload, and returns the response. Behind the scenes we have a set of clients, <code>_clients</code>, although the details of that aren't interesting.</p>
<p>We accept new clients via the <code>RunClientAsync</code> method; this might seem counter-intuitive, but the emerging architecture for pipelines servers (especially considering "Kestrel" hosts) is to let an external host deal with listening and accepting connections, and all we need to do is have something that accepts an <code>IDuplexPipe</code> and returns a <code>Task</code>. In this case, what that <em>does</em> is create a new <code>Client</code> and start the client's read loop, <code>StartReceiveLoopAsync</code>. When the client receives a message (<code>OnReceiveAsync</code>), it asks the server for a response (<code>_server.OnReceiveForReplyAsync</code>), and then writes that response back via <code>WriteAsync</code>. Note that the version of <code>OnReceiveAsync</code> shown has the consequence of meaning that we can't handle multiple overlapped messages on the same connection at the same time; the "real" version has been aggressively uglified, to check whether <code>_server.OnReceiveForReplyAsync(msg)</code> has completed synchronously; if it hasn't, then it schedules a <em>continuation</em> to perform the <code>WriteAsync</code> (also handling the disposal of <code>msg</code>), and yields to the caller. It also optimizes for the "everything is synchronous" case.</p>
<p>The only other server API we need is a broadcast:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>public</span> <span class=pl-k>async</span> <span class=pl-en>ValueTask</span>&lt;<span class=pl-k>int</span>&gt; <span class=pl-en>BroadcastAsync</span>(
    <span class=pl-en>ReadOnlyMemory</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>message</span>)
{
    <span class=pl-k>int</span> <span class=pl-smi>count</span> <span class=pl-k>=</span> <span class=pl-c1>0</span>;
    <span class=pl-k>foreach</span> (<span class=pl-k>var</span> <span class=pl-smi>client</span> <span class=pl-k>in</span> <span class=pl-smi>_clients</span>)
    {
        <span class=pl-k>try</span>
        {
            <span class=pl-k>await</span> <span class=pl-smi>client</span>.<span class=pl-smi>Key</span>.<span class=pl-en>SendAsync</span>(<span class=pl-smi>message</span>);
            <span class=pl-smi>count</span><span class=pl-k>++</span>;
        }
        <span class=pl-k>catch</span> { } <span class=pl-c><span class=pl-c>//</span> ignore failures on specific clients</span>
    }
    <span class=pl-k>return</span> <span class=pl-smi>count</span>;
}</pre></div>
<p>(again, possibly with an overload that takes <code>IMemoryOwner&lt;byte&gt;</code>)</p>
<p>where <code>SendAsync</code> is simply:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>public</span> <span class=pl-en>ValueTask</span> <span class=pl-en>SendAsync</span>(<span class=pl-en>ReadOnlyMemory</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>message</span>)
    <span class=pl-k>=&gt;</span> <span class=pl-en>WriteAsync</span>(<span class=pl-smi>message</span>, <span class=pl-c1>0</span>);</pre></div>
<h2><a id=user-content-putting-it-all-together-implementing-a-client-and-server class=anchor aria-hidden=true href=#putting-it-all-together-implementing-a-client-and-server><svg class="octicon octicon-link" viewBox="0 0 16 16" version=1.1 width=16 height=16 aria-hidden=true><path fill-rule=evenodd d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Putting it all together; implementing a client and server</h2>
<p>So how can we <em>use</em> all of this? How can we get a working client and server? Let's start with the simpler of the two, the client:</p>
<pre><code>using (var client = await SimplPipelineClient.ConnectAsync(
    new IPEndPoint(IPAddress.Loopback, 5000)))
{
    // subscribe to broadcasts
    client.MessageReceived += async msg =&gt; {
        if (!msg.Memory.IsEmpty)
            await WriteLineAsync('*', msg);
    };

    string line;
    while ((line = await Console.In.ReadLineAsync()) != null)
    {
        if (line == "q") break;

        using (var leased = line.Encode())
        {
            var response = await client.SendReceiveAsync(leased.Memory);
            await WriteLineAsync('&lt;', response);
        }     
    }
}
</code></pre>
<p><code>SimplPipelineClient.ConnectAsync</code> here just uses <code>Pipelines.Sockets.Unofficial</code> to spin up a client socket pipeline, and starts the <code>StartReceiveLoopAsync()</code> method. Taking an additional dependency on <code>Pipelines.Sockets.Unofficial</code> is vexing, but right now there is no framework-supplied client-socket API for pipelines, so: it'll do the job.</p>
<p>This code sets up a simple console client that takes keyboard input; if it receives a <code>"q"</code> it quits; otherwise it sends the message to the server (<code>Encode</code>, not shown, is just a simple text-encode into a leased buffer), and writes the response. The <code>WriteLineAsync</code> method here takes a leased buffer, decodes it, and writes the output to the console - then disposes the buffer. We also listen for unsolicited messages via <code>MessageReceived</code>, and write those to the console with a different prefix.</p>
<p>The server is a little more involved; first we need to implement a server; in this case let's simply reverse the bytes we get:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>class</span> <span class=pl-en>ReverseServer</span> : <span class=pl-en>SimplPipelineServer</span>
{
    <span class=pl-k>protected</span> <span class=pl-k>override</span> ValueTask&lt;IMemoryOwner&lt;byte&gt;&gt;
        <span class=pl-en>OnReceiveForReplyAsync</span>(<span class=pl-en>IMemoryOwner</span>&lt;<span class=pl-k>byte</span>&gt; <span class=pl-smi>message</span>)
    {
        <span class=pl-c><span class=pl-c>//</span> since the "message" outlives the response write,</span>
        <span class=pl-c><span class=pl-c>//</span> we can do an in-place reverse and hand</span>
        <span class=pl-c><span class=pl-c>//</span> the same buffer back</span>
        <span class=pl-k>var</span> <span class=pl-smi>memory</span> <span class=pl-k>=</span> <span class=pl-smi>message</span>.<span class=pl-smi>Memory</span>;
        <span class=pl-en>Reverse</span>(<span class=pl-smi>memory</span>.<span class=pl-smi>Span</span>); <span class=pl-c><span class=pl-c>//</span> details not shown</span>
        <span class=pl-k>return</span> <span class=pl-k>new</span> <span class=pl-en>ValueTask</span>&lt;<span class=pl-en>IMemoryOwner</span>&lt;<span class=pl-k>byte</span>&gt;&gt;(<span class=pl-smi>memory</span>);
    }
}</pre></div>
<p>All this does is respond to messages by returning the same payload, but backwards. And yes, I realize that since we're dealing with text, this could go horribly wrong for grapheme-clusters and/or multi-byte code-points! I never said it was a <em>useful</em> server...</p>
<p>Next up, we need a host. Kestrel (the "ASP.NET Core" server) is an excellent choice there, but implementing a Kestrel host requires introducing quite a few more concepts. But... since we already took a dependency on <code>Pipelines.Sockets.Unofficial</code> for the client, we can use that for the server host with a few lines of code:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>class</span> <span class=pl-en>SimplPipelineSocketServer</span> : <span class=pl-en>SocketServer</span>
{
    <span class=pl-k>public</span> <span class=pl-en>SimplPipelineServer</span> <span class=pl-smi>Server</span> { <span class=pl-k>get</span>; }

    <span class=pl-k>public</span> <span class=pl-en>SimplPipelineSocketServer</span>(<span class=pl-en>SimplPipelineServer</span> <span class=pl-smi>server</span>)
        <span class=pl-k>=&gt;</span> <span class=pl-smi>Server</span> <span class=pl-k>=</span> <span class=pl-smi>server</span>;

    <span class=pl-k>protected</span> <span class=pl-k>override</span> <span class=pl-en>Task</span> <span class=pl-en>OnClientConnectedAsync</span>(
        <span class=pl-en>in</span> <span class=pl-smi>ClientConnection</span> client)
        <span class=pl-k>=&gt;</span> <span class=pl-smi>Server</span>.<span class=pl-en>RunClientAsync</span>(<span class=pl-smi>client</span>.<span class=pl-smi>Transport</span>);

    <span class=pl-k>public</span> <span class=pl-k>static</span> <span class=pl-en>SimplPipelineSocketServer</span> <span class=pl-en>For</span>&lt;<span class=pl-en>T</span>&gt;()
        <span class=pl-k>where</span> <span class=pl-en>T</span> : <span class=pl-en>SimplPipelineServer</span>, <span class=pl-k>new</span>()
        <span class=pl-k>=&gt;</span> <span class=pl-k>new</span> <span class=pl-en>SimplPipelineSocketServer</span>(<span class=pl-k>new</span> <span class=pl-en>T</span>());

    <span class=pl-k>protected</span> <span class=pl-k>override</span> <span class=pl-k>void</span> <span class=pl-en>Dispose</span>(<span class=pl-k>bool</span> <span class=pl-smi>disposing</span>)
    {
        <span class=pl-k>if</span> (<span class=pl-smi>disposing</span>) <span class=pl-smi>Server</span>.<span class=pl-en>Dispose</span>();
    }
}</pre></div>
<p>The key line in here is our <code>OnClientConnectedAsync</code> method, which is how we accept new connections, simply by passing down the <code>client.Transport</code> (an <code>IDuplexPipe</code>). Hosting in Kestrel works very similarly, except you subclass <code>ConnectionHandler</code> instead of <code>SocketServer</code>, and <code>override</code> the <code>OnConnectedAsync</code> method - but there are a few more steps involved in plumbing everything together. Kestrel, however, has advantages such as supporting exotic socket APIs.</p>
<p>So, let's whack together a console that interacts with the server:</p>
<div class="highlight highlight-source-cs"><pre><span class=pl-k>using</span> (<span class=pl-en>var</span> <span class=pl-en>socket</span> <span class=pl-k>=</span>
    <span class=pl-en>SimplPipelineSocketServer</span>.<span class=pl-en>For</span>&lt;<span class=pl-en>ReverseServer</span>&gt;())
{
    <span class=pl-en>socket</span>.<span class=pl-en>Listen</span>(<span class=pl-en>new</span> <span class=pl-en>IPEndPoint</span>(<span class=pl-en>IPAddress</span>.<span class=pl-en>Loopback</span>, 5000));
    
    <span class=pl-k>string</span> <span class=pl-smi>line</span>;
    <span class=pl-k>while</span> ((<span class=pl-smi>line</span> <span class=pl-k>=</span> <span class=pl-k>await</span> <span class=pl-smi>Console</span>.<span class=pl-smi>In</span>.<span class=pl-en>ReadLineAsync</span>()) <span class=pl-k>!=</span> <span class=pl-c1>null</span>)
    {
        <span class=pl-k>if</span> (<span class=pl-smi>line</span> <span class=pl-k>==</span> <span class=pl-s><span class=pl-pds>"</span>q<span class=pl-pds>"</span></span>) <span class=pl-k>break</span>;

        <span class=pl-k>int</span> <span class=pl-smi>clientCount</span>, <span class=pl-smi>len</span>;
        <span class=pl-k>using</span> (<span class=pl-k>var</span> <span class=pl-smi>leased</span> <span class=pl-k>=</span> <span class=pl-smi>line</span>.<span class=pl-en>Encode</span>())
        {
            <span class=pl-smi>len</span> <span class=pl-k>=</span> <span class=pl-smi>leased</span>.<span class=pl-smi>Memory</span>.<span class=pl-smi>Length</span>;
            <span class=pl-smi>clientCount</span> <span class=pl-k>=</span> <span class=pl-k>await</span> <span class=pl-smi>socket</span>.<span class=pl-smi>Server</span>.<span class=pl-en>BroadcastAsync</span>(<span class=pl-smi>leased</span>.<span class=pl-smi>Memory</span>);
        }
        <span class=pl-k>await</span> <span class=pl-smi>Console</span>.<span class=pl-smi>Out</span>.<span class=pl-en>WriteLineAsync</span>(
            <span class=pl-s><span class=pl-pds>$"</span>Broadcast {<span class=pl-smi>len</span>} bytes to {<span class=pl-smi>clientCount</span>} clients<span class=pl-pds>"</span></span>);
    }
}</pre></div>
<p>This works much like the client, except any input other than <code>"q"</code> is <em>broadcast</em> to all the clients.</p>
<h2><a id=user-content-now-race-your-horses class=anchor aria-hidden=true href=#now-race-your-horses><svg class="octicon octicon-link" viewBox="0 0 16 16" version=1.1 width=16 height=16 aria-hidden=true><path fill-rule=evenodd d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Now race your horses</h2>
<p>We're not just doing this for fun! The key obective of things like pipelines and the array-pool is that it makes it <strong>much</strong> simpler to write IO code that makes efficient use of memory; reducing allocations (and <em>especially</em> reducing large object allocations) <em>signficantly</em> reduces garbage collection overhead, allowing our code to be much more scalable (useful for both servers, and high-throughput client scenarios). Our use of <code>async</code>/<code>await</code> makes it <strong>much</strong> simpler to make effective use of the CPU: instead of blocking for a while, we can make the thread available to do other <em>useful work</em> - increasing throughput, and once again: reducing memory usage (having lots of threads is <em>not</em> cheap - each thread has a quite significant stack space reserved for it).</p>
<p>Note that this isn't entirely free; fetching arrays from the pool (and remembering to return them) <em>by itself</em> has some overhead - but the general expectation is that the cost of checking the pool is, <em>overall</em>, lower than the cost associated from constant allocations and collections. Similarly, <code>async</code>: the hope is that the increased scalability afforded by freeing up threads more-than-offsets the cost of the additional work required by the plumbing involved.</p>
<p>But: there's only one way to find out. <a href=https://ericlippert.com/2012/12/17/performance-rant/ rel=nofollow>As Eric Lippert puts it</a>:</p>
<blockquote>
<p>If you have two horses and you want to know which of the two is the faster then <strong>race your horses</strong></p>
</blockquote>
<p>Setting up a good race-track for code can be awkward, because we need to try to reproduce a <em>meaningful scenario</em>. And it is <em>amazingly</em> easy to write bad performnce tests. Rather than reinvent bad code, it is <em>hugely</em> adviseable to lean on tools like <a href=https://benchmarkdotnet.org/ rel=nofollow><code>BenchmarkDotNet</code></a>. If you are <em>even remotely</em> performance minded, and you haven't used <code>BenchmarkDotNet</code>: sorry, but <em>you're doing it wrong</em>.</p>
<p>There are 4 combinations we can check here:</p>
<ul>
<li><code>SimplSocketClient</code> against <code>SimplSocketServer</code></li>
<li><code>SimplSocketClient</code> against <code>SimplPipelineServer</code></li>
<li><code>SimplPipelineClient</code> against <code>SimplSocketServer</code></li>
<li><code>SimplPipelineClient</code> against <code>SimplPipelineServer</code></li>
</ul>
<p>I won't list all of these, but for these tests I'll use a <code>[GlobalSetup]</code> method (a <code>BenchmarkDotNet</code> concept) to spin up both servers (on different ports), then we can test clients against each. Here's our "<code>SimplSocketClient</code> against <code>SimplSocketServer</code>" test (remembering that <code>SimplSocketClient</code> is synchronous):</p>
<div class="highlight highlight-source-cs"><pre>[<span class=pl-en>Benchmark</span>(<span class=pl-en>OperationsPerInvoke</span> <span class=pl-k>=</span> <span class=pl-smi>Ops</span>)]
<span class=pl-k>public</span> <span class=pl-k>long</span> <span class=pl-en>c1_s1</span>()
{
    <span class=pl-k>long</span> <span class=pl-smi>x</span> <span class=pl-k>=</span> <span class=pl-c1>0</span>;
    <span class=pl-k>using</span> (<span class=pl-k>var</span> <span class=pl-smi>client</span> <span class=pl-k>=</span> <span class=pl-k>new</span> <span class=pl-en>SimplSocketClient</span>(<span class=pl-smi>CreateSocket</span>))
    {
        <span class=pl-smi>client</span>.<span class=pl-en>Connect</span>(<span class=pl-smi>s1</span>);
        <span class=pl-k>for</span> (<span class=pl-k>int</span> <span class=pl-smi>i</span> <span class=pl-k>=</span> <span class=pl-c1>0</span>; <span class=pl-smi>i</span> <span class=pl-k>&lt;</span> <span class=pl-smi>Ops</span>; <span class=pl-smi>i</span><span class=pl-k>++</span>)
        {
            <span class=pl-k>var</span> <span class=pl-smi>response</span> <span class=pl-k>=</span> <span class=pl-smi>client</span>.<span class=pl-en>SendReceive</span>(<span class=pl-smi>_data</span>);
            <span class=pl-smi>x</span> <span class=pl-k>+=</span> <span class=pl-smi>response</span>.<span class=pl-smi>Length</span>;
        }
    }
    <span class=pl-k>return</span> <span class=pl-en>AssertResult</span>(<span class=pl-smi>x</span>);
}</pre></div>
<p>and here's our "<code>SimplPipelineClient</code> against <code>SimplPipelineServer</code>" test (using a <code>Task</code> this time, as <code>SimplPipelineClient</code> uses an <code>async</code> API):</p>
<div class="highlight highlight-source-cs"><pre>[<span class=pl-en>Benchmark</span>(<span class=pl-en>OperationsPerInvoke</span> <span class=pl-k>=</span> <span class=pl-smi>Ops</span>)]
<span class=pl-k>public</span> <span class=pl-k>async</span> <span class=pl-en>Task</span>&lt;<span class=pl-k>long</span>&gt; <span class=pl-en>c2_s2</span>()
{
    <span class=pl-k>long</span> <span class=pl-smi>x</span> <span class=pl-k>=</span> <span class=pl-c1>0</span>;
    <span class=pl-k>using</span> (<span class=pl-k>var</span> <span class=pl-smi>client</span> <span class=pl-k>=</span>
        <span class=pl-k>await</span> <span class=pl-smi>SimplPipelineClient</span>.<span class=pl-en>ConnectAsync</span>(<span class=pl-smi>s2</span>))
    {
        <span class=pl-k>for</span> (<span class=pl-k>int</span> <span class=pl-smi>i</span> <span class=pl-k>=</span> <span class=pl-c1>0</span>; <span class=pl-smi>i</span> <span class=pl-k>&lt;</span> <span class=pl-smi>Ops</span>; <span class=pl-smi>i</span><span class=pl-k>++</span>)
        {
            <span class=pl-k>using</span> (<span class=pl-k>var</span> <span class=pl-smi>response</span> <span class=pl-k>=</span>
                <span class=pl-k>await</span> <span class=pl-smi>client</span>.<span class=pl-en>SendReceiveAsync</span>(<span class=pl-smi>_data</span>))
            {
                <span class=pl-smi>x</span> <span class=pl-k>+=</span> <span class=pl-smi>response</span>.<span class=pl-smi>Memory</span>.<span class=pl-smi>Length</span>;
            }
        }
    }
    <span class=pl-k>return</span> <span class=pl-en>AssertResult</span>(<span class=pl-smi>x</span>);
}</pre></div>
<p>Note that we're performing multiple operations (<code>Ops</code>) per run here, so we're not just measing overheads like connect. Other than that, we'll just let <code>BenchmarkDotNet</code> do the hard work. We run our tests, and we get (after some time; benchmarking isn't always fast, although you can make suggestions on the iterations etc to speed it up if you want):</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Runtime</th>
<th align=right>Mean</th>
<th align=right>Error</th>
<th align=right>StdDev</th>
<th align=right>Gen 0</th>
<th align=right>Gen 1</th>
</tr>
</thead>
<tbody>
<tr>
<td>c1_s1</td>
<td>Clr</td>
<td align=right>NA</td>
<td align=right>NA</td>
<td align=right>NA</td>
<td align=right>N/A</td>
<td align=right>N/A</td>
</tr>
<tr>
<td>c1_s2</td>
<td>Clr</td>
<td align=right>NA</td>
<td align=right>NA</td>
<td align=right>NA</td>
<td align=right>N/A</td>
<td align=right>N/A</td>
</tr>
<tr>
<td>c2_s1</td>
<td>Clr</td>
<td align=right>NA</td>
<td align=right>NA</td>
<td align=right>NA</td>
<td align=right>N/A</td>
<td align=right>N/A</td>
</tr>
<tr>
<td>c2_s2</td>
<td>Clr</td>
<td align=right>45.99us</td>
<td align=right>0.4275us</td>
<td align=right>0.2544us</td>
<td align=right>0.3636</td>
<td align=right>0.0909</td>
</tr>
<tr>
<td>c1_s1</td>
<td>Core</td>
<td align=right>NA</td>
<td align=right>NA</td>
<td align=right>NA</td>
<td align=right>N/A</td>
<td align=right>N/A</td>
</tr>
<tr>
<td>c1_s2</td>
<td>Core</td>
<td align=right>NA</td>
<td align=right>NA</td>
<td align=right>NA</td>
<td align=right>N/A</td>
<td align=right>N/A</td>
</tr>
<tr>
<td>c2_s1</td>
<td>Core</td>
<td align=right>NA</td>
<td align=right>NA</td>
<td align=right>NA</td>
<td align=right>N/A</td>
<td align=right>N/A</td>
</tr>
<tr>
<td>c2_s2</td>
<td>Core</td>
<td align=right>29.87us</td>
<td align=right>0.2294us</td>
<td align=right>0.1518us</td>
<td align=right>0.1250</td>
<td align=right>-</td>
</table>
<p>Now, you're probaly looking at that table and thinking "huh? most of the data is missing - how can interpret that?" - and: you wouldn't be wrong! It turns out that the <code>c1</code> (<code>SimplSocketClient</code>) and <code>s1</code> (<code>SimplSocketServer</code>) implementations are <em>simply unreliable</em>. Ultimately, it was <strong>painfully hard</strong> to write reliable socket code before pipelines, and it looks like the legacy implementation simply has bugs and race conditions that <em>don't show up in casual usage</em> (it works fine in the REPL client), but which manifest pretty quickly when <code>BenchmarkDotNet</code> runs it <em>aggressively</em>. Our "pipelines" implementation simply used the "obvious" thing, and <em>it works reliably first time</em>. All of the complex pieces that IO authors previously had to worry about have now moved to the framework code, which enables programmers to focus on the interesting thing <em>that they're trying to do</em> (rather than spending most of their time fighting with IO intrinsics), <em>and</em> benefit from a reliable well-tested implementation of the ugly IO code.</p>
<blockquote>
<p>A major advantage of moving to pipelines is getting rid of the gnarly IO bugs that <em>you didn't even know you had</em>.</p>
</blockquote>
<p>I will be more than happy to update this table with updated numbers if <code>SimplSockets</code> can find the things that are stalling it.</p>
<p>Of the numbers that we <em>do</em> have, we can see that it behaves <em>well</em> on <code>Clr</code> (.NET Framework) but works <em>much better</em> on <code>Core</code> (.NET Core). .NET Core 2.1 is frankly <em>amazing</em> (and 3.0 looks even better) - with <em>lots</em> of advantages. If you're serious about performance, migrating to .NET Core should definitely be on your roadmap.</p>
<h2><a id=user-content-summary class=anchor aria-hidden=true href=#summary><svg class="octicon octicon-link" viewBox="0 0 16 16" version=1.1 width=16 height=16 aria-hidden=true><path fill-rule=evenodd d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Summary</h2>
<p>This has been a long read, but I hope I've conveyed some useful practical advice and tips for working with pipelines in real systems, in a way that is directly translatable to your <em>own</em> requirements. If you want to play with the code in more depth, or see it in action, you can <a href=https://github.com/mgravell/simplsockets/>see my fork here</a>.</p>
<p>Update: please also see <a href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-31.html>part 3.1</a> for further clarifications on this post</p>
<p>Enjoy!</p>
<div style=clear:both></div>
</div>
<div class=post-footer>
<div class="post-footer-line post-footer-line-1"><span class="post-author vcard">
Posted by
<span class=fn itemprop=author itemscope itemtype=http://schema.org/Person>
<a class=g-profile href=https://www.blogger.com/profile/01023334706549710089 rel=author title="author profile">
<span itemprop=name>Marc Gravell</span>
</a>
</span>
</span>
<span class=post-timestamp>
at
<a class=timestamp-link href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-3.html rel=bookmark title="permanent link"><abbr class=published itemprop=datePublished title=2018-07-29T07:23:00-07:00>07:23</abbr></a>
</span>
<span class=post-comment-link>
</span>
<span class=post-icons>
<span class="item-control blog-admin pid-1042145909 sf-hidden">
</span>
</span>
<span class="post-backlinks post-comment-link">
</span>
</div>
<div class="post-footer-line post-footer-line-2"><span class=post-labels>
Labels:
<a href=https://blog.marcgravell.com/search/label/pipelines rel=tag>pipelines</a>
</span>
</div>
<div class="post-footer-line post-footer-line-3"></div>
</div>
</div>
<div class=comments id=comments>
<a name=comments></a>
</div>
</div>
<div class="inline-ad sf-hidden">
</div>
 </div></div>
 
</div>
<div class=blog-pager id=blog-pager>
<span id=blog-pager-newer-link>
<a class=blog-pager-newer-link href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-31.html id=Blog1_blog-pager-newer-link title="Newer Post">Newer Post</a>
</span>
<span id=blog-pager-older-link>
<a class=blog-pager-older-link href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-2.html id=Blog1_blog-pager-older-link title="Older Post">Older Post</a>
</span>
<a class=home-link href=https://blog.marcgravell.com/>Home</a>
</div>
<div class=clear></div>
<div class=post-feeds>
</div>
</div></div>
</div>
</div>
<div class=column-left-outer>
<div class=column-left-inner>
<aside>
</aside>
</div>
</div>
<div class=column-right-outer>
<div class=column-right-inner>
<aside>
<div class="sidebar section" id=sidebar-right-1><div class="widget AdSense sf-hidden" data-version=1 id=AdSense1>
<div class="widget-content sf-hidden">
</div>
</div><div class="widget Image" data-version=1 id=Image2>
<h2>Stack Overflow</h2>
<div class=widget-content>
<a href=https://stackoverflow.com/users/23354/marc-gravell>
<img alt="Stack Overflow" height=58 id=Image2_img src="data:image/png;base64,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" width=208>
</a>
<br>
</div>
<div class=clear></div>
</div><div class="widget Text" data-version=1 id=Text1>
<div class=widget-content>
@marcgravell
</div>
<div class=clear></div>
</div><div class="widget Subscribe" data-version=1 id=Subscribe1>
<div style=white-space:nowrap>
<h2 class=title>Subscribe</h2>
<div class=widget-content>
<div class="subscribe-wrapper subscribe-type-POST">
<div class="subscribe expanded subscribe-type-POST" id=SW_READER_LIST_Subscribe1POST style=display:none>
</div>
<div class=subscribe id=SW_READER_LIST_CLOSED_Subscribe1POST>
<div class=top>
<span class=inner>
<img class=subscribe-dropdown-arrow src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="13" height="10"><rect fill-opacity="0"/></svg>' style="background-blend-mode:normal!important;background-clip:content-box!important;background-position:50% 50%!important;background-color:rgba(0,0,0,0)!important;background-image:var(--sf-img-7)!important;background-size:100% 100%!important;background-origin:content-box!important;background-repeat:no-repeat!important">
<span>
<img align=absmiddle alt border=0 class=feed-icon src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12"><rect fill-opacity="0"/></svg>' style="background-blend-mode:normal!important;background-clip:content-box!important;background-position:50% 50%!important;background-color:rgba(0,0,0,0)!important;background-image:var(--sf-img-8)!important;background-size:100% 100%!important;background-origin:content-box!important;background-repeat:no-repeat!important">
Posts
</span>
</span>
</div>
<div class=bottom></div>
</div>
</div>
<div class="subscribe-wrapper subscribe-type-PER_POST">
<div class="subscribe expanded subscribe-type-PER_POST" id=SW_READER_LIST_Subscribe1PER_POST style=display:none>
</div>
<div class=subscribe id=SW_READER_LIST_CLOSED_Subscribe1PER_POST>
<div class=top>
<span class=inner>
<img class=subscribe-dropdown-arrow src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="13" height="10"><rect fill-opacity="0"/></svg>' style="background-blend-mode:normal!important;background-clip:content-box!important;background-position:50% 50%!important;background-color:rgba(0,0,0,0)!important;background-image:var(--sf-img-7)!important;background-size:100% 100%!important;background-origin:content-box!important;background-repeat:no-repeat!important">
<span>
<img align=absmiddle alt border=0 class=feed-icon src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12"><rect fill-opacity="0"/></svg>' style="background-blend-mode:normal!important;background-clip:content-box!important;background-position:50% 50%!important;background-color:rgba(0,0,0,0)!important;background-image:var(--sf-img-8)!important;background-size:100% 100%!important;background-origin:content-box!important;background-repeat:no-repeat!important">
Comments
</span>
</span>
</div>
<div class=bottom></div>
</div>
</div>
<div style=clear:both></div>
</div>
</div>
<div class=clear></div>
</div><div class="widget BlogArchive" data-version=1 id=BlogArchive1>
<h2>Blog Archive</h2>
<div class=widget-content>
<div id=ArchiveList>
<div id=BlogArchive1_ArchiveList>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2022/>
2022
</a>
<span class=post-count dir=ltr>(2)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2021/>
2021
</a>
<span class=post-count dir=ltr>(1)</span>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2020/>
2020
</a>
<span class=post-count dir=ltr>(4)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2019/>
2019
</a>
<span class=post-count dir=ltr>(2)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate expanded">
<a class=toggle>
<span class="zippy toggle-open">
 ▼&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2018/>
2018
</a>
<span class=post-count dir=ltr>(11)</span>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2018/12/>
December
</a>
<span class=post-count dir=ltr>(1)</span>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2018/09/>
September
</a>
<span class=post-count dir=ltr>(1)</span>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2018/08/>
August
</a>
<span class=post-count dir=ltr>(1)</span>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate expanded">
<a class=toggle>
<span class="zippy toggle-open">
 ▼&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2018/07/>
July
</a>
<span class=post-count dir=ltr>(4)</span>
<ul class=posts>
<li><a href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-31.html>Pipe Dreams, part 3.1</a></li>
<li><a href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-3.html>Pipe Dreams, part 3</a></li>
<li><a href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-2.html>Pipe Dreams, part 2</a></li>
<li><a href=https://blog.marcgravell.com/2018/07/pipe-dreams-part-1.html>Pipe Dreams, part 1</a></li>
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2018/04/>
April
</a>
<span class=post-count dir=ltr>(1)</span>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2018/01/>
January
</a>
<span class=post-count dir=ltr>(3)</span>
</li>
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2017/>
2017
</a>
<span class=post-count dir=ltr>(7)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2016/>
2016
</a>
<span class=post-count dir=ltr>(5)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2015/>
2015
</a>
<span class=post-count dir=ltr>(4)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2014/>
2014
</a>
<span class=post-count dir=ltr>(16)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2013/>
2013
</a>
<span class=post-count dir=ltr>(4)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2012/>
2012
</a>
<span class=post-count dir=ltr>(9)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2011/>
2011
</a>
<span class=post-count dir=ltr>(14)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2010/>
2010
</a>
<span class=post-count dir=ltr>(24)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2009/>
2009
</a>
<span class=post-count dir=ltr>(57)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
<ul class=hierarchy>
<li class="archivedate collapsed">
<a class=toggle>
<span class=zippy>
 ►&nbsp;
 
</span>
</a>
<a class=post-count-link href=https://blog.marcgravell.com/2008/>
2008
</a>
<span class=post-count dir=ltr>(16)</span>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
<ul class="hierarchy sf-hidden">
</ul>
</li>
</ul>
</div>
</div>
<div class=clear></div>
</div>
</div></div>
<table border=0 cellpadding=0 cellspacing=0 class="section-columns columns-2">
<tbody>
<tr>
<td class="first columns-cell">
<div class="sidebar section" id=sidebar-right-2-1><div class="widget Profile" data-version=1 id=Profile1>
<h2>About Me</h2>
<div class=widget-content>
<a href=https://www.blogger.com/profile/01023334706549710089><img alt="My photo" class=profile-img height=80 src="data:image/jpeg;base64,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" width=80></a>
<dl class=profile-datablock>
<dt class=profile-data>
<a class="profile-name-link g-profile" href=https://www.blogger.com/profile/01023334706549710089 rel=author style=background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA3klEQVQ4y2P4l8YUCsT/ycT6DBRoBmNMA5IZ/v+LB+IYKI5lgIgRZUACUOH2jv//3j/5/+//fwj+8/P/vyNz/v8rliRgQDJUM0jTv39oGCh2ceP/f0kMeAwAORtkM0gDyJBzqyEYZiCILpXCYwDIvzDF1/YAFUtCMIgNM2BVyf9/hWJEGPD3LyIMQGx0sRgGEgxAN4goA2BeqJCDYHSvYDUAWyCCQh6EkQPz08v//+IYSI3GfwiD58cTSEggBSBb0MMAJAaSS2AgkJRBOA4pKcNwHAOReYGMzKRPgQEGAIvy2M2lOZIeAAAAAElFTkSuQmCC)>
Marc Gravell
</a>
</dt>
</dl>
<a class=profile-link href=https://www.blogger.com/profile/01023334706549710089 rel=author>View my complete profile</a>
<div class=clear></div>
</div>
</div></div>
</td>
<td class=columns-cell>
<div class="sidebar no-items section" id=sidebar-right-2-2></div>
</td>
</tr>
</tbody>
</table>
<div class="sidebar section" id=sidebar-right-3><div class="widget Label" data-version=1 id=Label1>
<h2>Labels</h2>
<div class="widget-content list-label-widget-content">
<ul>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/c%23>c#</a>
<span dir=ltr>(48)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/protobuf-net>protobuf-net</a>
<span dir=ltr>(30)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/.net>.net</a>
<span dir=ltr>(17)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/4.0>4.0</a>
<span dir=ltr>(17)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/serialization>serialization</a>
<span dir=ltr>(15)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/linq>linq</a>
<span dir=ltr>(12)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/expression>expression</a>
<span dir=ltr>(10)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/me>me</a>
<span dir=ltr>(10)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/community>community</a>
<span dir=ltr>(8)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/redis>redis</a>
<span dir=ltr>(7)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/reflection>reflection</a>
<span dir=ltr>(6)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/cf>cf</a>
<span dir=ltr>(5)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/ide>ide</a>
<span dir=ltr>(5)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/metaprogramming>metaprogramming</a>
<span dir=ltr>(5)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/pipelines>pipelines</a>
<span dir=ltr>(5)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/dynamic>dynamic</a>
<span dir=ltr>(3)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/generics>generics</a>
<span dir=ltr>(3)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/mvc>mvc</a>
<span dir=ltr>(3)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/5.0>5.0</a>
<span dir=ltr>(2)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/asp.net>asp.net</a>
<span dir=ltr>(2)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/async>async</a>
<span dir=ltr>(2)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/disposable>disposable</a>
<span dir=ltr>(2)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/phone-7>phone-7</a>
<span dir=ltr>(2)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/stackexchange>stackexchange</a>
<span dir=ltr>(2)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/stackoverflow>stackoverflow</a>
<span dir=ltr>(2)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/surface>surface</a>
<span dir=ltr>(2)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/autism>autism</a>
<span dir=ltr>(1)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/c%23%20.net%205.0%20async%20redis>c# .net 5.0 async redis</a>
<span dir=ltr>(1)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/c%23%20linq>c# linq</a>
<span dir=ltr>(1)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/c%23%20profiling>c# profiling</a>
<span dir=ltr>(1)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/ikvm>ikvm</a>
<span dir=ltr>(1)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/immutability>immutability</a>
<span dir=ltr>(1)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/linq%20expression%20c%23>linq expression c#</a>
<span dir=ltr>(1)</span>
</li>
<li>
<a dir=ltr href=https://blog.marcgravell.com/search/label/tpl>tpl</a>
<span dir=ltr>(1)</span>
</li>
</ul>
<div class=clear></div>
</div>
</div></div>
</aside>
</div>
</div>
</div>
<div style=clear:both></div>
</div>
</div>
</div>
<div class="main-cap-bottom cap-bottom">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
<footer>
<div class=footer-outer>
<div class="footer-cap-top cap-top">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
<div class="fauxborder-left footer-fauxborder-left">
<div class="fauxborder-right footer-fauxborder-right"></div>
<div class="region-inner footer-inner">
<div class="foot no-items section" id=footer-1></div>
<table border=0 cellpadding=0 cellspacing=0 class="section-columns columns-2">
<tbody>
<tr>
<td class="first columns-cell">
<div class="foot no-items section" id=footer-2-1></div>
</td>
<td class=columns-cell>
<div class="foot no-items section" id=footer-2-2></div>
</td>
</tr>
</tbody>
</table>
<div class="foot section" id=footer-3><div class="widget Attribution" data-version=1 id=Attribution1>
<div class=widget-content style=text-align:center>
Simple theme. Powered by <a href=https://www.blogger.com/ target=_blank>Blogger</a>.
</div>
<div class=clear></div>
</div></div>
</div>
</div>
<div class="footer-cap-bottom cap-bottom">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
</footer>
</div>
</div>
<div class="content-cap-bottom cap-bottom">
<div class=cap-left></div>
<div class=cap-right></div>
</div>
</div>
</div>
